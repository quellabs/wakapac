!function(){"use strict";function t(){}function e(){this.units=new Map,this.hierarchyCache=new WeakMap}function n(e){return t.isEventType(e)}function i(){return t.createRandomId()}function r(e,n,i){return i=i||"",t.shouldBeReactive(e)?t.SUPPORTS_PROXY?function(e,n,i){for(const a in e)if(e.hasOwnProperty(a)&&t.shouldBeReactive(e[a])){const t=i?i+"."+a:a;e[a]=r(e[a],n,t)}const a=Array.isArray(e),o={};if(a){["push","pop","shift","unshift","splice","sort","reverse"].forEach((t=>{o[t]=e[t]}))}return new Proxy(e,{get:(e,s)=>a&&o.hasOwnProperty(s)?function(...a){e.length;const c=o[s].apply(e,a);if("push"===s||"unshift"===s||"splice"===s)for(let a=0;a<e.length;a++)if(t.shouldBeReactive(e[a])&&!e[a]._isReactive){const t=i?i+"."+a:a.toString();e[a]=r(e[a],n,t)}return n(i||"root",e,"array-mutation",{method:s,args:a}),c}:e[s],set(e,a,o){const s=e[a];if(t.shouldBeReactive(o)){const t=i?i+"."+a:a.toString();o=r(o,n,t)}if(e[a]=o,!t.deepEqual(s,o)){const t=i?i+"."+a:a.toString();n(t,o,"property-set",{oldValue:s})}return!0},deleteProperty(t,e){const r=t[e];delete t[e];const a=i?i+"."+e:e.toString();return n(a,void 0,"property-delete",{oldValue:r}),!0}})}(e,n,i):function(e,n,i){const a=Array.isArray(e);if(a){["push","pop","shift","unshift","splice","sort","reverse"].forEach((a=>{const o=e[a];Object.defineProperty(e,a,{value:function(...e){const s=o.apply(this,e);if("push"===a||"unshift"===a||"splice"===a)for(let e=0;e<this.length;e++)if(t.shouldBeReactive(this[e])&&!this[e]._isReactive){const t=i?i+"."+e:e.toString();this[e]=r(this[e],n,t)}return n(i||"root",this,"array-mutation",{method:a,args:e}),s},enumerable:!1,configurable:!0})}))}for(const a in e)if(e.hasOwnProperty(a)){const o=e[a];if(t.shouldBeReactive(o)){const t=i?i+"."+a:a;e[a]=r(o,n,t)}}return Object.defineProperty(e,"_isReactive",{value:!0,enumerable:!1,configurable:!1}),e}(e,n,i):e}function a(e,a,o){let s;a=a||{},o=o||{};const c=document.querySelector(e);if(!c)throw new Error("Container not found for selector: "+e);const d={updateMode:"immediate",delay:300,deepReactivity:!0};for(s in o)o.hasOwnProperty(s)&&(d[s]=o[s]);const u={bindings:new Map,container:c,abstraction:null,delayedUpdates:new Map,parent:null,children:new Set,eventListeners:new Map,pendingDOMUpdates:null,pendingUpdates:null,originalAbstraction:a,config:d,computedCache:new Map,computedDependencies:new Map,propertyDependents:new Map,reactiveProxies:new WeakMap,handleDeepChange:function(t,e,n,i){const r=t.split(".")[0];this.updateComputedProperties(r),this.abstraction.hasOwnProperty(r)&&this.updateDOM(r,this.abstraction[r]),this.notifyParent("propertyChange",{property:r,path:t,newValue:e,changeType:n,meta:i})},updateDOM:function(t,e){const n=this;this.pendingDOMUpdates||(this.pendingDOMUpdates=new Set,this.pendingUpdates={},window.requestAnimationFrame?requestAnimationFrame((function(){n.flushDOMUpdates()})):setTimeout((function(){n.flushDOMUpdates()}),0)),this.pendingDOMUpdates.add(t),this.pendingUpdates[t]=e},flushDOMUpdates:function(){if(!this.pendingDOMUpdates)return;const t=this;this.pendingDOMUpdates.forEach((function(e){const n=t.pendingUpdates[e];t.bindings.forEach((function(i){if(i.property===e)switch(i.type){case"text":t.updateTextBinding(i,e,n);break;case"attribute":i.element.setAttribute(i.attribute,n);break;case"input":i.element.value!==n&&(i.element.value=n);break;case"visible":t.updateVisibilityBinding(i,n)}}))})),this.pendingDOMUpdates=null,this.pendingUpdates=null},updateVisibilityBinding:function(t,e){const n=t.element;if(this.evaluateVisibilityCondition(t.condition,e)){if(n.hasAttribute("data-pac-hidden")){const t=n.getAttribute("data-pac-original-display");n.style.display=t||"",n.removeAttribute("data-pac-hidden"),n.removeAttribute("data-pac-original-display")}}else if(!n.hasAttribute("data-pac-hidden")){const t=window.getComputedStyle(n).display;"none"!==t&&n.setAttribute("data-pac-original-display",t),n.style.display="none",n.setAttribute("data-pac-hidden","true")}},evaluateVisibilityCondition:function(t,e){return t.startsWith("!")?!e:!!e},updateTextBinding:function(t,e,n){const i=new RegExp("\\{\\{\\s*"+e+"\\s*\\}\\}","g");let r=n;"object"==typeof n&&null!==n?r=Array.isArray(n)?"["+n.length+" items]":JSON.stringify(n,null,2):null==n&&(r="");const a=t.originalText.replace(i,r);t.textNode?t.textNode.textContent=a:t.element.textContent=a},analyzeComputedDependencies:function(t){const e=[],n=t.toString(),i=/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g;let r;for(;null!==(r=i.exec(n));){const t=r[1];this.originalAbstraction.hasOwnProperty(t)&&-1===e.indexOf(t)&&e.push(t)}return e},analyzeVisibilityCondition:function(t){return t.startsWith("!")?t.substring(1):t},updateComputedProperties:function(e){const n=this;(this.propertyDependents.get(e)||[]).forEach((function(e){const i=n.computedCache.get(e),r=n.originalAbstraction.computed[e].call(n.abstraction);t.deepEqual(i,r)||(n.computedCache.set(e,r),n.updateDOM(e,r),n.notifyParent("propertyChange",{property:e,oldValue:i,newValue:r,computed:!0}),n.updateComputedProperties(e))}))},createReactiveAbstraction:function(){const t={},e=this;if(this.originalAbstraction.computed)for(const n in this.originalAbstraction.computed)if(this.originalAbstraction.computed.hasOwnProperty(n)){const i=this.originalAbstraction.computed[n];if("function"==typeof i){const r=this.analyzeComputedDependencies(i);this.computedDependencies.set(n,r),r.forEach((function(t){e.propertyDependents.has(t)||e.propertyDependents.set(t,[]),e.propertyDependents.get(t).push(n)})),Object.defineProperty(t,n,{get:function(){if(e.computedCache.has(n))return e.computedCache.get(n);const r=i.call(t);return e.computedCache.set(n,r),r},enumerable:!0,configurable:!0})}}for(const e in this.originalAbstraction)if(this.originalAbstraction.hasOwnProperty(e)&&"computed"!==e){const n=this.originalAbstraction[e];"function"==typeof n?t[e]=n.bind(t):this.createReactiveProperty(t,e,n)}return t.notifyParent=function(t,n){e.notifyParent(t,n)},t.sendToChildren=function(t,n){e.sendToChildren(t,n)},t.sendToChild=function(t,n,i){e.sendToChild(t,n,i)},t.broadcastDataUpdate=function(t,n){e.broadcastDataUpdate(t,n)},t.syncDataToChildren=function(t){e.syncDataToChildren(t)},t.findChild=function(t){return e.findChild(t)},t.findChildren=function(t){return e.findChildren(t)},t.findChildBySelector=function(t){return e.findChildBySelector(t)},t.findChildByProperty=function(t,n){return e.findChildByProperty(t,n)},t},createReactiveProperty:function(e,n,i){let a=i;const o=this;this.config.deepReactivity&&t.shouldBeReactive(a)&&(a=r(a,(function(t,e,n,i){o.handleDeepChange(t,e,n,i)}),n)),Object.defineProperty(e,n,{get:function(){return a},set:function(e){if(!t.deepEqual(a,e)){const i=a;o.config.deepReactivity&&t.shouldBeReactive(e)&&(e=r(e,(function(t,e,n,i){o.handleDeepChange(t,e,n,i)}),n)),a=e,o.updateDOM(n,e),o.updateComputedProperties(n),o.notifyParent("propertyChange",{property:n,oldValue:i,newValue:e})}},enumerable:!0,configurable:!0})},sendToChildren:function(t,e){this.children.forEach((function(n){"function"==typeof n.receiveFromParent&&n.receiveFromParent(t,e)}))},sendToChild:function(t,e,n){const i=this.findChildBySelector(t);i&&"function"==typeof i.receiveFromParent&&i.receiveFromParent(e,n)},broadcastDataUpdate:function(t,e){this.children.forEach((function(n){n.abstraction&&n.abstraction.hasOwnProperty(t)&&(n.abstraction[t]=e)}))},syncDataToChildren:function(t){for(const e in t)if(t.hasOwnProperty(e)){const n=t[e];this.findChildrenBySelector(e).forEach((function(t){if(t.abstraction)for(const e in n)n.hasOwnProperty(e)&&(t.abstraction[e]=n[e])}))}},findChild:function(t){return Array.from(this.children).find(t)},findChildren:function(t){return Array.from(this.children).filter(t)},findChildBySelector:function(t){return this.findChild((function(e){return e.container.matches(t)}))},findChildrenBySelector:function(t){return this.findChildren((function(e){return e.container.matches(t)}))},findChildByProperty:function(t,e){return this.findChild((function(n){return n.abstraction&&n.abstraction[t]===e}))},receiveFromParent:function(t,e){this.abstraction.receiveFromParent&&"function"==typeof this.abstraction.receiveFromParent&&this.abstraction.receiveFromParent(t,e);const n=new CustomEvent("pac:parentcommand",{detail:{command:t,data:e},bubbles:!0});this.container.dispatchEvent(n)},makeServerRequest:function(t,e){const n=this;return e=e||{},fetch(t,{method:e.method||"GET",headers:Object.assign({"Content-Type":"application/json","X-PAC-Request":"true","X-PAC-Version":"1.0","X-PAC-Component":this.container.id||"anonymous"},e.headers||{}),body:e.data?JSON.stringify(e.data):void 0}).then((t=>t.json())).then((t=>{if(e.updateProperties)for(const e in t)n.abstraction.hasOwnProperty(e)&&(n.abstraction[e]=t[e]);return e.onSuccess&&e.onSuccess.call(n.abstraction,t),t})).catch((t=>{throw e.onError&&e.onError.call(n.abstraction,t),t}))},setupBindings:function(){this.findTextBindings(),this.findAttributeBindings()},findTextBindings:function(){let t;const e=document.createTreeWalker(this.container,NodeFilter.SHOW_TEXT,null,!1),n=[];let r;for(;r=e.nextNode();){const e=r.textContent,a=e.match(/\{\{\s*(\w+)\s*\}\}/g);if(a){const o=r.parentElement;for(t=0;t<a.length;t++){const s=a[t].replace(/[{}\s]/g,""),c=s+"_text_"+i();n.push({key:c,binding:{type:"text",property:s,element:o,originalText:e,textNode:r}})}}}for(t=0;t<n.length;t++)this.bindings.set(n[t].key,n[t].binding)},findAttributeBindings:function(){let t;const e=this.container.querySelectorAll("[data-pac-bind]"),r=[];for(t=0;t<e.length;t++){const a=e[t],o=a.getAttribute("data-pac-bind").split(",");for(let t=0;t<o.length;t++){const e=o[t].trim(),s=e+"_"+i();if(-1!==e.indexOf(":")){const t=e.split(":"),i=t[0].trim(),o=t[1].trim();n(i)?r.push({key:s,binding:{type:"event",event:i,method:o,element:a}}):"visible"===i?r.push({key:s,binding:{type:"visible",property:o,element:a,condition:o}}):r.push({key:s,binding:{type:"attribute",property:o,element:a,attribute:i}})}else{const t=e.trim();this.setupInputElement(a,t),r.push({key:s,binding:{type:"input",property:t,element:a,updateMode:a.getAttribute("data-pac-update-mode")||this.config.updateMode,delay:parseInt(a.getAttribute("data-pac-update-delay"))||this.config.delay}})}}}for(t=0;t<r.length;t++){const e=r[t];if(this.bindings.set(e.key,e.binding),"visible"===e.binding.type){const t=this.analyzeVisibilityCondition(e.binding.condition);e.binding.property=t}}},setupInputElement:function(t,e){const n=t.getAttribute("data-pac-update")||this.config.updateMode,i=parseInt(t.getAttribute("data-pac-delay"))||this.config.delay;t.setAttribute("data-pac-property",e),t.setAttribute("data-pac-update-mode",n),t.setAttribute("data-pac-update-delay",i.toString())},setupEventHandlers:function(){const t=["input","change","click","submit","focus","blur","keyup","keydown"];for(let e=0;e<t.length;e++){const n=t[e],i=this.createEventHandler(n);this.container.addEventListener(n,i),this.eventListeners.set(n,i)}},createEventHandler:function(t){const e=this;return function(n){"input"===t?e.handleInput(n):"change"===t?e.handleChange(n):e.handleEvent(n)}},handleInput:function(t){const e=t.target.getAttribute("data-pac-property");if(!e||!this.abstraction.hasOwnProperty(e))return;const n=t.target.getAttribute("data-pac-update-mode")||this.config.updateMode;"change"===n?t.target.setAttribute("data-pac-pending-value",t.target.value):"immediate"===n?this.abstraction[e]=t.target.value:"delayed"===n&&this.updatePropertyFromDOM(t.target,e,t.target.value,!1)},handleChange:function(t){const e=t.target.getAttribute("data-pac-property");if(!e||!this.abstraction.hasOwnProperty(e))return;const n=e+"_"+t.target.getAttribute("data-pac-property");this.delayedUpdates.has(n)&&(clearTimeout(this.delayedUpdates.get(n)),this.delayedUpdates.delete(n)),this.abstraction[e]=t.target.value,t.target.removeAttribute("data-pac-pending-value")},handleEvent:function(t){const e=t.type;let n=!1;const i=this;if(this.bindings.forEach((function(r){if("event"===r.type&&r.event===e&&r.element===t.target){const a=i.abstraction[r.method];"function"==typeof a&&("submit"===e&&t.preventDefault(),a.call(i.abstraction,t),n=!0)}})),!n){const n=t.target.getAttribute("data-pac-"+e);if(n){const i=this.abstraction[n];"function"==typeof i&&("submit"===e&&t.preventDefault(),i.call(this.abstraction,t))}}},updatePropertyFromDOM:function(t,e,n,i){i=i||!1;const r=t.getAttribute("data-pac-update-mode")||this.config.updateMode,a=parseInt(t.getAttribute("data-pac-update-delay"))||this.config.delay;if(i||"immediate"===r)this.abstraction[e]=n;else if("delayed"===r){const i=e+"_"+(t.id||t.getAttribute("data-pac-property")||"element"),r=this;this.delayedUpdates.has(i)&&clearTimeout(this.delayedUpdates.get(i));const o=setTimeout((function(){r.abstraction[e]=n,r.delayedUpdates.delete(i)}),a);this.delayedUpdates.set(i,o)}},establishHierarchy:function(){const t=window.PACRegistry.getHierarchy(this.container),e=t.parent,n=t.children;e&&this.parent!==e&&(this.parent=e,e.children.add(this));const i=this;n.forEach((function(t){t.parent!==i&&(t.parent&&t.parent.children.delete(t),t.parent=i,i.children.add(t))}))},notifyParent:function(t,e){this.parent&&"function"==typeof this.parent.receiveUpdate&&this.parent.receiveUpdate(t,e,this)},receiveUpdate:function(t,e,n){this.abstraction.onChildUpdate&&"function"==typeof this.abstraction.onChildUpdate&&this.abstraction.onChildUpdate(t,e,n);const i=new CustomEvent("pac:childupdate",{detail:{eventType:t,data:e,childPAC:n},bubbles:!0});this.container.dispatchEvent(i)},initialDOMUpdate:function(){for(const t in this.abstraction)this.abstraction.hasOwnProperty(t)&&"function"!=typeof this.abstraction[t]&&this.updateDOM(t,this.abstraction[t]);if(this.originalAbstraction.computed)for(const e in this.originalAbstraction.computed)if(this.originalAbstraction.computed.hasOwnProperty(e)){var t=this.abstraction[e];this.updateDOM(e,t)}},destroy:function(){const t=this;this.eventListeners.forEach((function(e,n){t.container.removeEventListener(n,e)})),this.eventListeners.clear(),this.delayedUpdates.forEach((function(t){clearTimeout(t)})),this.delayedUpdates.clear(),this.parent&&this.parent.children.delete(this),this.children.forEach((function(t){t.parent=null})),this.computedCache.clear(),this.computedDependencies.clear(),this.propertyDependents.clear(),this.reactiveProxies.clear(),this.bindings.clear(),this.abstraction=null},init:function(){return this.setupBindings(),this.abstraction=this.createReactiveAbstraction(),this.setupEventHandlers(),this.initialDOMUpdate(),this}},p=u.init(),h={};for(s in p.abstraction)p.abstraction.hasOwnProperty(s)&&(h[s]=p.abstraction[s]);return h.addChild=function(t){u.children.add(t),t.parent=u},h.removeChild=function(t){u.children.delete(t),t.parent=null},h.notifyParent=function(t,e){u.notifyParent(t,e)},h.receiveUpdate=function(t,e,n){u.receiveUpdate(t,e,n)},h.receiveFromParent=function(t,e){u.receiveFromParent(t,e)},h.destroy=function(){u.destroy()},h.control=function(t,e){return u.makeServerRequest(t,e)},h.sendToChildren=function(t,e){u.sendToChildren(t,e)},h.sendToChild=function(t,e,n){u.sendToChild(t,e,n)},h.broadcastDataUpdate=function(t,e){u.broadcastDataUpdate(t,e)},h.syncDataToChildren=function(t){u.syncDataToChildren(t)},h.findChild=function(t){return u.findChild(t)},h.findChildren=function(t){return u.findChildren(t)},h.findChildBySelector=function(t){return u.findChildBySelector(t)},h.findChildrenBySelector=function(t){return u.findChildrenBySelector(t)},h.findChildByProperty=function(t,e){return u.findChildByProperty(t,e)},Object.defineProperty(h,"parent",{get:function(){return u.parent},enumerable:!0}),Object.defineProperty(h,"children",{get:function(){return Array.from(u.children)},enumerable:!0}),Object.defineProperty(h,"container",{get:function(){return u.container},enumerable:!0}),window.PACRegistry.register(e,u),u.establishHierarchy(),window.PACRegistry.units.forEach((function(t){t===u||t.parent||t.establishHierarchy()})),h}t.SUPPORTS_PROXY="undefined"!=typeof Proxy,t.shouldBeReactive=function(t){return!(null===t||"object"!=typeof t||t.nodeType||t instanceof Date||t instanceof RegExp||t instanceof File)},t.deepEqual=function(e,n){if(e===n)return!0;if(null==e||null==n)return e===n;if(typeof e!=typeof n)return!1;if("object"==typeof e){if(Array.isArray(e)!==Array.isArray(n))return!1;const i=Object.keys(e),r=Object.keys(n);if(i.length!==r.length)return!1;for(let a=0;a<i.length;a++){const o=i[a];if(!r.includes(o))return!1;if(!t.deepEqual(e[o],n[o]))return!1}return!0}return!1},t.createRandomId=function(){return Date.now()+"_"+Math.floor(1e4*Math.random())},t.isEventType=function(t){return-1!==["click","submit","change","input","focus","blur","keyup","keydown"].indexOf(t)},e.prototype.register=function(t,e){this.units.set(t,e),this.invalidateHierarchyCache()},e.prototype.unregister=function(t){const e=this.units.get(t);return e&&(this.units.delete(t),this.invalidateHierarchyCache()),e},e.prototype.invalidateHierarchyCache=function(){this.hierarchyCache=new WeakMap},e.prototype.getHierarchy=function(t){if(this.hierarchyCache.has(t))return this.hierarchyCache.get(t);const e=this.computeHierarchy(t);return this.hierarchyCache.set(t,e),e},e.prototype.computeHierarchy=function(t){let e=null;const n=[];let i=t.parentElement;for(;i&&!e;)this.units.forEach((function(t){t.container===i&&(e=t)})),i=i.parentElement;return this.units.forEach((function(e){t.contains(e.container)&&e.container!==t&&n.push(e)})),{parent:e,children:n}},window.PACRegistry=window.PACRegistry||new e,window.wakaPAC=a,"undefined"!=typeof module&&module.exports&&(module.exports={wakaPAC:a,PACRegistry:e,ReactiveUtils:t})}();