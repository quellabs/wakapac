!function(){"use strict";function t(){this.units=new Map,this.hierarchyCache=new WeakMap}function e(t){return-1!==["click","submit","change","input","focus","blur","keyup","keydown"].indexOf(t)}function n(){return Date.now()+"_"+Math.floor(1e4*Math.random())}function i(t,i,a){let r;i=i||{},a=a||{};const o=document.querySelector(t);if(!o)throw new Error("Container not found for selector: "+t);const s={updateMode:"immediate",delay:300};for(r in a)a.hasOwnProperty(r)&&(s[r]=a[r]);const c={bindings:new Map,container:o,abstraction:null,delayedUpdates:new Map,parent:null,children:new Set,eventListeners:new Map,pendingDOMUpdates:null,pendingUpdates:null,originalAbstraction:i,config:s,computedCache:new Map,computedDependencies:new Map,propertyDependents:new Map,updateDOM:function(t,e){const n=this;this.pendingDOMUpdates||(this.pendingDOMUpdates=new Set,this.pendingUpdates={},window.requestAnimationFrame?requestAnimationFrame((function(){n.flushDOMUpdates()})):setTimeout((function(){n.flushDOMUpdates()}),0)),this.pendingDOMUpdates.add(t),this.pendingUpdates[t]=e},flushDOMUpdates:function(){if(!this.pendingDOMUpdates)return;const t=this;this.pendingDOMUpdates.forEach((function(e){const n=t.pendingUpdates[e];t.bindings.forEach((function(i){if(i.property===e)switch(i.type){case"text":t.updateTextBinding(i,e,n);break;case"attribute":i.element.setAttribute(i.attribute,n);break;case"input":i.element.value!==n&&(i.element.value=n);break;case"visible":t.updateVisibilityBinding(i,n)}}))})),this.pendingDOMUpdates=null,this.pendingUpdates=null},updateVisibilityBinding:function(t,e){const n=t.element;if(this.evaluateVisibilityCondition(t.condition,e)){if(n.hasAttribute("data-pac-hidden")){const t=n.getAttribute("data-pac-original-display");n.style.display=t||"",n.removeAttribute("data-pac-hidden"),n.removeAttribute("data-pac-original-display")}}else if(!n.hasAttribute("data-pac-hidden")){const t=window.getComputedStyle(n).display;"none"!==t&&n.setAttribute("data-pac-original-display",t),n.style.display="none",n.setAttribute("data-pac-hidden","true")}},updateTextBinding:function(t,e,n){const i=new RegExp("\\{\\{\\s*"+e+"\\s*\\}\\}","g"),a=t.originalText.replace(i,n);t.textNode?t.textNode.textContent=a:t.element.textContent=a},analyzeComputedDependencies:function(t){const e=[],n=t.toString(),i=/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g;let a;for(;null!==(a=i.exec(n));){const t=a[1];this.originalAbstraction.hasOwnProperty(t)&&-1===e.indexOf(t)&&e.push(t)}return e},analyzeVisibilityCondition:function(t){return t.startsWith("!")?t.substring(1):t},updateComputedProperties:function(t){const e=this;(this.propertyDependents.get(t)||[]).forEach((function(t){const n=e.computedCache.get(t),i=e.originalAbstraction.computed[t].call(e.abstraction);n!==i&&(e.computedCache.set(t,i),e.updateDOM(t,i),e.notifyParent("propertyChange",{property:t,oldValue:n,newValue:i,computed:!0}),e.updateComputedProperties(t))}))},createReactiveAbstraction:function(){const t={},e=this;if(this.originalAbstraction.computed)for(const n in this.originalAbstraction.computed)if(this.originalAbstraction.computed.hasOwnProperty(n)){const i=this.originalAbstraction.computed[n];if("function"==typeof i){const a=this.analyzeComputedDependencies(i);this.computedDependencies.set(n,a),a.forEach((function(t){e.propertyDependents.has(t)||e.propertyDependents.set(t,[]),e.propertyDependents.get(t).push(n)})),Object.defineProperty(t,n,{get:function(){if(e.computedCache.has(n))return e.computedCache.get(n);const a=i.call(t);return e.computedCache.set(n,a),a},enumerable:!0,configurable:!0})}}for(const e in this.originalAbstraction)if(this.originalAbstraction.hasOwnProperty(e)&&"computed"!==e){const n=this.originalAbstraction[e];"function"==typeof n?t[e]=n.bind(t):this.createReactiveProperty(t,e,n)}return t.notifyParent=function(t,n){e.notifyParent(t,n)},t},createReactiveProperty:function(t,e,n){let i=n;const a=this;Object.defineProperty(t,e,{get:function(){return i},set:function(t){if(i!==t){const n=i;i=t,a.updateDOM(e,t),a.updateComputedProperties(e),a.notifyParent("propertyChange",{property:e,oldValue:n,newValue:t})}},enumerable:!0,configurable:!0})},makeServerRequest:function(t,e){const n=this;return e=e||{},fetch(t,{method:e.method||"GET",headers:Object.assign({"Content-Type":"application/json","X-PAC-Request":"true","X-PAC-Version":"1.0","X-PAC-Component":this.container.id||"anonymous"},e.headers||{}),body:e.data?JSON.stringify(e.data):void 0}).then((t=>t.json())).then((t=>{if(e.updateProperties)for(const e in t)n.abstraction.hasOwnProperty(e)&&(n.abstraction[e]=t[e]);return e.onSuccess&&e.onSuccess.call(n.abstraction,t),t})).catch((t=>{throw e.onError&&e.onError.call(n.abstraction,t),t}))},setupBindings:function(){this.findTextBindings(),this.findAttributeBindings()},findTextBindings:function(){let t;const e=document.createTreeWalker(this.container,NodeFilter.SHOW_TEXT,null,!1),i=[];let a;for(;a=e.nextNode();){const e=a.textContent,r=e.match(/\{\{\s*(\w+)\s*\}\}/g);if(r){const o=a.parentElement;for(t=0;t<r.length;t++){const s=r[t].replace(/[{}\s]/g,""),c=s+"_text_"+n();i.push({key:c,binding:{type:"text",property:s,element:o,originalText:e,textNode:a}})}}}for(t=0;t<i.length;t++)this.bindings.set(i[t].key,i[t].binding)},findAttributeBindings:function(){let t;const i=this.container.querySelectorAll("[data-pac-bind]"),a=[];for(t=0;t<i.length;t++){const r=i[t],o=r.getAttribute("data-pac-bind").split(",");for(let t=0;t<o.length;t++){const i=o[t].trim(),s=i+"_"+n();if(-1!==i.indexOf(":")){const t=i.split(":"),n=t[0].trim(),o=t[1].trim();e(n)?a.push({key:s,binding:{type:"event",event:n,method:o,element:r}}):"visible"===n?a.push({key:s,binding:{type:"visible",property:o,element:r,condition:o}}):a.push({key:s,binding:{type:"attribute",property:o,element:r,attribute:n}})}else{const t=i.trim();this.setupInputElement(r,t),a.push({key:s,binding:{type:"input",property:t,element:r,updateMode:r.getAttribute("data-pac-update-mode")||this.config.updateMode,delay:parseInt(r.getAttribute("data-pac-update-delay"))||this.config.delay}})}}}for(t=0;t<a.length;t++){const e=a[t];if(this.bindings.set(e.key,e.binding),"visible"===e.binding.type){const t=this.analyzeVisibilityCondition(e.binding.condition);e.binding.property=t}}},setupInputElement:function(t,e){const n=t.getAttribute("data-pac-update")||this.config.updateMode,i=parseInt(t.getAttribute("data-pac-delay"))||this.config.delay;t.setAttribute("data-pac-property",e),t.setAttribute("data-pac-update-mode",n),t.setAttribute("data-pac-update-delay",i.toString())},setupEventHandlers:function(){const t=["input","change","click","submit","focus","blur","keyup","keydown"];for(let e=0;e<t.length;e++){const n=t[e],i=this.createEventHandler(n);this.container.addEventListener(n,i),this.eventListeners.set(n,i)}},createEventHandler:function(t){const e=this;return function(n){"input"===t?e.handleInput(n):"change"===t?e.handleChange(n):e.handleEvent(n)}},handleInput:function(t){const e=t.target.getAttribute("data-pac-property");if(!e||!this.abstraction.hasOwnProperty(e))return;const n=t.target.getAttribute("data-pac-update-mode")||this.config.updateMode;"change"===n?t.target.setAttribute("data-pac-pending-value",t.target.value):"immediate"===n?this.abstraction[e]=t.target.value:"delayed"===n&&this.updatePropertyFromDOM(t.target,e,t.target.value,!1)},handleChange:function(t){const e=t.target.getAttribute("data-pac-property");if(!e||!this.abstraction.hasOwnProperty(e))return;const n=e+"_"+t.target.getAttribute("data-pac-property");this.delayedUpdates.has(n)&&(clearTimeout(this.delayedUpdates.get(n)),this.delayedUpdates.delete(n)),this.abstraction[e]=t.target.value,t.target.removeAttribute("data-pac-pending-value")},handleEvent:function(t){const e=t.type;let n=!1;const i=this;if(this.bindings.forEach((function(a){if("event"===a.type&&a.event===e&&a.element===t.target){const r=i.abstraction[a.method];"function"==typeof r&&("submit"===e&&t.preventDefault(),r.call(i.abstraction,t),n=!0)}})),!n){const n=t.target.getAttribute("data-pac-"+e);if(n){const i=this.abstraction[n];"function"==typeof i&&("submit"===e&&t.preventDefault(),i.call(this.abstraction,t))}}},updatePropertyFromDOM:function(t,e,n,i){i=i||!1;const a=t.getAttribute("data-pac-update-mode")||this.config.updateMode,r=parseInt(t.getAttribute("data-pac-update-delay"))||this.config.delay;if(i||"immediate"===a)this.abstraction[e]=n;else if("delayed"===a){const i=e+"_"+(t.id||t.getAttribute("data-pac-property")||"element"),a=this;this.delayedUpdates.has(i)&&clearTimeout(this.delayedUpdates.get(i));const o=setTimeout((function(){a.abstraction[e]=n,a.delayedUpdates.delete(i)}),r);this.delayedUpdates.set(i,o)}},establishHierarchy:function(){const t=window.PACRegistry.getHierarchy(this.container),e=t.parent,n=t.children;e&&this.parent!==e&&(this.parent=e,e.children.add(this));const i=this;n.forEach((function(t){t.parent!==i&&(t.parent&&t.parent.children.delete(t),t.parent=i,i.children.add(t))}))},notifyParent:function(t,e){this.parent&&"function"==typeof this.parent.receiveUpdate&&this.parent.receiveUpdate(t,e,this)},receiveUpdate:function(t,e,n){this.abstraction.onChildUpdate&&"function"==typeof this.abstraction.onChildUpdate&&this.abstraction.onChildUpdate(t,e,n);const i=new CustomEvent("pac:childupdate",{detail:{eventType:t,data:e,childPAC:n},bubbles:!0});this.container.dispatchEvent(i)},initialDOMUpdate:function(){for(const t in this.abstraction)this.abstraction.hasOwnProperty(t)&&"function"!=typeof this.abstraction[t]&&this.updateDOM(t,this.abstraction[t]);if(this.originalAbstraction.computed)for(const e in this.originalAbstraction.computed)if(this.originalAbstraction.computed.hasOwnProperty(e)){var t=this.abstraction[e];this.updateDOM(e,t)}},destroy:function(){const t=this;this.eventListeners.forEach((function(e,n){t.container.removeEventListener(n,e)})),this.eventListeners.clear(),this.delayedUpdates.forEach((function(t){clearTimeout(t)})),this.delayedUpdates.clear(),this.parent&&this.parent.children.delete(this),this.children.forEach((function(t){t.parent=null})),this.computedCache.clear(),this.computedDependencies.clear(),this.propertyDependents.clear(),this.bindings.clear(),this.abstraction=null},init:function(){return this.setupBindings(),this.abstraction=this.createReactiveAbstraction(),this.setupEventHandlers(),this.initialDOMUpdate(),this}},d=c.init(),p={};for(r in d.abstraction)d.abstraction.hasOwnProperty(r)&&(p[r]=d.abstraction[r]);return p.addChild=function(t){c.children.add(t),t.parent=c},p.removeChild=function(t){c.children.delete(t),t.parent=null},p.notifyParent=function(t,e){c.notifyParent(t,e)},p.receiveUpdate=function(t,e,n){c.receiveUpdate(t,e,n)},p.destroy=function(){c.destroy()},p.control=function(t,e){return c.makeServerRequest(t,e)},Object.defineProperty(p,"parent",{get:function(){return c.parent},enumerable:!0}),Object.defineProperty(p,"children",{get:function(){return Array.from(c.children)},enumerable:!0}),Object.defineProperty(p,"container",{get:function(){return c.container},enumerable:!0}),window.PACRegistry.register(t,c),c.establishHierarchy(),window.PACRegistry.units.forEach((function(t){t===c||t.parent||t.establishHierarchy()})),p}t.prototype.register=function(t,e){this.units.set(t,e),this.invalidateHierarchyCache()},t.prototype.unregister=function(t){const e=this.units.get(t);return e&&(this.units.delete(t),this.invalidateHierarchyCache()),e},t.prototype.invalidateHierarchyCache=function(){this.hierarchyCache=new WeakMap},t.prototype.getHierarchy=function(t){if(this.hierarchyCache.has(t))return this.hierarchyCache.get(t);const e=this.computeHierarchy(t);return this.hierarchyCache.set(t,e),e},t.prototype.computeHierarchy=function(t){let e=null;const n=[];let i=t.parentElement;for(;i&&!e;)this.units.forEach((function(t){t.container===i&&(e=t)})),i=i.parentElement;return this.units.forEach((function(e){t.contains(e.container)&&e.container!==t&&n.push(e)})),{parent:e,children:n}},window.PACRegistry=window.PACRegistry||new t,window.wakaPAC=i,"undefined"!=typeof module&&module.exports&&(module.exports={wakaPAC:i,PACRegistry:t})}();