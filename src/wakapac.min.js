!function(){"use strict";function t(){}function e(){this.units=new Map,this.hierarchyCache=new WeakMap}function n(e){return t.isEventType(e)}function i(){return t.createRandomId()}function a(e,n,i){return i=i||"",t.shouldBeReactive(e)?t.SUPPORTS_PROXY?function(e,n,i){for(const r in e)if(e.hasOwnProperty(r)&&t.shouldBeReactive(e[r])){const t=i?i+"."+r:r;e[r]=a(e[r],n,t)}const r=Array.isArray(e),o={};if(r){["push","pop","shift","unshift","splice","sort","reverse"].forEach((t=>{o[t]=e[t]}))}return new Proxy(e,{get:(e,s)=>r&&o.hasOwnProperty(s)?function(...r){e.length;const c=o[s].apply(e,r);if("push"===s||"unshift"===s||"splice"===s)for(let r=0;r<e.length;r++)if(t.shouldBeReactive(e[r])&&!e[r]._isReactive){const t=i?i+"."+r:r.toString();e[r]=a(e[r],n,t)}return n(i||"root",e,"array-mutation",{method:s,args:r}),c}:e[s],set(e,r,o){const s=e[r];if(t.shouldBeReactive(o)){const t=i?i+"."+r:r.toString();o=a(o,n,t)}if(e[r]=o,!t.deepEqual(s,o)){const t=i?i+"."+r:r.toString();n(t,o,"property-set",{oldValue:s})}return!0},deleteProperty(t,e){const a=t[e];delete t[e];const r=i?i+"."+e:e.toString();return n(r,void 0,"property-delete",{oldValue:a}),!0}})}(e,n,i):function(e,n,i){const r=Array.isArray(e);if(r){["push","pop","shift","unshift","splice","sort","reverse"].forEach((r=>{const o=e[r];Object.defineProperty(e,r,{value:function(...e){const s=o.apply(this,e);if("push"===r||"unshift"===r||"splice"===r)for(let e=0;e<this.length;e++)if(t.shouldBeReactive(this[e])&&!this[e]._isReactive){const t=i?i+"."+e:e.toString();this[e]=a(this[e],n,t)}return n(i||"root",this,"array-mutation",{method:r,args:e}),s},enumerable:!1,configurable:!0})}))}for(const r in e)if(e.hasOwnProperty(r)){const o=e[r];if(t.shouldBeReactive(o)){const t=i?i+"."+r:r;e[r]=a(o,n,t)}}return Object.defineProperty(e,"_isReactive",{value:!0,enumerable:!1,configurable:!1}),e}(e,n,i):e}function r(e,r,o){let s;r=r||{},o=o||{};const c=document.querySelector(e);if(!c)throw new Error("Container not found for selector: "+e);const d={updateMode:"immediate",delay:300,deepReactivity:!0};for(s in o)o.hasOwnProperty(s)&&(d[s]=o[s]);const p={bindings:new Map,container:c,abstraction:null,delayedUpdates:new Map,parent:null,children:new Set,eventListeners:new Map,pendingDOMUpdates:null,pendingUpdates:null,originalAbstraction:r,config:d,computedCache:new Map,computedDependencies:new Map,propertyDependents:new Map,reactiveProxies:new WeakMap,handleDeepChange:function(t,e,n,i){const a=t.split(".")[0];this.updateComputedProperties(a),this.abstraction.hasOwnProperty(a)&&this.updateDOM(a,this.abstraction[a]),this.notifyParent("propertyChange",{property:a,path:t,newValue:e,changeType:n,meta:i})},updateDOM:function(t,e){const n=this;this.pendingDOMUpdates||(this.pendingDOMUpdates=new Set,this.pendingUpdates={},window.requestAnimationFrame?requestAnimationFrame((function(){n.flushDOMUpdates()})):setTimeout((function(){n.flushDOMUpdates()}),0)),this.pendingDOMUpdates.add(t),this.pendingUpdates[t]=e},flushDOMUpdates:function(){if(!this.pendingDOMUpdates)return;const t=this;this.pendingDOMUpdates.forEach((function(e){const n=t.pendingUpdates[e];t.bindings.forEach((function(i){if(i.property===e)switch(i.type){case"text":t.updateTextBinding(i,e,n);break;case"attribute":i.element.setAttribute(i.attribute,n);break;case"input":i.element.value!==n&&(i.element.value=n);break;case"visible":t.updateVisibilityBinding(i,n)}}))})),this.pendingDOMUpdates=null,this.pendingUpdates=null},updateVisibilityBinding:function(t,e){const n=t.element;if(this.evaluateVisibilityCondition(t.condition,e)){if(n.hasAttribute("data-pac-hidden")){const t=n.getAttribute("data-pac-original-display");n.style.display=t||"",n.removeAttribute("data-pac-hidden"),n.removeAttribute("data-pac-original-display")}}else if(!n.hasAttribute("data-pac-hidden")){const t=window.getComputedStyle(n).display;"none"!==t&&n.setAttribute("data-pac-original-display",t),n.style.display="none",n.setAttribute("data-pac-hidden","true")}},evaluateVisibilityCondition:function(t,e){return t.startsWith("!")?!e:!!e},updateTextBinding:function(t,e,n){const i=new RegExp("\\{\\{\\s*"+e+"\\s*\\}\\}","g");let a=n;"object"==typeof n&&null!==n?a=Array.isArray(n)?"["+n.length+" items]":JSON.stringify(n,null,2):null==n&&(a="");const r=t.originalText.replace(i,a);t.textNode?t.textNode.textContent=r:t.element.textContent=r},analyzeComputedDependencies:function(t){const e=[],n=t.toString(),i=/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g;let a;for(;null!==(a=i.exec(n));){const t=a[1];this.originalAbstraction.hasOwnProperty(t)&&-1===e.indexOf(t)&&e.push(t)}return e},analyzeVisibilityCondition:function(t){return t.startsWith("!")?t.substring(1):t},updateComputedProperties:function(e){const n=this;(this.propertyDependents.get(e)||[]).forEach((function(e){const i=n.computedCache.get(e),a=n.originalAbstraction.computed[e].call(n.abstraction);t.deepEqual(i,a)||(n.computedCache.set(e,a),n.updateDOM(e,a),n.notifyParent("propertyChange",{property:e,oldValue:i,newValue:a,computed:!0}),n.updateComputedProperties(e))}))},createReactiveAbstraction:function(){const t={},e=this;if(this.originalAbstraction.computed)for(const n in this.originalAbstraction.computed)if(this.originalAbstraction.computed.hasOwnProperty(n)){const i=this.originalAbstraction.computed[n];if("function"==typeof i){const a=this.analyzeComputedDependencies(i);this.computedDependencies.set(n,a),a.forEach((function(t){e.propertyDependents.has(t)||e.propertyDependents.set(t,[]),e.propertyDependents.get(t).push(n)})),Object.defineProperty(t,n,{get:function(){if(e.computedCache.has(n))return e.computedCache.get(n);const a=i.call(t);return e.computedCache.set(n,a),a},enumerable:!0,configurable:!0})}}for(const e in this.originalAbstraction)if(this.originalAbstraction.hasOwnProperty(e)&&"computed"!==e){const n=this.originalAbstraction[e];"function"==typeof n?t[e]=n.bind(t):this.createReactiveProperty(t,e,n)}return t.notifyParent=function(t,n){e.notifyParent(t,n)},t},createReactiveProperty:function(e,n,i){let r=i;const o=this;this.config.deepReactivity&&t.shouldBeReactive(r)&&(r=a(r,(function(t,e,n,i){o.handleDeepChange(t,e,n,i)}),n)),Object.defineProperty(e,n,{get:function(){return r},set:function(e){if(!t.deepEqual(r,e)){const i=r;o.config.deepReactivity&&t.shouldBeReactive(e)&&(e=a(e,(function(t,e,n,i){o.handleDeepChange(t,e,n,i)}),n)),r=e,o.updateDOM(n,e),o.updateComputedProperties(n),o.notifyParent("propertyChange",{property:n,oldValue:i,newValue:e})}},enumerable:!0,configurable:!0})},makeServerRequest:function(t,e){const n=this;return e=e||{},fetch(t,{method:e.method||"GET",headers:Object.assign({"Content-Type":"application/json","X-PAC-Request":"true","X-PAC-Version":"1.0","X-PAC-Component":this.container.id||"anonymous"},e.headers||{}),body:e.data?JSON.stringify(e.data):void 0}).then((t=>t.json())).then((t=>{if(e.updateProperties)for(const e in t)n.abstraction.hasOwnProperty(e)&&(n.abstraction[e]=t[e]);return e.onSuccess&&e.onSuccess.call(n.abstraction,t),t})).catch((t=>{throw e.onError&&e.onError.call(n.abstraction,t),t}))},setupBindings:function(){this.findTextBindings(),this.findAttributeBindings()},findTextBindings:function(){let t;const e=document.createTreeWalker(this.container,NodeFilter.SHOW_TEXT,null,!1),n=[];let a;for(;a=e.nextNode();){const e=a.textContent,r=e.match(/\{\{\s*(\w+)\s*\}\}/g);if(r){const o=a.parentElement;for(t=0;t<r.length;t++){const s=r[t].replace(/[{}\s]/g,""),c=s+"_text_"+i();n.push({key:c,binding:{type:"text",property:s,element:o,originalText:e,textNode:a}})}}}for(t=0;t<n.length;t++)this.bindings.set(n[t].key,n[t].binding)},findAttributeBindings:function(){let t;const e=this.container.querySelectorAll("[data-pac-bind]"),a=[];for(t=0;t<e.length;t++){const r=e[t],o=r.getAttribute("data-pac-bind").split(",");for(let t=0;t<o.length;t++){const e=o[t].trim(),s=e+"_"+i();if(-1!==e.indexOf(":")){const t=e.split(":"),i=t[0].trim(),o=t[1].trim();n(i)?a.push({key:s,binding:{type:"event",event:i,method:o,element:r}}):"visible"===i?a.push({key:s,binding:{type:"visible",property:o,element:r,condition:o}}):a.push({key:s,binding:{type:"attribute",property:o,element:r,attribute:i}})}else{const t=e.trim();this.setupInputElement(r,t),a.push({key:s,binding:{type:"input",property:t,element:r,updateMode:r.getAttribute("data-pac-update-mode")||this.config.updateMode,delay:parseInt(r.getAttribute("data-pac-update-delay"))||this.config.delay}})}}}for(t=0;t<a.length;t++){const e=a[t];if(this.bindings.set(e.key,e.binding),"visible"===e.binding.type){const t=this.analyzeVisibilityCondition(e.binding.condition);e.binding.property=t}}},setupInputElement:function(t,e){const n=t.getAttribute("data-pac-update")||this.config.updateMode,i=parseInt(t.getAttribute("data-pac-delay"))||this.config.delay;t.setAttribute("data-pac-property",e),t.setAttribute("data-pac-update-mode",n),t.setAttribute("data-pac-update-delay",i.toString())},setupEventHandlers:function(){const t=["input","change","click","submit","focus","blur","keyup","keydown"];for(let e=0;e<t.length;e++){const n=t[e],i=this.createEventHandler(n);this.container.addEventListener(n,i),this.eventListeners.set(n,i)}},createEventHandler:function(t){const e=this;return function(n){"input"===t?e.handleInput(n):"change"===t?e.handleChange(n):e.handleEvent(n)}},handleInput:function(t){const e=t.target.getAttribute("data-pac-property");if(!e||!this.abstraction.hasOwnProperty(e))return;const n=t.target.getAttribute("data-pac-update-mode")||this.config.updateMode;"change"===n?t.target.setAttribute("data-pac-pending-value",t.target.value):"immediate"===n?this.abstraction[e]=t.target.value:"delayed"===n&&this.updatePropertyFromDOM(t.target,e,t.target.value,!1)},handleChange:function(t){const e=t.target.getAttribute("data-pac-property");if(!e||!this.abstraction.hasOwnProperty(e))return;const n=e+"_"+t.target.getAttribute("data-pac-property");this.delayedUpdates.has(n)&&(clearTimeout(this.delayedUpdates.get(n)),this.delayedUpdates.delete(n)),this.abstraction[e]=t.target.value,t.target.removeAttribute("data-pac-pending-value")},handleEvent:function(t){const e=t.type;let n=!1;const i=this;if(this.bindings.forEach((function(a){if("event"===a.type&&a.event===e&&a.element===t.target){const r=i.abstraction[a.method];"function"==typeof r&&("submit"===e&&t.preventDefault(),r.call(i.abstraction,t),n=!0)}})),!n){const n=t.target.getAttribute("data-pac-"+e);if(n){const i=this.abstraction[n];"function"==typeof i&&("submit"===e&&t.preventDefault(),i.call(this.abstraction,t))}}},updatePropertyFromDOM:function(t,e,n,i){i=i||!1;const a=t.getAttribute("data-pac-update-mode")||this.config.updateMode,r=parseInt(t.getAttribute("data-pac-update-delay"))||this.config.delay;if(i||"immediate"===a)this.abstraction[e]=n;else if("delayed"===a){const i=e+"_"+(t.id||t.getAttribute("data-pac-property")||"element"),a=this;this.delayedUpdates.has(i)&&clearTimeout(this.delayedUpdates.get(i));const o=setTimeout((function(){a.abstraction[e]=n,a.delayedUpdates.delete(i)}),r);this.delayedUpdates.set(i,o)}},establishHierarchy:function(){const t=window.PACRegistry.getHierarchy(this.container),e=t.parent,n=t.children;e&&this.parent!==e&&(this.parent=e,e.children.add(this));const i=this;n.forEach((function(t){t.parent!==i&&(t.parent&&t.parent.children.delete(t),t.parent=i,i.children.add(t))}))},notifyParent:function(t,e){this.parent&&"function"==typeof this.parent.receiveUpdate&&this.parent.receiveUpdate(t,e,this)},receiveUpdate:function(t,e,n){this.abstraction.onChildUpdate&&"function"==typeof this.abstraction.onChildUpdate&&this.abstraction.onChildUpdate(t,e,n);const i=new CustomEvent("pac:childupdate",{detail:{eventType:t,data:e,childPAC:n},bubbles:!0});this.container.dispatchEvent(i)},initialDOMUpdate:function(){for(const t in this.abstraction)this.abstraction.hasOwnProperty(t)&&"function"!=typeof this.abstraction[t]&&this.updateDOM(t,this.abstraction[t]);if(this.originalAbstraction.computed)for(const e in this.originalAbstraction.computed)if(this.originalAbstraction.computed.hasOwnProperty(e)){var t=this.abstraction[e];this.updateDOM(e,t)}},destroy:function(){const t=this;this.eventListeners.forEach((function(e,n){t.container.removeEventListener(n,e)})),this.eventListeners.clear(),this.delayedUpdates.forEach((function(t){clearTimeout(t)})),this.delayedUpdates.clear(),this.parent&&this.parent.children.delete(this),this.children.forEach((function(t){t.parent=null})),this.computedCache.clear(),this.computedDependencies.clear(),this.propertyDependents.clear(),this.reactiveProxies.clear(),this.bindings.clear(),this.abstraction=null},init:function(){return this.setupBindings(),this.abstraction=this.createReactiveAbstraction(),this.setupEventHandlers(),this.initialDOMUpdate(),this}},u=p.init(),h={};for(s in u.abstraction)u.abstraction.hasOwnProperty(s)&&(h[s]=u.abstraction[s]);return h.addChild=function(t){p.children.add(t),t.parent=p},h.removeChild=function(t){p.children.delete(t),t.parent=null},h.notifyParent=function(t,e){p.notifyParent(t,e)},h.receiveUpdate=function(t,e,n){p.receiveUpdate(t,e,n)},h.destroy=function(){p.destroy()},h.control=function(t,e){return p.makeServerRequest(t,e)},Object.defineProperty(h,"parent",{get:function(){return p.parent},enumerable:!0}),Object.defineProperty(h,"children",{get:function(){return Array.from(p.children)},enumerable:!0}),Object.defineProperty(h,"container",{get:function(){return p.container},enumerable:!0}),window.PACRegistry.register(e,p),p.establishHierarchy(),window.PACRegistry.units.forEach((function(t){t===p||t.parent||t.establishHierarchy()})),h}t.SUPPORTS_PROXY="undefined"!=typeof Proxy,t.shouldBeReactive=function(t){return!(null===t||"object"!=typeof t||t.nodeType||t instanceof Date||t instanceof RegExp||t instanceof File)},t.deepEqual=function(e,n){if(e===n)return!0;if(null==e||null==n)return e===n;if(typeof e!=typeof n)return!1;if("object"==typeof e){if(Array.isArray(e)!==Array.isArray(n))return!1;const i=Object.keys(e),a=Object.keys(n);if(i.length!==a.length)return!1;for(let r=0;r<i.length;r++){const o=i[r];if(!a.includes(o))return!1;if(!t.deepEqual(e[o],n[o]))return!1}return!0}return!1},t.createRandomId=function(){return Date.now()+"_"+Math.floor(1e4*Math.random())},t.isEventType=function(t){return-1!==["click","submit","change","input","focus","blur","keyup","keydown"].indexOf(t)},e.prototype.register=function(t,e){this.units.set(t,e),this.invalidateHierarchyCache()},e.prototype.unregister=function(t){const e=this.units.get(t);return e&&(this.units.delete(t),this.invalidateHierarchyCache()),e},e.prototype.invalidateHierarchyCache=function(){this.hierarchyCache=new WeakMap},e.prototype.getHierarchy=function(t){if(this.hierarchyCache.has(t))return this.hierarchyCache.get(t);const e=this.computeHierarchy(t);return this.hierarchyCache.set(t,e),e},e.prototype.computeHierarchy=function(t){let e=null;const n=[];let i=t.parentElement;for(;i&&!e;)this.units.forEach((function(t){t.container===i&&(e=t)})),i=i.parentElement;return this.units.forEach((function(e){t.contains(e.container)&&e.container!==t&&n.push(e)})),{parent:e,children:n}},window.PACRegistry=window.PACRegistry||new e,window.wakaPAC=r,"undefined"!=typeof module&&module.exports&&(module.exports={wakaPAC:r,PACRegistry:e,ReactiveUtils:t})}();