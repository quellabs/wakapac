!function(){"use strict";const t={PROXY:"undefined"!=typeof Proxy,isReactive:t=>t&&"object"==typeof t&&!t.nodeType&&!(t instanceof Date)&&!(t instanceof RegExp)&&!(t instanceof File),deepEq:(e,i)=>{if(e===i)return!0;if(!e||!i||typeof e!=typeof i)return!1;if("object"!=typeof e)return!1;const n=Object.keys(e),r=Object.keys(i);if(n.length!==r.length)return!1;for(let a=0;a<n.length;a++){const s=n[a];if(!r.includes(s)||!t.deepEq(e[s],i[s]))return!1}return!0},id:()=>Date.now()+"_"+(1e4*Math.random()|0),isEvent:t=>/^(click|submit|change|input|focus|blur|key(up|down))$/.test(t)};function e(){this.units=new Map,this.cache=new WeakMap}function i(e,n,r=""){return t.isReactive(e)?t.PROXY?function(e,n,r){for(const a in e)e.hasOwnProperty(a)&&t.isReactive(e[a])&&(e[a]=i(e[a],n,r?`${r}.${a}`:a));const a=Array.isArray(e),s={};a&&["push","pop","shift","unshift","splice","sort","reverse"].forEach((t=>{s[t]=e[t]}));return new Proxy(e,{get:(e,o)=>a&&s[o]?function(...a){const c=s[o].apply(e,a);if(/^(push|unshift|splice)$/.test(o))for(let a=0;a<e.length;a++)t.isReactive(e[a])&&!e[a]._reactive&&(e[a]=i(e[a],n,`${r}.${a}`));return n(r||"root",e,"array-mutation",{method:o,args:a}),c}:e[o],set(e,a,s){const o=e[a];return t.isReactive(s)&&(s=i(s,n,r?`${r}.${a}`:a)),e[a]=s,t.deepEq(o,s)||n(r?`${r}.${a}`:a,s,"set",{old:o}),!0},deleteProperty(t,e){const i=t[e];return delete t[e],n(r?`${r}.${e}`:e,void 0,"delete",{old:i}),!0}})}(e,n,r):function(e,n,r){Array.isArray(e)&&["push","pop","shift","unshift","splice","sort","reverse"].forEach((a=>{const s=e[a];Object.defineProperty(e,a,{value:function(...e){const o=s.apply(this,e);if(/^(push|unshift|splice)$/.test(a))for(let e=0;e<this.length;e++)t.isReactive(this[e])&&!this[e]._reactive&&(this[e]=i(this[e],n,`${r}.${e}`));return n(r||"root",this,"array-mutation",{method:a,args:e}),o},enumerable:!1,configurable:!0})}));for(const a in e)e.hasOwnProperty(a)&&t.isReactive(e[a])&&(e[a]=i(e[a],n,r?`${r}.${a}`:a));return Object.defineProperty(e,"_reactive",{value:!0,enumerable:!1}),e}(e,n,r):e}function n(e,n={},r={}){const a=document.querySelector(e);if(!a)throw new Error(`Container not found: ${e}`);const s=Object.assign({updateMode:"immediate",delay:300,deepReactivity:!0},r),o={bindings:new Map,container:a,abstraction:null,delays:new Map,parent:null,children:new Set,listeners:new Map,pending:null,pendingVals:null,orig:n,config:s,computedCache:new Map,computedDeps:new Map,propDeps:new Map,updateForeach(t,e,i){if(t.collection!==e)return;let n=i;if(!Array.isArray(n))return console.warn("Foreach expects array, got:",typeof n),t.element.innerHTML="",void(t.prev=[]);const r=t.prev||[],a=Array.from(n);if(a===r)return;if(this.arrEq(r,a))return void(t.prev=[...a]);t.prev=[...a];const s=t.element;s.innerHTML="",a.forEach(((e,i)=>{const n=this.renderItem(t.template,e,i,t.itemName,t.indexName);s.appendChild(n)}))},renderItem(t,e,i,n,r){const a=document.createElement("div");a.innerHTML=t;const s=a.firstElementChild||a.firstChild;if(!s)return document.createTextNode("");const o=s.cloneNode(!0);return this.processText(o,e,i,n,r),this.processAttrs(o,e,i,n,r),o},arrEq(e,i){if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(!t.deepEq(e[n],i[n]))return!1;return!0},processText(t,e,i,n,r){const a=document.createTreeWalker(t,NodeFilter.SHOW_TEXT),s=[];let o;for(;o=a.nextNode();)s.push(o);s.forEach((function(t){let a=t.textContent;a=a.replace(new RegExp(`\\{\\{\\s*${n}\\.(\\w+)\\s*\\}\\}`,"g"),(function(t,i){return e&&e.hasOwnProperty(i)?e[i]:""})),a=a.replace(new RegExp(`\\{\\{\\s*${n}\\s*\\}\\}`,"g"),(function(){return"object"==typeof e?JSON.stringify(e):e||""})),a=a.replace(new RegExp(`\\{\\{\\s*${r}\\s*\\}\\}`,"g"),(function(){return i})),t.textContent=a}))},processAttrs(e,i,n,r,a){[e,...e.querySelectorAll("[data-pac-bind]")].forEach((e=>{const s=e.getAttribute("data-pac-bind");s&&s.split(",").forEach((s=>{const[o,c]=s.trim().split(":").map((t=>t.trim()));switch(o){case"class":this.evalExpr(c,i,n,r,a)&&e.classList.add(c.includes(".")?c.split(".").pop():c);break;case"checked":e.checked=!!this.evalExpr(c,i,n,r,a);break;default:if(t.isEvent(o))e.addEventListener(o,(t=>{"function"==typeof this.abstraction[c]&&this.abstraction[c].call(this.abstraction,i,n,t)}));else{const t=this.evalExpr(c,i,n,r,a);null!=t&&e.setAttribute(o,t)}}}))}))},evalExpr(t,e,i,n,r){if(t===r)return i;if(t===n)return e;if(t.startsWith(`${n}.`)){const i=t.substring(n.length+1).split(".");let r=e;for(const t of i){if(!r||!r.hasOwnProperty(t))return;r=r[t]}return r}return t},handleDeepChange(t,e,i,n){const r=t.split(".")[0];this.updateComputed(r),("array-mutation"===i||this.abstraction.hasOwnProperty(r))&&this.updateDOM(r,this.abstraction[r]),this.notifyParent("propertyChange",{property:r,path:t,newValue:e,changeType:i,meta:n})},updateDOM(t,e){this.pending||(this.pending=new Set,this.pendingVals={},(window.requestAnimationFrame||(t=>setTimeout(t,0)))((()=>this.flushDOM()))),this.pending.add(t),this.pendingVals[t]=e},flushDOM(){this.pending&&(this.pending.forEach((t=>{const e=this.pendingVals[t];this.bindings.forEach((i=>{if(i.property===t||"foreach"===i.type)switch(i.type){case"text":this.updateText(i,t,e);break;case"attribute":i.element.setAttribute(i.attribute,e);break;case"input":i.element.value!==e&&(i.element.value=e);break;case"visible":this.updateVisible(i,e);break;case"foreach":this.updateForeach(i,t,e)}}))})),this.pending=null,this.pendingVals=null)},updateVisible(t,e){const i=t.element;if(t.condition.startsWith("!")?!e:!!e)i.hasAttribute("data-pac-hidden")&&(i.style.display=i.getAttribute("data-pac-orig-display")||"",i.removeAttribute("data-pac-hidden"),i.removeAttribute("data-pac-orig-display"));else if(!i.hasAttribute("data-pac-hidden")){const t=getComputedStyle(i).display;"none"!==t&&i.setAttribute("data-pac-orig-display",t),i.style.display="none",i.setAttribute("data-pac-hidden","true")}},updateText(t,e,i){const n=new RegExp(`\\{\\{\\s*${e}\\s*\\}\\}`,"g");let r=i;"object"==typeof i&&null!==i?r=Array.isArray(i)?`[${i.length} items]`:JSON.stringify(i,null,2):null==i&&(r=""),(t.textNode||t.element).textContent=t.origText.replace(n,r)},analyzeComputed(t){const e=[],i=t.toString(),n=/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g;let r;for(;r=n.exec(i);){const t=r[1];this.orig.hasOwnProperty(t)&&!e.includes(t)&&e.push(t)}return e},updateComputed(e){(this.propDeps.get(e)||[]).forEach((e=>{const i=this.computedCache.get(e),n=this.orig.computed[e].call(this.abstraction);!Array.from(this.bindings.values()).some((function(t){return"foreach"===t.type&&t.collection===e}))&&t.deepEq(i,n)||(this.computedCache.set(e,n),this.updateDOM(e,n),this.notifyParent("propertyChange",{property:e,oldValue:i,newValue:n,computed:!0}),this.updateComputed(e))}))},createReactiveAbs(){const t=this,e={};if(this.orig.computed)for(const i in this.orig.computed){const n=this.orig.computed[i];if("function"==typeof n){const r=this.analyzeComputed(n);this.computedDeps.set(i,r),r.forEach((function(e){t.propDeps.has(e)||t.propDeps.set(e,[]),t.propDeps.get(e).push(i)})),Object.defineProperty(e,i,{get:()=>{if(this.computedCache.has(i))return this.computedCache.get(i);const t=n.call(e);return this.computedCache.set(i,t),t},enumerable:!0})}}for(const t in this.orig)if(this.orig.hasOwnProperty(t)&&"computed"!==t){const i=this.orig[t];"function"==typeof i?e[t]=i.bind(e):this.createReactiveProp(e,t,i)}return e.notifyParent=(t,e)=>this.notifyParent(t,e),e.sendToChildren=(t,e)=>this.sendToChildren(t,e),e.findChild=t=>Array.from(this.children).find(t),e},createReactiveProp(e,n,r){const a=this;let s=r;this.config.deepReactivity&&t.isReactive(s)&&(s=i(s,(function(t,e,i,n){return a.handleDeepChange(t,e,i,n)}),n)),Object.defineProperty(e,n,{get:()=>s,set:e=>{if(t.isReactive(s)||t.isReactive(e)||!t.deepEq(s,e)){const r=s;this.config.deepReactivity&&t.isReactive(e)&&(e=i(e,(function(t,e,i,n){return a.handleDeepChange(t,e,i,n)}),n)),s=e,this.updateDOM(n,e),this.updateComputed(n),this.notifyParent("propertyChange",{property:n,oldValue:r,newValue:e})}},enumerable:!0})},sendToChildren(t,e){this.children.forEach((i=>{"function"==typeof i.receiveFromParent&&i.receiveFromParent(t,e)}))},setupBindings(){this.findTextBindings(),this.findAttrBindings()},findTextBindings(){const e=document.createTreeWalker(this.container,NodeFilter.SHOW_TEXT),i=[];let n;for(;n=e.nextNode();){const e=n.textContent,r=e.match(/\{\{\s*(\w+)\s*\}\}/g);r&&r.forEach((r=>{const a=r.replace(/[{}\s]/g,"");i.push([t.id(),{type:"text",property:a,element:n.parentElement,origText:e,textNode:n}])}))}i.forEach((([t,e])=>this.bindings.set(t,e)))},findAttrBindings:function(){const e=this.container.querySelectorAll('[data-pac-bind]:not([data-pac-bind*="foreach"] [data-pac-bind])'),i=[];Array.from(e).forEach(function(e){const n=e.getAttribute("data-pac-bind");for(let r=0;r<n.split(",").length;r++){const a=n.split(",")[r],s=a.trim().split(":"),o=s[0]?s[0].trim():"",c=s[1]?s[1].trim():"",d=a+"_"+t.id();"foreach"!==o?t.isEvent(o)?i.push([d,this.createEventBinding(e,o,c)]):"visible"!==o?-1===a.indexOf(":")?(this.setupInput(e,a.trim()),i.push([d,this.createInputBinding(e,a.trim())])):i.push([d,this.createAttributeBinding(e,o,c)]):i.push([d,this.createVisibilityBinding(e,c)]):(i.push([d,this.createForeachBinding(e,c)]),e.innerHTML="")}}.bind(this)),i.forEach(function(t){this.bindings.set(t[0],t[1])}.bind(this))},createForeachBinding:function(t,e){return{type:"foreach",property:e,collection:e,itemName:t.getAttribute("data-pac-item")||"item",indexName:t.getAttribute("data-pac-index")||"index",template:t.innerHTML,element:t}},createEventBinding:function(t,e,i){return{type:"event",event:e,method:i,element:t}},createVisibilityBinding:function(t,e){return{type:"visible",property:e.replace(/^!/,""),element:t,condition:e}},createAttributeBinding:function(t,e,i){return{type:"attribute",property:i,element:t,attribute:e}},createInputBinding:function(t,e){const i=parseInt(t.getAttribute("data-pac-update-delay"))||this.config.delay||0,n=t.getAttribute("data-pac-update-mode")||this.config.updateMode||"immediate";return{type:"input",property:e,element:t,updateMode:n,delay:i}},setupInput(t,e){t.setAttribute("data-pac-property",e),t.setAttribute("data-pac-update-mode",t.getAttribute("data-pac-update")||this.config.updateMode),t.setAttribute("data-pac-update-delay",t.getAttribute("data-pac-delay")||this.config.delay)},setupEvents(){["input","change","click","submit","focus","blur","keyup","keydown"].forEach((t=>{const e=t=>this.handleEvent(t);this.container.addEventListener(t,e),this.listeners.set(t,e)}))},handleEvent(t){const{type:e,target:i}=t,n=i.getAttribute("data-pac-property");this._isInputEvent(e,n)?this._handleInputEvent(t,i,n):this._isChangeEvent(e,n)?this._handleChangeEvent(t,i,n):this._handleEventBinding(t,e,i)},_isInputEvent(t,e){return"input"===t&&e&&this.abstraction.hasOwnProperty(e)},_isChangeEvent(t,e){return"change"===t&&e&&this.abstraction.hasOwnProperty(e)},_handleInputEvent(t,e,i){const n=e.getAttribute("data-pac-update-mode")||this.config.updateMode,r=e.value;switch(n){case"change":e.setAttribute("data-pac-pending-value",r);break;case"immediate":this.abstraction[i]=r;break;case"delayed":this.updateFromDOM(e,i,r);break;default:console.warn(`Unknown update mode: ${n}. Using immediate.`),this.abstraction[i]=r}},_handleChangeEvent(t,e,i){const n=`${i}_${e.getAttribute("data-pac-property")}`;this.delays.has(n)&&(clearTimeout(this.delays.get(n)),this.delays.delete(n)),this.abstraction[i]=e.value,e.removeAttribute("data-pac-pending-value")},_handleEventBinding(t,e,i){this.bindings.forEach((n=>{this._isMatchingEventBinding(n,e,i)&&this._executeEventBinding(n,t)}))},_isMatchingEventBinding:(t,e,i)=>"event"===t.type&&t.event===e&&t.element===i,_executeEventBinding(t,e){const i=this.abstraction[t.method];if("function"==typeof i){"submit"===t.event&&e.preventDefault();try{i.call(this.abstraction,e)}catch(e){console.error(`Error executing event handler '${t.method}':`,e)}}else console.warn(`Event handler method '${t.method}' is not a function`)},updateFromDOM(t,e,i){const n=t.getAttribute("data-pac-update-mode")||this.config.updateMode,r=parseInt(t.getAttribute("data-pac-update-delay"))||this.config.delay;if("immediate"!==n){if("delayed"===n){const n=`${e}_${t.id||t.getAttribute("data-pac-property")}`;this.delays.has(n)&&clearTimeout(this.delays.get(n));const a=setTimeout((()=>{this.abstraction[e]=i,this.delays.delete(n)}),r);this.delays.set(n,a)}}else this.abstraction[e]=i},establishHierarchy(){const{parent:t,children:e}=window.PACRegistry.getHierarchy(this.container);t&&this.parent!==t&&(this.parent=t,t.children.add(this)),e.forEach((t=>{t.parent!==this&&(t.parent&&t.parent.children.delete(t),t.parent=this,this.children.add(t))}))},notifyParent(t,e){this.parent&&"function"==typeof this.parent.receiveUpdate&&this.parent.receiveUpdate(t,e,this)},receiveUpdate(t,e,i){this.abstraction.onChildUpdate&&this.abstraction.onChildUpdate(t,e,i),this.container.dispatchEvent(new CustomEvent("pac:childupdate",{detail:{eventType:t,data:e,childPAC:i},bubbles:!0}))},receiveFromParent(t,e){this.abstraction.receiveFromParent&&this.abstraction.receiveFromParent(t,e),this.container.dispatchEvent(new CustomEvent("pac:parentcommand",{detail:{command:t,data:e},bubbles:!0}))},initialUpdate(){for(const t in this.abstraction)this.abstraction.hasOwnProperty(t)&&"function"!=typeof this.abstraction[t]&&this.updateDOM(t,this.abstraction[t]);if(this.orig.computed)for(const t in this.orig.computed){const e=this.abstraction[t];this.updateDOM(t,e)}this.bindings.forEach((t=>{if("foreach"===t.type){t.prev=[];const e=this.abstraction[t.collection];void 0!==e&&this.updateForeach(t,t.collection,e)}}))},destroy(){this.listeners.forEach(((t,e)=>{this.container.removeEventListener(e,t)})),this.delays.forEach((t=>clearTimeout(t))),this.parent&&this.parent.children.delete(this),this.children.forEach((t=>t.parent=null)),this.computedCache.clear(),this.computedDeps.clear(),this.propDeps.clear(),this.bindings.clear(),this.abstraction=null},init(){return this.setupBindings(),this.abstraction=this.createReactiveAbs(),this.setupEvents(),this.initialUpdate(),this}},c=o.init(),d={};for(const t in c.abstraction)c.abstraction.hasOwnProperty(t)&&(d[t]=c.abstraction[t]);return Object.assign(d,{addChild:t=>{o.children.add(t),t.parent=o},removeChild:t=>{o.children.delete(t),t.parent=null},notifyParent:(t,e)=>o.notifyParent(t,e),receiveUpdate:(t,e,i)=>o.receiveUpdate(t,e,i),receiveFromParent:(t,e)=>o.receiveFromParent(t,e),destroy:()=>o.destroy(),control:(t,e={})=>fetch(t,{method:e.method||"GET",headers:Object.assign({"Content-Type":"application/json","X-PAC-Request":"true"},e.headers||{}),body:e.data?JSON.stringify(e.data):void 0}).then((t=>t.json())).then((t=>{if(e.updateProperties)for(const e in t)o.abstraction.hasOwnProperty(e)&&(o.abstraction[e]=t[e]);return e.onSuccess&&e.onSuccess.call(o.abstraction,t),t})).catch((t=>{throw e.onError&&e.onError.call(o.abstraction,t),t})),sendToChildren:(t,e)=>o.sendToChildren(t,e),sendToChild:(t,e,i)=>{const n=o.findChild((e=>e.container.matches(t)));n&&n.receiveFromParent&&n.receiveFromParent(e,i)},findChild:t=>Array.from(o.children).find(t),findChildren:t=>Array.from(o.children).filter(t),findChildBySelector:t=>Array.from(o.children).find((e=>e.container.matches(t))),findChildByProperty:(t,e)=>Array.from(o.children).find((i=>i.abstraction&&i.abstraction[t]===e))}),Object.defineProperties(d,{parent:{get:()=>o.parent,enumerable:!0},children:{get:()=>Array.from(o.children),enumerable:!0},container:{get:()=>o.container,enumerable:!0}}),window.PACRegistry.register(e,o),o.establishHierarchy(),window.PACRegistry.units.forEach((t=>{t===o||t.parent||t.establishHierarchy()})),d}e.prototype={register(t,e){this.units.set(t,e),this.cache=new WeakMap},unregister(t){const e=this.units.get(t);return e&&(this.units.delete(t),this.cache=new WeakMap),e},getHierarchy(t){if(this.cache.has(t))return this.cache.get(t);let e=null;const i=[];let n=t.parentElement;for(;n&&!e;)this.units.forEach((t=>{t.container===n&&(e=t)})),n=n.parentElement;this.units.forEach((e=>{t.contains(e.container)&&e.container!==t&&i.push(e)}));const r={parent:e,children:i};return this.cache.set(t,r),r}},window.PACRegistry=window.PACRegistry||new e,window.wakaPAC=n,"undefined"!=typeof module&&module.exports&&(module.exports={wakaPAC:n,PACRegistry:e,ReactiveUtils:t})}();