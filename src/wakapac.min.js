!function(){"use strict";const e={PROXY:"undefined"!=typeof Proxy,isReactive:e=>e&&"object"==typeof e&&!e.nodeType&&!(e instanceof Date)&&!(e instanceof RegExp)&&!(e instanceof File),deepEq:(t,i)=>{if(t===i)return!0;if(!t||!i||typeof t!=typeof i)return!1;if("object"!=typeof t)return!1;const n=Object.keys(t),r=Object.keys(i);if(n.length!==r.length)return!1;for(let a=0;a<n.length;a++){const s=n[a];if(!r.includes(s)||!e.deepEq(t[s],i[s]))return!1}return!0},id:()=>Date.now()+"_"+(1e4*Math.random()|0),isEvent:e=>/^(click|submit|change|input|focus|blur|key(up|down))$/.test(e)};function t(){this.units=new Map,this.cache=new WeakMap}function i(t,n,r=""){return e.isReactive(t)?e.PROXY?function(t,n,r){for(const a in t)t.hasOwnProperty(a)&&e.isReactive(t[a])&&(t[a]=i(t[a],n,r?`${r}.${a}`:a));const a=Array.isArray(t),s={};a&&["push","pop","shift","unshift","splice","sort","reverse"].forEach((e=>{s[e]=t[e]}));return new Proxy(t,{get:(t,o)=>a&&s[o]?function(...a){const c=s[o].apply(t,a);if(/^(push|unshift|splice)$/.test(o))for(let a=0;a<t.length;a++)e.isReactive(t[a])&&!t[a]._reactive&&(t[a]=i(t[a],n,`${r}.${a}`));return n(r||"root",t,"array-mutation",{method:o,args:a}),c}:t[o],set(t,a,s){const o=t[a];return e.isReactive(s)&&(s=i(s,n,r?`${r}.${a}`:a)),t[a]=s,e.deepEq(o,s)||n(r?`${r}.${a}`:a,s,"set",{old:o}),!0},deleteProperty(e,t){const i=e[t];return delete e[t],n(r?`${r}.${t}`:t,void 0,"delete",{old:i}),!0}})}(t,n,r):function(t,n,r){Array.isArray(t)&&["push","pop","shift","unshift","splice","sort","reverse"].forEach((a=>{const s=t[a];Object.defineProperty(t,a,{value:function(...t){const o=s.apply(this,t);if(/^(push|unshift|splice)$/.test(a))for(let t=0;t<this.length;t++)e.isReactive(this[t])&&!this[t]._reactive&&(this[t]=i(this[t],n,`${r}.${t}`));return n(r||"root",this,"array-mutation",{method:a,args:t}),o},enumerable:!1,configurable:!0})}));for(const a in t)t.hasOwnProperty(a)&&e.isReactive(t[a])&&(t[a]=i(t[a],n,r?`${r}.${a}`:a));return Object.defineProperty(t,"_reactive",{value:!0,enumerable:!1}),t}(t,n,r):t}function n(t,n={},r={}){const a=document.querySelector(t);if(!a)throw new Error(`Container not found: ${t}`);const s=Object.assign({updateMode:"immediate",delay:300,deepReactivity:!0},r),o={bindings:new Map,container:a,abstraction:null,delays:new Map,parent:null,children:new Set,listeners:new Map,pending:null,pendingVals:null,orig:n,config:s,computedCache:new Map,computedDeps:new Map,propDeps:new Map,updateForeach(e,t,i){if(e.collection!==t)return;let n=i;if(!Array.isArray(n))return console.warn("Foreach expects array, got:",typeof n),e.element.innerHTML="",void(e.prev=[]);const r=e.prev||[],a=Array.from(n);if(a===r)return;if(this.arrEq(r,a))return void(e.prev=[...a]);e.prev=[...a];const s=e.element;s.innerHTML="",a.forEach(((t,i)=>{const n=this.renderItem(e.template,t,i,e.itemName,e.indexName);s.appendChild(n)}))},renderItem(e,t,i,n,r){const a=document.createElement("div");a.innerHTML=e;const s=a.firstElementChild||a.firstChild;if(!s)return document.createTextNode("");const o=s.cloneNode(!0);return this.processText(o,t,i,n,r),this.processAttrs(o,t,i,n,r),o},arrEq(t,i){if(t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!e.deepEq(t[n],i[n]))return!1;return!0},processText(e,t,i,n,r){const a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),s=[];let o;for(;o=a.nextNode();)s.push(o);s.forEach((function(e){let a=e.textContent;a=a.replace(new RegExp(`\\{\\{\\s*${n}\\.(\\w+)\\s*\\}\\}`,"g"),(function(e,i){return t&&t.hasOwnProperty(i)?t[i]:""})),a=a.replace(new RegExp(`\\{\\{\\s*${n}\\s*\\}\\}`,"g"),(function(){return"object"==typeof t?JSON.stringify(t):t||""})),a=a.replace(new RegExp(`\\{\\{\\s*${r}\\s*\\}\\}`,"g"),(function(){return i})),e.textContent=a}))},processAttrs(t,i,n,r,a){[t,...t.querySelectorAll("[data-pac-bind]")].forEach((t=>{const s=t.getAttribute("data-pac-bind");s&&s.split(",").forEach((s=>{const[o,c]=s.trim().split(":").map((e=>e.trim()));switch(o){case"class":this.evalExpr(c,i,n,r,a)&&t.classList.add(c.includes(".")?c.split(".").pop():c);break;case"checked":t.checked=!!this.evalExpr(c,i,n,r,a);break;default:if(e.isEvent(o))t.addEventListener(o,(e=>{"function"==typeof this.abstraction[c]&&this.abstraction[c].call(this.abstraction,i,n,e)}));else{const e=this.evalExpr(c,i,n,r,a);null!=e&&t.setAttribute(o,e)}}}))}))},evalExpr(e,t,i,n,r){if(e===r)return i;if(e===n)return t;if(e.startsWith(`${n}.`)){const i=e.substring(n.length+1).split(".");let r=t;for(const e of i){if(!r||!r.hasOwnProperty(e))return;r=r[e]}return r}return e},handleDeepChange(e,t,i,n){const r=e.split(".")[0];this.updateComputed(r),("array-mutation"===i||this.abstraction.hasOwnProperty(r))&&this.updateDOM(r,this.abstraction[r]),this.notifyParent("propertyChange",{property:r,path:e,newValue:t,changeType:i,meta:n})},updateDOM(e,t){this.pending||(this.pending=new Set,this.pendingVals={},(window.requestAnimationFrame||(e=>setTimeout(e,0)))((()=>this.flushDOM()))),this.pending.add(e),this.pendingVals[e]=t},flushDOM(){this.pending&&(this.pending.forEach((e=>{const t=this.pendingVals[e];this.bindings.forEach((i=>{if(i.property===e||"foreach"===i.type)switch(i.type){case"text":this.updateText(i,e,t);break;case"attribute":i.element.setAttribute(i.attribute,t);break;case"input":i.element.value!==t&&(i.element.value=t);break;case"checked":i.element.checked!==!!t&&(i.element.checked=!!t);break;case"visible":this.updateVisible(i,t);break;case"foreach":this.updateForeach(i,e,t)}}))})),this.pending=null,this.pendingVals=null)},updateVisible(e,t){const i=e.element;if(e.condition.startsWith("!")?!t:!!t)i.hasAttribute("data-pac-hidden")&&(i.style.display=i.getAttribute("data-pac-orig-display")||"",i.removeAttribute("data-pac-hidden"),i.removeAttribute("data-pac-orig-display"));else if(!i.hasAttribute("data-pac-hidden")){const e=getComputedStyle(i).display;"none"!==e&&i.setAttribute("data-pac-orig-display",e),i.style.display="none",i.setAttribute("data-pac-hidden","true")}},updateText(e,t,i){const n=new RegExp(`\\{\\{\\s*${t}\\s*\\}\\}`,"g");let r=i;"object"==typeof i&&null!==i?r=Array.isArray(i)?`[${i.length} items]`:JSON.stringify(i,null,2):null==i&&(r=""),(e.textNode||e.element).textContent=e.origText.replace(n,r)},analyzeComputed(e){const t=[],i=e.toString(),n=/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g;let r;for(;r=n.exec(i);){const e=r[1];this.orig.hasOwnProperty(e)&&!t.includes(e)&&t.push(e)}return t},updateComputed(t){(this.propDeps.get(t)||[]).forEach((t=>{const i=this.computedCache.get(t),n=this.orig.computed[t].call(this.abstraction);!Array.from(this.bindings.values()).some((function(e){return"foreach"===e.type&&e.collection===t}))&&e.deepEq(i,n)||(this.computedCache.set(t,n),this.updateDOM(t,n),this.notifyParent("propertyChange",{property:t,oldValue:i,newValue:n,computed:!0}),this.updateComputed(t))}))},createReactiveAbs(){const e=this,t={};if(this.orig.computed)for(const i in this.orig.computed){const n=this.orig.computed[i];if("function"==typeof n){const r=this.analyzeComputed(n);this.computedDeps.set(i,r),r.forEach((function(t){e.propDeps.has(t)||e.propDeps.set(t,[]),e.propDeps.get(t).push(i)})),Object.defineProperty(t,i,{get:()=>{if(this.computedCache.has(i))return this.computedCache.get(i);const e=n.call(t);return this.computedCache.set(i,e),e},enumerable:!0})}}for(const e in this.orig)if(this.orig.hasOwnProperty(e)&&"computed"!==e){const i=this.orig[e];"function"==typeof i?t[e]=i.bind(t):this.createReactiveProp(t,e,i)}return t.notifyParent=(e,t)=>this.notifyParent(e,t),t.sendToChildren=(e,t)=>this.sendToChildren(e,t),t.findChild=e=>Array.from(this.children).find(e),t},createReactiveProp(t,n,r){const a=this;let s=r;this.config.deepReactivity&&e.isReactive(s)&&(s=i(s,(function(e,t,i,n){return a.handleDeepChange(e,t,i,n)}),n)),Object.defineProperty(t,n,{get:()=>s,set:t=>{if(e.isReactive(s)||e.isReactive(t)||!e.deepEq(s,t)){const r=s;this.config.deepReactivity&&e.isReactive(t)&&(t=i(t,(function(e,t,i,n){return a.handleDeepChange(e,t,i,n)}),n)),s=t,this.updateDOM(n,t),this.updateComputed(n),this.notifyParent("propertyChange",{property:n,oldValue:r,newValue:t})}},enumerable:!0})},sendToChildren(e,t){this.children.forEach((i=>{"function"==typeof i.receiveFromParent&&i.receiveFromParent(e,t)}))},setupBindings(){this.findTextBindings(),this.findAttrBindings()},findTextBindings(){const t=document.createTreeWalker(this.container,NodeFilter.SHOW_TEXT),i=[];let n;for(;n=t.nextNode();){const t=n.textContent,r=t.match(/\{\{\s*(\w+)\s*\}\}/g);r&&r.forEach((r=>{const a=r.replace(/[{}\s]/g,"");i.push([e.id(),{type:"text",property:a,element:n.parentElement,origText:t,textNode:n}])}))}i.forEach((([e,t])=>this.bindings.set(e,t)))},findAttrBindings:function(){const t=this.container.querySelectorAll('[data-pac-bind]:not([data-pac-bind*="foreach"] [data-pac-bind])'),i=[];Array.from(t).forEach(function(t){const n=t.getAttribute("data-pac-bind");for(let r=0;r<n.split(",").length;r++){const a=n.split(",")[r],s=a.trim().split(":"),o=s[0]?s[0].trim():"",c=s[1]?s[1].trim():"",d=a+"_"+e.id();"foreach"!==o?e.isEvent(o)?i.push([d,this.createEventBinding(t,o,c)]):"visible"!==o?"value"!==o?"checked"!==o?-1!==a.indexOf(":")&&c?i.push([d,this.createAttributeBinding(t,o,c)]):-1!==a.indexOf(":")||console.error(`Invalid binding syntax: "${a}". All bindings must use "type:target" format (e.g., "value:propertyName", "click:methodName").`):(this.setupInput(t,c,"checked"),i.push([d,this.createCheckedBinding(t,c)])):(this.setupInput(t,c),i.push([d,this.createInputBinding(t,c)])):i.push([d,this.createVisibilityBinding(t,c)]):(i.push([d,this.createForeachBinding(t,c)]),t.innerHTML="")}}.bind(this)),i.forEach(function(e){this.bindings.set(e[0],e[1])}.bind(this))},createForeachBinding:function(e,t){return{type:"foreach",property:t,collection:t,itemName:e.getAttribute("data-pac-item")||"item",indexName:e.getAttribute("data-pac-index")||"index",template:e.innerHTML,element:e}},createEventBinding:function(e,t,i){return{type:"event",event:t,method:i,element:e}},createVisibilityBinding:function(e,t){return{type:"visible",property:t.replace(/^!/,""),element:e,condition:t}},createAttributeBinding:function(e,t,i){return{type:"attribute",property:i,element:e,attribute:t}},createInputBinding:function(e,t){const i=parseInt(e.getAttribute("data-pac-update-delay"))||this.config.delay||0,n=e.getAttribute("data-pac-update-mode")||this.config.updateMode||"immediate";return{type:"input",property:t,element:e,updateMode:n,delay:i}},setupInput(e,t,i="value"){e.setAttribute("data-pac-property",t),e.setAttribute("data-pac-binding-type",i),e.setAttribute("data-pac-update-mode",e.getAttribute("data-pac-update")||this.config.updateMode),e.setAttribute("data-pac-update-delay",e.getAttribute("data-pac-delay")||this.config.delay)},createCheckedBinding:function(e,t){const i=parseInt(e.getAttribute("data-pac-update-delay"))||this.config.delay||0,n=e.getAttribute("data-pac-update-mode")||this.config.updateMode||"immediate";return{type:"checked",property:t,element:e,updateMode:n,delay:i}},setupEvents(){["input","change","click","submit","focus","blur","keyup","keydown"].forEach((e=>{const t=e=>this.handleEvent(e);this.container.addEventListener(e,t),this.listeners.set(e,t)}))},handleEvent(e){const{type:t,target:i}=e,n=i.getAttribute("data-pac-property");this._isInputEvent(t,n)?this._handleInputEvent(e,i,n):this._isChangeEvent(t,n)?this._handleChangeEvent(e,i,n):this._handleEventBinding(e,t,i)},_isInputEvent(e,t){return"input"===e&&t&&this.abstraction.hasOwnProperty(t)},_isChangeEvent(e,t){return"change"===e&&t&&this.abstraction.hasOwnProperty(t)},_handleInputEvent(e,t,i){const n=t.getAttribute("data-pac-update-mode")||this.config.updateMode;let r;switch(r="checked"===(t.getAttribute("data-pac-binding-type")||"value")?t.checked:t.value,n){case"change":t.setAttribute("data-pac-pending-value",r);break;case"immediate":this.abstraction[i]=r;break;case"delayed":this.updateFromDOM(t,i,r);break;default:console.warn(`Unknown update mode: ${n}. Using immediate.`),this.abstraction[i]=r}},_handleChangeEvent(e,t,i){const n=`${i}_${t.getAttribute("data-pac-property")}`,r=t.getAttribute("data-pac-binding-type")||"value";let a;this.delays.has(n)&&(clearTimeout(this.delays.get(n)),this.delays.delete(n)),a="checked"===r?t.checked:t.value,this.abstraction[i]=a,t.removeAttribute("data-pac-pending-value")},_handleEventBinding(e,t,i){this.bindings.forEach((n=>{this._isMatchingEventBinding(n,t,i)&&this._executeEventBinding(n,e)}))},_isMatchingEventBinding:(e,t,i)=>"event"===e.type&&e.event===t&&e.element===i,_executeEventBinding(e,t){const i=this.abstraction[e.method];if("function"==typeof i){"submit"===e.event&&t.preventDefault();try{i.call(this.abstraction,t)}catch(t){console.error(`Error executing event handler '${e.method}':`,t)}}else console.warn(`Event handler method '${e.method}' is not a function`)},updateFromDOM(e,t,i){const n=e.getAttribute("data-pac-update-mode")||this.config.updateMode,r=parseInt(e.getAttribute("data-pac-update-delay"))||this.config.delay;if("immediate"!==n){if("delayed"===n){const n=`${t}_${e.id||e.getAttribute("data-pac-property")}`;this.delays.has(n)&&clearTimeout(this.delays.get(n));const a=setTimeout((()=>{this.abstraction[t]=i,this.delays.delete(n)}),r);this.delays.set(n,a)}}else this.abstraction[t]=i},establishHierarchy(){const{parent:e,children:t}=window.PACRegistry.getHierarchy(this.container);e&&this.parent!==e&&(this.parent=e,e.children.add(this)),t.forEach((e=>{e.parent!==this&&(e.parent&&e.parent.children.delete(e),e.parent=this,this.children.add(e))}))},notifyParent(e,t){this.parent&&"function"==typeof this.parent.receiveUpdate&&this.parent.receiveUpdate(e,t,this)},receiveUpdate(e,t,i){this.abstraction.onChildUpdate&&this.abstraction.onChildUpdate(e,t,i),this.container.dispatchEvent(new CustomEvent("pac:childupdate",{detail:{eventType:e,data:t,childPAC:i},bubbles:!0}))},receiveFromParent(e,t){this.abstraction.receiveFromParent&&this.abstraction.receiveFromParent(e,t),this.container.dispatchEvent(new CustomEvent("pac:parentcommand",{detail:{command:e,data:t},bubbles:!0}))},initialUpdate(){for(const e in this.abstraction)this.abstraction.hasOwnProperty(e)&&"function"!=typeof this.abstraction[e]&&this.updateDOM(e,this.abstraction[e]);if(this.orig.computed)for(const e in this.orig.computed){const t=this.abstraction[e];this.updateDOM(e,t)}this.bindings.forEach((e=>{if("foreach"===e.type){e.prev=[];const t=this.abstraction[e.collection];void 0!==t&&this.updateForeach(e,e.collection,t)}}))},destroy(){this.listeners.forEach(((e,t)=>{this.container.removeEventListener(t,e)})),this.delays.forEach((e=>clearTimeout(e))),this.parent&&this.parent.children.delete(this),this.children.forEach((e=>e.parent=null)),this.computedCache.clear(),this.computedDeps.clear(),this.propDeps.clear(),this.bindings.clear(),this.abstraction=null},init(){return this.setupBindings(),this.abstraction=this.createReactiveAbs(),this.setupEvents(),this.initialUpdate(),this}},c=o.init(),d={};for(const e in c.abstraction)c.abstraction.hasOwnProperty(e)&&(d[e]=c.abstraction[e]);return Object.assign(d,{addChild:e=>{o.children.add(e),e.parent=o},removeChild:e=>{o.children.delete(e),e.parent=null},notifyParent:(e,t)=>o.notifyParent(e,t),receiveUpdate:(e,t,i)=>o.receiveUpdate(e,t,i),receiveFromParent:(e,t)=>o.receiveFromParent(e,t),destroy:()=>o.destroy(),control:(e,t={})=>fetch(e,{method:t.method||"GET",headers:Object.assign({"Content-Type":"application/json","X-PAC-Request":"true"},t.headers||{}),body:t.data?JSON.stringify(t.data):void 0}).then((e=>e.json())).then((e=>{if(t.updateProperties)for(const t in e)o.abstraction.hasOwnProperty(t)&&(o.abstraction[t]=e[t]);return t.onSuccess&&t.onSuccess.call(o.abstraction,e),e})).catch((e=>{throw t.onError&&t.onError.call(o.abstraction,e),e})),sendToChildren:(e,t)=>o.sendToChildren(e,t),sendToChild:(e,t,i)=>{const n=o.findChild((t=>t.container.matches(e)));n&&n.receiveFromParent&&n.receiveFromParent(t,i)},findChild:e=>Array.from(o.children).find(e),findChildren:e=>Array.from(o.children).filter(e),findChildBySelector:e=>Array.from(o.children).find((t=>t.container.matches(e))),findChildByProperty:(e,t)=>Array.from(o.children).find((i=>i.abstraction&&i.abstraction[e]===t))}),Object.defineProperties(d,{parent:{get:()=>o.parent,enumerable:!0},children:{get:()=>Array.from(o.children),enumerable:!0},container:{get:()=>o.container,enumerable:!0}}),window.PACRegistry.register(t,o),o.establishHierarchy(),window.PACRegistry.units.forEach((e=>{e===o||e.parent||e.establishHierarchy()})),d}t.prototype={register(e,t){this.units.set(e,t),this.cache=new WeakMap},unregister(e){const t=this.units.get(e);return t&&(this.units.delete(e),this.cache=new WeakMap),t},getHierarchy(e){if(this.cache.has(e))return this.cache.get(e);let t=null;const i=[];let n=e.parentElement;for(;n&&!t;)this.units.forEach((e=>{e.container===n&&(t=e)})),n=n.parentElement;this.units.forEach((t=>{e.contains(t.container)&&t.container!==e&&i.push(t)}));const r={parent:t,children:i};return this.cache.set(e,r),r}},window.PACRegistry=window.PACRegistry||new t,window.wakaPAC=n,"undefined"!=typeof module&&module.exports&&(module.exports={wakaPAC:n,PACRegistry:t,ReactiveUtils:e})}();