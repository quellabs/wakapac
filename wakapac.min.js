!function(){"use strict";const e=["value","checked","visible","if","foreach","class","style","click","change","input","submit","focus","blur","keyup","keydown"],t=["push","pop","shift","unshift","splice","sort","reverse"],n=["readonly","required","selected","checked","hidden","multiple"],i=["input","change","click","submit","focus","blur","keyup","keydown"],r={enter:"Enter",escape:"Escape",esc:"Escape",space:" ",tab:"Tab",delete:["Delete","Backspace"],del:["Delete","Backspace"],up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight"},s={createScopedContext(e,t,n){if(!n&&!e)return t;const i=Object.create(t||null);return Object.defineProperty(i,"_contextType",{value:e,writable:!1,enumerable:!1,configurable:!1}),n&&"object"==typeof n&&Object.assign(i,n),i},queryElementsIncludingSelf(e,t){const n=Array.from(e.querySelectorAll(t));return e.matches(t)?[e,...n]:n},needsDeepTracking(e){return!(!e||"object"!=typeof e)&&(!!this.isPlainObject(e)||Array.isArray(e))},shouldReact(e,t){return!e.startsWith("_")&&!e.startsWith("$")&&"constructor"!==e&&"prototype"!==e&&"__proto__"!==e&&(null==t||"string"==typeof t||"number"==typeof t||"boolean"==typeof t||this.needsDeepTracking(t))},isPlainObject(e){if("object"!=typeof e||null===e)return!1;if(null===Object.getPrototypeOf(e))return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===Object.prototype},isEqual(e,t){if(e===t)return!0;if(Number.isNaN(e)&&Number.isNaN(t))return!0;if(!e||!t||"object"!=typeof e||"object"!=typeof t)return!1;if(Array.isArray(e))return Array.isArray(t)&&e.length===t.length&&e.every((e,n)=>this.isEqual(e,t[n]));const n=Object.keys(e),i=Object.keys(t);return n.length===i.length&&n.every(n=>Object.hasOwn(t,n)&&this.isEqual(e[n],t[n]))},isEventType:e=>/^(click|submit|change|input|focus|blur|key(up|down))$/.test(e),formatValue:e=>null!==e?String(e):"",sanitizeUserInput(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},escapeHTML:e=>String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),domRectToSimpleObject:e=>({top:e.top,left:e.left,right:e.right,bottom:e.bottom,width:e.width,height:e.height,x:e.x,y:e.y}),getTextNodesFromElement(e){const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[];let i;for(;i=t.nextNode();)n.push(i);return n},isElementVisible(e){const t=e.getBoundingClientRect(),n=window.innerHeight,i=window.innerWidth;return t.top<n&&t.bottom>0&&t.left<i&&t.right>0},isElementFullyVisible(e){const t=e.getBoundingClientRect(),n=window.innerHeight,i=window.innerWidth;return t.top>=0&&t.left>=0&&t.bottom<=n&&t.right<=i},isElementDirectlyFocused:e=>e===document.activeElement,isElementFocusWithin:e=>e===document.activeElement||e.contains(document.activeElement),getElementPosition(e){let t;if("string"==typeof e){const n=e.startsWith("#")?e.slice(1):e;t=document.getElementById(n)}else{if(!e||e.nodeType!==Node.ELEMENT_NODE)return null;t=e}if(!t)return null;const n=t.getBoundingClientRect(),i=window.scrollX||document.documentElement.scrollLeft||0,r=window.scrollY||document.documentElement.scrollTop||0;return{x:n.left+i,y:n.top+r}},detectNetworkQuality(){if(!navigator.onLine)return"offline";if("connection"in navigator&&navigator.connection?.effectiveType)switch(navigator.connection.effectiveType){case"slow-2g":case"2g":case"3g":return"slow";default:return"fast"}return"fast"}},a={get(e,t){if(null==e)return;const n=Array.isArray(t)?t:String(t).split(".");let i=e;for(const e of n){if(null==i)return;i=e in i?i[e]:void 0}return i},set(e,t,n){if("string"!=typeof t||0===t.length)return!1;const i=t.split("."),r=i.pop(),s=i.join("."),o=i.length?a.get(e.abstraction,s):e.abstraction;if(null==o)return!1;let c=o;for(;c&&!Object.prototype.hasOwnProperty.call(c,r);)c=Object.getPrototypeOf(c);c||(c=o);const l=c[r];return c[r]=n,this.triggerChangeIfNeeded(e,t,n,l),!0},triggerChangeIfNeeded(e,t,n,i){const r=t.split(".")[0];e.deps?.has(r)&&e.deps.get(r)?.fn&&e.notifyChange(t,n,"nested-set",{oldValue:i,nestedPath:t,newValue:n})},isNested:(e,t)=>Object.keys(t).some(t=>e.startsWith(`${t}.`)),buildNestedPropertyPath(e,t,n,i){for(const[r]of Object.entries(t))if(e.startsWith(`${r}.`))return n+"."+i+"."+e.substring(r.length+1);return e},resolveComputedPath(e,t){const n=t.split(".");let i=e.abstraction;for(let t=0;t<n.length;t++){if(null==i)return;const r=n[t];if(e.deps?.has(r)&&e.deps.get(r).fn){if(i=i[r],t<n.length-1){const e=n.slice(t+1).join(".");return a.get(i,e)}}else i=i[r]}return i}};function o(){this.evaluationStack=[],this.currentDependencies=null}function c(){this.components=new Map,this.hierarchyCache=new WeakMap}o.prototype.track=function(e,t){const n=new Set;this.evaluationStack.push(n),this.currentDependencies=n;try{const i=this.createTrackingProxy(t);return{result:e.call(i),dependencies:Array.from(n)}}finally{this.evaluationStack.pop(),this.currentDependencies=this.evaluationStack[this.evaluationStack.length-1]||null}},o.prototype.createTrackingProxy=function(e,t){t=t||"";const n=this;return new Proxy(e,{get:function(e,i){if("symbol"==typeof i)return e[i];if(!s.shouldReact(i,e[i]))return e[i];const r=t?t+"."+i:i;if(n.currentDependencies){const e=r.split(".")[0];n.currentDependencies.add(e),r!==e&&n.currentDependencies.add(r)}const a=e[i];return s.needsDeepTracking(a)?n.createTrackingProxy(a,r):a}})},c.prototype={register(e,t){this.components.set(e,t),this.hierarchyCache=new WeakMap},unregister(e){const t=this.components.get(e);return t&&(this.components.delete(e),this.hierarchyCache=new WeakMap,0===this.components.size&&window._wakaPACViewportComponents&&window._wakaPACViewportComponents.clear()),t},getHierarchy(e){if(this.hierarchyCache.has(e))return this.hierarchyCache.get(e);let t=null,n=e.parentElement;for(;n&&!t;)this.components.forEach(e=>{e.container===n&&(t=e)}),n=n.parentElement;const i=[];this.components.forEach(t=>{e.contains(t.container)&&t.container!==e&&i.push(t)});const r={parent:t,children:i};return this.hierarchyCache.set(e,r),r}};const l={tokens:[],currentToken:0,OPERATOR_PRECEDENCE:{"||":1,"&&":2,"===":6,"!==":6,"==":6,"!=":6,"<":7,">":7,"<=":7,">=":7,"+":8,"-":8,"*":9,"/":9,"%":9,"!":10,"unary-":10,"unary+":10},OPERATOR_TYPES:{"||":"logical","&&":"logical","===":"comparison","!==":"comparison","==":"comparison","!=":"comparison",">=":"comparison","<=":"comparison",">":"comparison","<":"comparison","+":"arithmetic","-":"arithmetic","*":"arithmetic","/":"arithmetic","%":"arithmetic"},createHelpfulError(e,t){let n=`Expression parsing failed: "${e}"\n`;n+=`Original error: ${t.message}\n`,t.message.includes('Expected ":" after object key')&&e.includes("?")&&e.includes("{")&&(n+="\nSuggestion: Ternary operators cannot be used as object keys in class bindings.\n",n+=`Try removing the braces: ${e.replace(/^\{|\}$/g,"").trim()}\n`,n+="Or use object syntax: { className: condition, otherClass: !condition }");const i=new Error(n);return i.originalError=t,i.expression=e,i},parseExpression(e){if("object"==typeof e&&null!==e){if(e.dependencies)return e;const t=this.extractDependencies(e);return Object.assign({},e,{dependencies:t})}e=String(e).trim();try{if(this.tokens=this.tokenize(e),this.currentToken=0,0===this.tokens.length)return null;const t=this.parseTernary();return t&&(t.dependencies=this.extractDependencies(t)),t}catch(t){throw this.createHelpfulError(e,t)}},tokenize(e){const t=[];let n=0;for(;n<e.length;){const i=e[n];if(/\s/.test(i)){n++;continue}if('"'===i||"'"===i){const i=this.tokenizeString(e,n);t.push(i.token),n=i.nextIndex;continue}if(/\d/.test(i)||"."===i&&/\d/.test(e[n+1])){const i=this.tokenizeNumber(e,n);t.push(i.token),n=i.nextIndex;continue}const r=/^(===|!==|==|!=|>=|<=|&&|\|\|)/.exec(e.slice(n));if(r){const e=r[1];t.push({type:"OPERATOR",value:e,precedence:this.getOperatorPrecedence(e)}),n+=e.length;continue}const s={"(":"LPAREN",")":"RPAREN","{":"LBRACE","}":"RBRACE","[":"LBRACKET","]":"RBRACKET",",":"COMMA",".":"DOT"};if(s[i])t.push({type:s[i],value:i}),n++;else{if("+-*/<>!?:%".includes(i)){const e=this.getOperatorPrecedence(i);let r;switch(i){case"?":r="QUESTION";break;case":":r="COLON";break;default:r="OPERATOR"}t.push({type:r,value:i,precedence:e}),n++;continue}if(/[a-zA-Z_$]/.test(i)){const i=this.tokenizeIdentifier(e,n);t.push(i.token),n=i.nextIndex;continue}n++}}return t},tokenizeString(e,t){const n=e[t];let i=t+1,r="";for(;i<e.length;){const t=e[i];if("\\"===t&&i+1<e.length){const s=e[i+1];s===n||"\\"===s?(r+=s,i+=2):(r+=t,i++)}else{if(t===n)return{token:{type:"STRING",value:r},nextIndex:i+1};r+=t,i++}}throw new Error(`Unterminated string literal starting at position ${t}: expected closing ${n}`)},tokenizeNumber(e,t){const n=/^(\d*\.?\d+(?:[eE][+-]?\d+)?)/.exec(e.slice(t));if(n)return{token:{type:"NUMBER",value:parseFloat(n[1])},nextIndex:t+n[1].length}},tokenizeIdentifier(e,t){const n=/^([a-zA-Z_$][a-zA-Z0-9_$]*)/.exec(e.slice(t));if(n){const e=n[1];return{token:{type:["true","false","null","undefined"].includes(e)?"KEYWORD":"IDENTIFIER",value:e},nextIndex:t+e.length}}},getOperatorPrecedence(e){return this.OPERATOR_PRECEDENCE[e]||0},parseTernary(){let e=this.parseBinaryWithPrecedence(1);if(this.match("QUESTION")){const t=this.parseTernary();return this.consume("COLON",'Expected ":" in ternary expression'),{type:"ternary",condition:e,trueValue:t,falseValue:this.parseTernary()}}return e},parseBinaryWithPrecedence(e){let t=this.parseUnary();for(;"OPERATOR"===this.peek().type;){const n=this.getOperatorPrecedence(this.peek().value);if(n<e)break;const i=this.advance().value,r=this.parseBinaryWithPrecedence(n+1);t={type:this.OPERATOR_TYPES[i]||"arithmetic",left:t,operator:i,right:r}}return t},parseUnary(){return this.matchOperator("!","-","+")?{type:"unary",operator:this.previous().value,operand:this.parseUnary()}:this.parsePrimary()},parsePrimary(){if(this.match("LPAREN")){const e=this.parseTernary();return this.consume("RPAREN","Expected closing parenthesis"),{type:"parentheses",inner:e}}if(this.match("LBRACE"))return this.parseObjectLiteral();if(this.check("STRING"))return{type:"literal",value:this.advance().value};if(this.check("NUMBER"))return{type:"literal",value:this.advance().value};if(this.check("KEYWORD")){let e;switch(this.advance().value){case"true":e=!0;break;case"false":e=!1;break;case"null":e=null;break;case"undefined":e=void 0}return{type:"literal",value:e}}return this.check("IDENTIFIER")?this.parsePropertyAccess():null},parseObjectLiteral(){const e=[];if(!this.check("RBRACE"))do{let t;if(this.check("STRING"))t=this.advance().value;else{if(!this.check("IDENTIFIER"))throw new Error("Expected property name");t=this.advance().value}this.consume("COLON",'Expected ":" after object key');const n=this.parseTernary();e.push({key:t,value:n})}while(this.match("COMMA")&&!this.check("RBRACE"));return this.consume("RBRACE","Expected closing brace"),{type:"object",pairs:e}},parsePropertyAccess(){let e=this.advance().value;for(;;)if(this.match("DOT")){if(!this.check("IDENTIFIER"))throw new Error('Expected property name after "."');e+="."+this.advance().value}else{if(!this.match("LBRACKET"))break;{const t=this.parseTernary();this.consume("RBRACKET","Expected closing bracket"),"literal"===t.type?e+="["+JSON.stringify(t.value)+"]":e+="["+this.reconstructExpression(t)+"]"}}return{type:"property",path:e}},reconstructExpression(e){if(!e)return"";switch(e.type){case"literal":return"string"==typeof e.value?'"'+e.value+'"':String(e.value);case"property":return e.path;case"arithmetic":return`${this.reconstructExpression(e.left)} ${e.operator} ${this.reconstructExpression(e.right)}`;default:return"unknown"}},match(...e){for(const t of e)if(this.check(t))return this.advance(),!0;return!1},matchOperator(...e){if(this.check("OPERATOR")){const t=this.peek();if(e.includes(t.value))return this.advance(),!0}return!1},check(e){return!this.isAtEnd()&&this.peek().type===e},advance(){return this.isAtEnd()||this.currentToken++,this.previous()},isAtEnd(){return this.currentToken>=this.tokens.length},peek(){return this.tokens[this.currentToken]||{type:"EOF",value:null}},previous(){return this.tokens[this.currentToken-1]},consume(e,t){if(this.check(e))return this.advance();throw new Error(t+` at token: ${JSON.stringify(this.peek())}`)},lookupInScopeChain(e,t){let n=e;for(;n&&n!==Object.prototype;){if(Object.prototype.hasOwnProperty.call(n,t))return n[t];n=Object.getPrototypeOf(n)}},evaluate(e,t){if(e)switch(e.type){case"literal":return e.value;case"property":return a.get(t,e.path);case"parentheses":return this.evaluate(e.inner,t);case"object":return this.evaluateObjectLiteral(e,t);case"ternary":return this.evaluate(e.condition,t)?this.evaluate(e.trueValue,t):this.evaluate(e.falseValue,t);case"logical":{const n=this.evaluate(e.left,t);return"&&"===e.operator?!!n&&this.evaluate(e.right,t):"||"===e.operator&&(!!n||this.evaluate(e.right,t))}case"comparison":case"arithmetic":{const n=this.evaluate(e.left,t),i=this.evaluate(e.right,t);return this.performOperation(n,e.operator,i)}case"unary":{const n=this.evaluate(e.operand,t);switch(e.operator){case"!":return!n;case"-":return-n;case"+":return+n;default:return n}}default:return}},evaluateObjectLiteral(e,t){const n={};return e.pairs&&e.pairs.forEach(({key:e,value:i})=>{n[e]=this.evaluate(i,t)}),n},performOperation(e,t,n){switch(t){case"+":return e+n;case"-":return Number(e)-Number(n);case"*":return Number(e)*Number(n);case"/":return Number(e)/Number(n);case"%":return Number(e)%Number(n);case"===":return e===n;case"!==":return e!==n;case"==":return e==n;case"!=":return e!=n;case">=":return e>=n;case"<=":return e<=n;case">":return e>n;case"<":return e<n;default:return!1}},extractDependencies(e){if(!e)return[];const t=new Set,n=e=>{if(e)switch(e.type){case"property":{const n=e.path.split(/[.[]/,1)[0];n&&!["true","false","null","undefined"].includes(n)&&t.add(n);break}case"ternary":n(e.condition),n(e.trueValue),n(e.falseValue);break;case"logical":case"comparison":case"arithmetic":n(e.left),n(e.right);break;case"unary":n(e.operand);break;case"parentheses":n(e.inner);break;case"object":e.pairs&&e.pairs.forEach(e=>n(e.value))}};return n(e),Array.from(t)},parseBindingString(e){const t=[];let n="",i=!1,r="",s=0,a=0;for(let o=0;o<e.length;o++){const c=e[o],l=o>0&&"\\"===e[o-1];'"'!==c&&"'"!==c||l||(i?c===r&&(i=!1,r=""):(i=!0,r=c)),i||("("===c?s++:")"===c?s--:"{"===c?a++:"}"===c&&a--),","!==c||i||0!==s||0!==a?n+=c:(this.addBindingPairIfValid(n,t),n="")}return this.addBindingPairIfValid(n,t),t},addBindingPairIfValid(e,t){const n=e.trim();if(!n)return;const i=this.findBindingColon(n);-1===i?t.push({type:n,target:""}):t.push({type:n.substring(0,i).trim(),target:n.substring(i+1).trim()})},findBindingColon(t){for(const n of e)if(t.startsWith(n+":"))return n.length;let n=!1,i="",r=0;for(let e=0;e<t.length;e++){const s=t[e],a=e>0&&"\\"===t[e-1];if('"'!==s&&"'"!==s||a||(n?s===i&&(n=!1,i=""):(n=!0,i=s)),!n)if("("===s)r++;else if(")"===s)r--;else if(":"===s&&0===r)return e}return-1}},d={cache:new Map,maxSize:1e3,parseExpression(e){const t=String(e).trim();if(this.cache.has(t))return this.cache.get(t);const n=l.parseExpression(e);if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}return this.cache.set(t,n),n},clear(){this.cache.clear()}};function h(e,c={},h={}){const u=document.querySelector(e);if(!u)throw new Error(`Container not found: ${e}`);const p={selector:e,container:u,config:Object.assign({updateMode:"immediate",delay:300},h),original:c,abstraction:null,bindings:new Map,bindingIndex:new Map,deps:new Map,lastValues:new Map,pendingUpdates:null,pendingValues:null,updateTimeouts:new Map,parent:null,children:new Set,eventListeners:new Map,initialize(){return this.setupTextBindings(),this.setupAttributeBindings(),this.buildBindingIndex(),this.abstraction=this.createReactiveAbstraction(),this.setupComplexChangeListener(),this.setupEventHandling(),this.setupIntersectionObserver(),this.updateContainerVisibility(),this.performInitialUpdate(),this},createReactiveAbstraction(){const e={};return this.setupBrowserProperties(e),this.setupComputedProperties(e),this.createReactiveProperty(e,"childrenCount",0),this.createReactiveProperty(e,"hasParent",!1),Object.keys(this.original).forEach(t=>{if(Object.prototype.hasOwnProperty.call(this.original,t)&&"computed"!==t){const n=this.original[t];"function"==typeof n?e[t]=n.bind(e):s.shouldReact(t,n)?this.createReactiveProperty(e,t,n):e[t]=n}}),Object.assign(e,{notifyParent:(e,t)=>this.notifyParent(e,t),notifyChildren:(e,t)=>this.notifyChildren(e,t),notifyChild:(e,t,n)=>this.notifyChild(e,t,n),toJSON:()=>this.serializeToJSON(),control:(e,t={})=>this.makeHttpRequest(e,t),readDOMValue:e=>p.readDOMValue(e),writeDOMValue:(e,t)=>p.writeDOMValue(e,t),formatValue:e=>s.formatValue(e),escapeHTML:e=>s.escapeHTML(e),sanitizeUserInput:e=>s.sanitizeUserInput(e),getElementPosition:e=>s.getElementPosition(e)}),e},setupComputedProperties(e){if(!this.original.computed)return;const t=new o;Object.keys(this.original.computed).forEach(n=>{const i=this.original.computed[n];this.deps.set(n,{fn:i,value:void 0,isDirty:!0,dependencies:[]}),Object.defineProperty(e,n,{get:()=>{const r=this.deps.get(n);if(r.isDirty||void 0===r.value){const{result:s,dependencies:a}=t.track(i,e);r.value=s,r.isDirty=!1,r.dependencies=a,this.updateReverseDependencies(n,a)}return r.value},enumerable:!0})})},updateReverseDependencies(e,t){t.forEach(t=>{this.deps.has(t)||this.deps.set(t,{dependents:[]});const n=this.deps.get(t);n.dependents=n.dependents||[],n.dependents.includes(e)||n.dependents.push(e)})},setupBrowserProperties(e){const t={browserOnline:navigator.onLine,browserNetworkQuality:s.detectNetworkQuality(),browserVisible:!document.hidden,browserScrollX:window.scrollX,browserScrollY:window.scrollY,browserViewportHeight:window.innerHeight,browserViewportWidth:window.innerWidth,browserDocumentWidth:document.documentElement.scrollWidth,browserDocumentHeight:document.documentElement.scrollHeight,containerIsScrollable:!1,containerScrollX:this.container.scrollLeft,containerScrollY:this.container.scrollTop,containerScrollContentWidth:this.container.scrollWidth,containerScrollContentHeight:this.container.scrollHeight,containerScrollWindow:{top:0,left:0,right:0,bottom:0,x:0,y:0},containerFocus:s.isElementDirectlyFocused(this.container),containerFocusWithin:s.isElementFocusWithin(this.container),containerVisible:s.isElementVisible(this.container),containerFullyVisible:s.isElementFullyVisible(this.container),containerClientRect:{top:0,left:0,right:0,bottom:0,width:0,height:0,x:0,y:0},containerWidth:this.container.clientWidth,containerHeight:this.container.clientHeight};Object.entries(t).forEach(([t,n])=>this.createReactiveProperty(e,t,n)),this.setupGlobalBrowserListeners(),this.setupContainerScrollTracking()},setupGlobalBrowserListeners(){if(window._wakaPACBrowserListeners)return;window._wakaPACBrowserListeners=!0;const e=e=>{const t=window.PACRegistry?.components;t?.size&&t.forEach(e)},t=(e,t,n)=>(...i)=>{clearTimeout(window[n]),window[n]=setTimeout(()=>e(...i),t)},n={online:()=>{const t=s.detectNetworkQuality();e(e=>{e.abstraction.browserOnline=!0,e.abstraction.browserNetworkQuality=t})},offline:()=>e(e=>{e.abstraction.browserOnline=!1,e.abstraction.browserNetworkQuality="offline"}),connectionChange:()=>{const t=s.detectNetworkQuality();e(e=>{e.abstraction.browserNetworkQuality=t})},visibility:()=>e(e=>e.abstraction.browserVisible=!document.hidden),scroll:t(()=>e(e=>{e.abstraction.browserScrollX=window.scrollX,e.abstraction.browserScrollY=window.scrollY}),16,"_wakaPACScrollTimeout"),resize:t(()=>e(e=>{Object.assign(e.abstraction,{browserViewportWidth:window.innerWidth,browserViewportHeight:window.innerHeight,browserDocumentWidth:document.documentElement.scrollWidth,browserDocumentHeight:document.documentElement.scrollHeight,browserScrollX:window.scrollX,browserScrollY:window.scrollY}),e.updateContainerVisibility()}),100,"_wakaPACResizeTimeout"),keyboard_message:e=>{this.dispatchEventToEventProc(e,{type:"keydown"===e.type?"EVENT_KEYDOWN":"EVENT_KEYUP",wParam:e.keyCode,lParam:0,key:e.key,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,target:e.target,originalEvent:e})},mouse_message:e=>{requestAnimationFrame(()=>{let t;"mousedown"===e.type?0===e.button?t="EVENT_LBUTTONDOWN":1===e.button?t="EVENT_MBUTTONDOWN":2===e.button&&(t="EVENT_RBUTTONDOWN"):"mouseup"===e.type&&(0===e.button?t="EVENT_LBUTTONUP":1===e.button?t="EVENT_MBUTTONUP":2===e.button&&(t="EVENT_RBUTTONUP")),this.dispatchEventToEventProc(e,{type:t,wParam:e.button,lParam:e.clientY<<16|e.clientX,clientX:e.clientX,clientY:e.clientY,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,target:e.target,originalEvent:e})})},focusin_message:t=>{e(e=>{(e.container.contains(t.target)||e.container===t.target)&&(e.abstraction.containerFocus=s.isElementDirectlyFocused(e.container),e.abstraction.containerFocusWithin=s.isElementFocusWithin(e.container))})},focusout_message:t=>{e(e=>{(e.container.contains(t.target)||e.container===t.target)&&(e.abstraction.containerFocus=s.isElementDirectlyFocused(e.container),e.abstraction.containerFocusWithin=e.container.contains(t.relatedTarget))})}};window._wakaPACGlobalHandlers=n,document.addEventListener("visibilitychange",n.visibility),document.addEventListener("keydown",n.keyboard_message,!0),document.addEventListener("keyup",n.keyboard_message,!0),document.addEventListener("mousedown",n.mouse_message,!0),document.addEventListener("mouseup",n.mouse_message,!0),document.addEventListener("focusin",n.focusin_message,!0),document.addEventListener("focusout",n.focusout_message,!0),window.addEventListener("online",n.online),window.addEventListener("offline",n.offline),window.addEventListener("scroll",n.scroll),window.addEventListener("resize",n.resize),"connection"in navigator&&navigator.connection&&navigator.connection.addEventListener("change",n.connectionChange)},setupContainerScrollTracking(){requestAnimationFrame(()=>this.updateContainerScrollState());const e=this.debounce(()=>{this.updateContainerScrollState()},16);this.container.addEventListener("scroll",e,{passive:!0}),this.containerScrollHandler=e},updateContainerScrollState(){const e=this.container.scrollLeft,t=this.container.scrollTop,n=this.container.clientWidth,i=this.container.clientHeight,r=this.container.scrollWidth,s=this.container.scrollHeight,a=r>this.abstraction.containerWidth||s>this.abstraction.containerHeight;this.abstraction.containerScrollX=e,this.abstraction.containerScrollY=t,this.abstraction.containerScrollContentWidth=r,this.abstraction.containerScrollContentHeight=s,this.abstraction.containerIsScrollable=a,Object.assign(this.abstraction.containerScrollWindow,{top:t,left:e,right:e+n,bottom:t+i,x:e,y:t})},debounce(e,t){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...i)},t)}},dispatchEventToEventProc(e,t){const n=window.PACRegistry?.components;n?.size&&n.forEach(n=>{if(n.original.eventProc&&"function"==typeof n.original.eventProc&&n.container.contains(e.target))try{n.original.eventProc.call(n.abstraction,t)&&(e.preventDefault(),e.stopPropagation())}catch(e){}})},setupIntersectionObserver(){this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.target===this.container){const t=e.boundingClientRect,n=e.isIntersecting,i=e.intersectionRatio>=.99;this.abstraction.containerVisible=n,this.abstraction.containerFullyVisible=i,this.abstraction.containerWidth=t.width,this.abstraction.containerHeight=t.height,this.abstraction.containerClientRect=s.domRectToSimpleObject(t)}})},{threshold:[0,1]}),this.intersectionObserver.observe(this.container)},updateContainerVisibility(){const e=s.domRectToSimpleObject(this.container.getBoundingClientRect());this.abstraction.containerClientRect=e,this.abstraction.containerWidth=e.width,this.abstraction.containerHeight=e.height,this.abstraction.containerVisible=s.isElementVisible(this.container),this.abstraction.containerFullyVisible=s.isElementFullyVisible(this.container)},createReactiveProperty(e,t,n){let i=n;s.needsDeepTracking(i)&&(i=this.createEventEmittingObject(i,t)),Object.defineProperty(e,t,{get:()=>i,set:e=>{const n=i,r=s.needsDeepTracking(e);r&&(e=this.createEventEmittingObject(e,t)),i=e,s.isEqual(n,e)||(r||s.needsDeepTracking(n)?this.emitComplexChange(t,e,"set",{oldValue:n}):this.handleSimpleChange(t,e,n))},enumerable:!0})},handleSimpleChange(e,t,n){this.triggerWatcher(e,t,n),this.invalidateComputedDependents(e),this.updateBindingsImmediately(e)},invalidateComputedDependents(e){const t=this.deps.get(e);t?.dependents&&t.dependents.forEach(e=>{const t=this.deps.get(e);if(t?.fn){const n=t.value;t.isDirty=!0;const i=this.abstraction[e];s.isEqual(n,i)||(this.triggerWatcher(e,i,n),this.updateBindingsImmediately(e,i),this.invalidateComputedDependents(e))}})},updateBindingsImmediately(e){const t=this.bindingIndex.get(e);t&&t.forEach(t=>{this.shouldUpdateBinding(t,e)&&this.updateBinding(t,e,null)})},createEventEmittingObject(e,n){return this.makeNestedEventEmitting(e,n),new Proxy(e,{set:(e,t,i)=>{const r=e[t];return s.needsDeepTracking(i)&&(i=this.createEventEmittingObject(i,n)),e[t]=i,s.isEqual(r,i)||this.emitComplexChange(n,e,"nested-set",{oldValue:r,nestedPath:`${n}.${t}`,newValue:i}),!0},get:(e,i)=>Array.isArray(e)&&t.includes(i)?this.createEventEmittingArrayMethod(e,i,n):e[i],deleteProperty:(e,t)=>{const i=e[t];return delete e[t],this.emitComplexChange(n,e,"nested-delete",{oldValue:i,nestedPath:`${n}.${t}`}),!0}})},makeNestedEventEmitting(e,t){Object.keys(e).forEach(n=>{s.needsDeepTracking(e[n])&&(e[n]=this.createEventEmittingObject(e[n],t))}),Array.isArray(e)&&e.forEach((n,i)=>{s.needsDeepTracking(n)&&(e[i]=this.createEventEmittingObject(n,t))})},createEventEmittingArrayMethod(e,t,n){return function(...i){const r=Array.prototype[t].apply(e,i);return["push","unshift","splice"].includes(t)&&e.forEach((t,i)=>{s.needsDeepTracking(t)&&!this.isAlreadyWrapped(t)&&(e[i]=this.createEventEmittingObject(t,n))}),this.emitComplexChange(n,e,"array-mutation",{method:t,args:i}),r}.bind(this)},isAlreadyWrapped:e=>e&&!0===e._isEventEmittingProxy,emitComplexChange(e,t,n,i={}){this.container.dispatchEvent(new CustomEvent("pac:complex-change",{detail:{property:e,newValue:t,changeType:n,...i},bubbles:!1}))},setupComplexChangeListener(){this.complexChangeHandler=e=>{const{property:t,newValue:n,changeType:i,oldValue:r,nestedPath:s}=e.detail;this.scheduleComplexUpdate(t,n,i,{oldValue:r,nestedPath:s})},this.container.addEventListener("pac:complex-change",this.complexChangeHandler)},scheduleComplexUpdate(e,t,n,i){this.pendingComplexUpdates||(this.pendingComplexUpdates=new Map,requestAnimationFrame(()=>{this.flushComplexUpdates()})),this.pendingComplexUpdates.set(e,{newValue:t,changeType:n,metadata:i})},flushComplexUpdates(){this.pendingComplexUpdates&&(this.pendingComplexUpdates.forEach((e,t)=>{const{newValue:n,metadata:i}=e;this.triggerWatcher(t,n,i.oldValue,i.nestedPath),this.invalidateComputedDependents(t),this.updateBindingsImmediately(t,n),i.nestedPath&&i.nestedPath!==t&&this.updateBindingsImmediately(i.nestedPath,n)}),this.pendingComplexUpdates=null)},triggerWatcher(e,t,n,i=null){if(this.abstraction&&this.original.watch){if(this.original.watch[e])try{this.original.watch[e].call(this.abstraction,t,n)}catch(e){}i&&Object.keys(this.original.watch).forEach(e=>{if((e.includes(".")||e.includes("*"))&&this.matchesWatchPattern(e,i)){const r=this.original.watch[e];if("function"==typeof r)try{r.call(this.abstraction,t,n,i)}catch(e){}}})}},matchesWatchPattern(e,t){if(e.includes("**")){const n=e.replace(".**","");return t===n||t.startsWith(n+".")}return e.includes("*")?this.matchesSingleWildcard(e,t):e===t},matchesSingleWildcard(e,t){const n=e.split("."),i=t.split(".");return n.length===i.length&&n.every((e,t)=>"*"===e||e===i[t])},setupTextBindings(){s.getTextNodesFromElement(this.container).forEach(e=>{const t=e.textContent,n=t.match(/\{\{\s*([^}]+)\s*}}/g);n&&n.forEach(n=>{const i=this.createBinding("text",e,{target:n.replace(/^\{\{\s*|\s*}}$/g,"").trim(),originalText:t,fullMatch:n,parsedExpression:null,dependencies:null});this.bindings.set(i.id,i)})})},setupAttributeBindings(){const e=this.container.querySelectorAll("[data-pac-bind]");Array.from(e).forEach(e=>{const t=e.getAttribute("data-pac-bind"),n=l.parseBindingString(t);this.reorderBindings(n).forEach(({type:t,target:n})=>{const i=this.createBindingByType(e,t,n);i&&this.bindings.set(i.id,i)})})},buildBindingIndex(){this.bindingIndex.clear(),this.bindings.forEach(e=>{if(!e.target)return;e.parsedExpression=d.parseExpression(e.target);let t=e.parsedExpression.dependencies||[];if("foreach"===e.type&&e.target.includes(".")){const n=e.target.split(".")[0];this.deps&&this.deps.has(n)&&this.deps.get(n).fn&&t.push(n)}if("foreach"===e.type&&e.template){const n=this.extractCombinedTemplateDependencies(e.template);t=[...new Set([...t,...n])]}t.forEach(t=>{this.bindingIndex.has(t)||this.bindingIndex.set(t,new Set),this.bindingIndex.get(t).add(e)}),e.dependencies=t}),this.handleComputedForeachDependencies()},extractTextInterpolationDependencies(e){const t=new Set,n=e.match(/\{\{\s*([^}]+)\s*\}\}/g);return n&&n.forEach(e=>{const n=e.replace(/^\{\{\s*|\s*\}\}$/g,"").trim();try{const e=d.parseExpression(n);e&&e.dependencies&&e.dependencies.forEach(e=>t.add(e))}catch(e){}}),t},extractAttributeBindingDependencies(e){const t=new Set,n=document.createElement("div");return n.innerHTML=e,s.queryElementsIncludingSelf(n,"[data-pac-bind]").forEach(e=>{const n=e.getAttribute("data-pac-bind");if(n&&n.trim())try{l.parseBindingString(n).forEach(({target:e})=>{if(e&&e.trim()){const n=d.parseExpression(e);n&&n.dependencies&&n.dependencies.forEach(e=>t.add(e))}})}catch(e){}}),t},extractCombinedTemplateDependencies(e){const t=this.extractTextInterpolationDependencies(e),n=this.extractAttributeBindingDependencies(e),i=new Set([...t,...n]);return Array.from(i)},createBinding(e,t,n){const i={id:Date.now()+"_"+(1e4*Math.random()|0),type:e,element:t,...n};return n.target&&(i.property=n.target.split(".")[0],i.propertyPath=n.target),i},reorderBindings(e){const t={foreach:1,if:2,visible:3,value:4,checked:4,click:5,change:5,input:5,submit:5,focus:5,blur:5,keyup:5,keydown:5};return e.sort((e,n)=>(t[e.type]||6)-(t[n.type]||6))},createBindingByType(e,t,n){const i={value:()=>this.createValueBinding(e,n),visible:()=>this.createVisibilityBinding(e,n),checked:()=>this.createCheckedBinding(e,n),class:()=>this.createClassBinding(e,n),style:()=>this.createStyleBinding(e,n),if:()=>this.createConditionalBinding(e,n),foreach:()=>this.createForeachBinding(e,n)};return i[t]?i[t]():s.isEventType(t)?this.createEventBinding(e,t,n):n?this.createAttributeBinding(e,t,n):null},createBaseBinding(e,t,n,i={}){return this.createBinding(e,t,{target:n,parsedExpression:null,dependencies:null,...i})},createVisibilityBinding(e,t){return this.createBaseBinding("visible",e,t)},createClassBinding:function(e,t){return this.createBaseBinding("class",e,t)},createStyleBinding(e,t){return this.createBaseBinding("style",e,t)},createAttributeBinding(e,t,n){return this.createBaseBinding("attribute",e,n,{attribute:t})},createConditionalBinding(e,t){return this.createBaseBinding("conditional",e,t,{placeholder:null,originalParent:e.parentNode,originalNextSibling:e.nextSibling,isRendered:!0})},createEventBinding(e,t,n){return this.createBaseBinding("event",e,n,{eventType:t,method:n})},createValueBinding(e,t){return this.setupInputElement(e,t),this.createInputBinding(e,t)},createCheckedBinding(e,t){return this.setupInputElement(e,t,"checked"),this.createBaseBinding("checked",e,t,{updateMode:e.getAttribute("data-pac-update-mode")||this.config.updateMode,delay:parseInt(e.getAttribute("data-pac-update-delay"))||this.config.delay})},createInputBinding(e,t){return this.createBaseBinding("input",e,t,{updateMode:e.getAttribute("data-pac-update-mode")||this.config.updateMode,delay:parseInt(e.getAttribute("data-pac-update-delay"))||this.config.delay})},createForeachBinding(e,t){const n=Array.from(this.bindings.values()).find(n=>n.element===e&&"foreach"===n.type&&n.collection===t);if(n)return n;const i=e.getAttribute("data-pac-item")||"item",r=e.getAttribute("data-pac-index")||"index",s=e.innerHTML.trim(),a=this.createBinding("foreach",e,{target:t,collection:t,itemName:i,indexName:r,template:s,previous:[]});return e.innerHTML="",a},setupInputElement(e,t,n="value"){const i=e.getAttribute("data-pac-property"),r=e.getAttribute("data-pac-binding-type");if(i||r)return;const s={"data-pac-property":t,"data-pac-binding-type":n,"data-pac-update-mode":e.getAttribute("data-pac-update")||this.config.updateMode,"data-pac-update-delay":e.getAttribute("data-pac-delay")||this.config.delay};Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n))},shouldUpdateBinding:(e,t)=>"foreach"===e.type?e.collection===t||!(!e.dependencies||!e.dependencies.includes(t))||!(!e.target||!e.target.includes(".")||e.target.split(".")[0]!==t):e.property===t||!(!e.propertyPath||!e.propertyPath.startsWith(t+"."))||!(!e.dependencies||!e.dependencies.includes(t)),scheduleUpdate(e,t){this.pendingUpdates||(this.pendingUpdates=new Set,this.pendingValues={},(window.requestAnimationFrame||(e=>setTimeout(e,0)))(()=>{this.flushUpdates()})),this.pendingUpdates.add(e),this.pendingValues[e]=t},flushUpdates(){if(!this.pendingUpdates)return;const e=this.collectRelevantBindings();this.handleForeachBindingUpdates(e),this.executeBindingUpdates(e),this.resetPendingState()},collectRelevantBindings(){const e=new Set;return this.pendingUpdates.forEach(t=>{(this.bindingIndex.get(t)||[]).forEach(n=>{this.shouldUpdateBinding(n,t)&&e.add(n)})}),e},handleForeachBindingUpdates(e){e.forEach(e=>{"foreach"===e.type&&Array.from(this.pendingUpdates).some(t=>t!==e.collection)&&(e.previous=null)})},executeBindingUpdates(e){e.forEach(e=>{this.updateBinding(e,null,null)})},resetPendingState(){this.pendingUpdates=null,this.pendingValues=null},updateComputedProperties(e){const t=this.deps.get(e);(t&&t.dependents?t.dependents:[]).forEach(e=>{const t=this.deps.get(e),n=t?t.value:void 0;t&&(t.isDirty=!0);const i=this.abstraction[e];!Array.from(this.bindings.values()).some(t=>"foreach"===t.type&&t.collection===e)&&s.isEqual(n,i)||(this.triggerWatcher(e,i,n),this.scheduleUpdate(e,i),this.updateComputedProperties(e),this.bindings.forEach(t=>{t.target&&t.target.startsWith(e+".")&&this.updateBinding(t,e,null)}))})},performInitialUpdate(){if(Object.keys(this.abstraction).forEach(e=>{Object.prototype.hasOwnProperty.call(this.abstraction,e)&&"function"!=typeof this.abstraction[e]&&this.scheduleUpdate(e,this.abstraction[e])}),this.original.computed&&Object.keys(this.original.computed).forEach(e=>{this.scheduleUpdate(e,this.abstraction[e])}),this.bindings.forEach(e=>{"foreach"===e.type?(e.previous=[],void 0!==this.abstraction[e.collection]&&this.applyForeachBinding(e,e.collection)):!e.target||"text"===e.type||e.dependencies&&0!==e.dependencies.length||this.updateBinding(e,null,null)}),this.original.init&&"function"==typeof this.original.init)try{this.original.init.call(this.abstraction)}catch(e){}},getBindingHandler(e){return{visible:this.applyVisibilityBinding,class:this.applyClassBinding,style:this.applyStyleBinding,checked:this.applyInputBinding,input:this.applyInputBinding,value:this.applyInputBinding,attribute:this.applyAttributeBinding}[e]||this.applyAttributeBinding},updateBinding(e,t,n=null){try{const i={text:()=>this.applyTextBinding(e,t,n),foreach:()=>this.applyForeachBinding(e,t,n),event:()=>{},attribute:(t,n)=>this.applyAttributeBinding(e,n),input:(t,n)=>this.applyInputBinding(e,n),checked:(t,n)=>this.applyInputBinding(e,n),visible:(t,n)=>this.applyVisibilityBinding(e,n),conditional:(t,n)=>this.applyConditionalBinding(e,n),class:(t,n)=>this.applyClassBinding(e,n),style:(t,n)=>this.applyStyleBinding(e,n)}[e.type];if(!i)return;if("text"===e.type||"foreach"===e.type||"event"===e.type)return void i();const r=s.createScopedContext(e.type,this.abstraction,n||{}),a=d.parseExpression(e.target);i(r,l.evaluate(a,r))}catch(e){}},updateBindingDirect(e,t,n){const i={element:e,type:t,attribute:t};switch(t){case"visible":this.applyVisibilityBinding(i,n);break;case"class":this.applyClassBinding(i,n);break;case"style":this.applyStyleBinding(i,n);break;case"input":case"value":case"checked":this.applyInputBinding(i,n);break;default:i.attribute=t,this.applyAttributeBinding(i,n)}},createForeachItemElement(e){const t=document.createElement("template");t.innerHTML=e.trim();const n=Array.from(t.content.childNodes);if(1===n.length&&n[0].nodeType===Node.ELEMENT_NODE)return n[0].cloneNode(!0);const i=document.createElement("span");return n.forEach(e=>i.appendChild(e.cloneNode(!0))),i},processTextBindingsForElement(e,t){const n=s.getTextNodesFromElement(e),i=s.createScopedContext("text",this.abstraction,t);n.forEach(e=>{const t=e.textContent;/\{\{\s*[^}]+\s*}}/.test(t)&&this.createReactiveTextBinding(e,t,i)})},createReactiveTextBinding(e,t,n){const i=this.extractTextInterpolationDependencies(t),r=this.createBinding("text",e,{target:null,originalText:t,dependencies:Array.from(i),contextVars:n});this.bindings.set(r.id,r),i.forEach(e=>{this.bindingIndex.has(e)||this.bindingIndex.set(e,new Set),this.bindingIndex.get(e).add(r)}),e.textContent=this.processTextInterpolation(t,n)},processTextInterpolation(e,t){let n=String(e||"");const i=n.match(/\{\{\s*([^}]+)\s*}}/g);return i&&i.forEach(e=>{const i=e.replace(/^\{\{\s*|\s*}}$/g,"").trim();try{const r=d.parseExpression(i),a=l.evaluate(r,t),o=s.formatValue(a),c=s.sanitizeUserInput(o);n=n.replace(e,c)}catch(e){}}),n},processElementAttributeBindings(e,t){const n=s.createScopedContext("attribute",this.abstraction,t);s.queryElementsIncludingSelf(e,"[data-pac-bind]").forEach(e=>{const i=e.getAttribute("data-pac-bind");i&&l.parseBindingString(i).filter(({type:e})=>"foreach"!==e).forEach(({type:i,target:r})=>{if(this.isInForeachContext(t)&&this.processForeachChildBinding(e,i,r,t))return;const s=d.parseExpression(r),a=l.evaluate(s,n);this.updateBindingDirect(e,i,a)})})},processForeachChildBinding(e,t,n,i){if("value"===t||"checked"===t){const r=s.createScopedContext("foreach",this.abstraction,i),a=l.evaluate(d.parseExpression(n),r);this.updateBindingDirect(e,t,a);const o=this.resolveForeachPropertyPath(n,i);return this.setupInputElement(e,o,t),!0}if(s.isEventType(t)){const r=this.getParentBindingFromContext(i);return this.handleEventBinding(e,t,n,i[r.itemName],i[r.indexName]),!0}return!1},resolveForeachPropertyPath(e,t){if(a.isNested(e,t)){const n=this.findNearestForeachContext(t);if(!n)return e;const i=Object.getOwnPropertyNames(n).filter(e=>"_contextType"!==e),r=this.findMatchingForeachBinding(i);if(!r)return e;const s=n[r.itemName],o=n[r.indexName],c=Object.keys(this.abstraction).find(e=>Array.isArray(this.abstraction[e])&&this.abstraction[e].includes(s))||r.collection;return a.buildNestedPropertyPath(e,t,c,o)}return e},setupEventHandling(){const e=e=>{this.handleEvent(e)};i.forEach(t=>{this.container.addEventListener(t,e,!0),this.eventListeners.set(t,e)})},handleEvent(e){const{type:t,target:n}=e,i=n.getAttribute("data-pac-property");!i||"input"!==t&&"change"!==t||this.handleInputEvent(e,n,i),this.handleCustomEvent(e,t,n)},handleInputEvent(e,t,n){const i=t.getAttribute("data-pac-update-mode")||this.config.updateMode,r=this.readDOMValue(t);switch(i){case"immediate":a.set(p,n,r);break;case"delayed":this.handleDelayedUpdate(t,n,r);break;case"change":"change"===e.type&&a.set(p,n,r)}},handleCustomEvent(e,t,n){let i=n;if("submit"===t&&"FORM"!==n.tagName&&(i=n.closest("form"),!i))return;const r=this.parseEventModifiers(n);this.validateEventModifiers(e,r)&&this.bindings.forEach(i=>{if("event"===i.type&&i.eventType===t&&(i.element===n||i.element.contains(n))){const t=this.abstraction[i.method];if("function"==typeof t)try{t.call(this.abstraction,e)}catch(e){}}})},handleEventBinding(e,t,n,i,r){e.addEventListener(t,e=>{const t=this.abstraction[n];"function"==typeof t&&t.call(this.abstraction,i,r,e)})},parseEventModifiers(e){const t=e.getAttribute("data-pac-event");return t?t.trim().split(/\s+/).filter(e=>e.length>0):[]},validateEventModifiers(e,t){let n=!1,i=!1;for(const s of t)switch(s.toLowerCase()){case"prevent":e.preventDefault();break;case"stop":e.stopPropagation();break;default:{const t=r[s.toLowerCase()];if(!t)continue;n=!0,Array.isArray(t)?t.includes(e.key)&&(i=!0):e.key===t&&(i=!0);break}}return!n||i},handleDelayedUpdate(e,t,n){const i=parseInt(e.getAttribute("data-pac-update-delay"))||this.config.delay,r="delayed_"+t;this.updateTimeouts.has(r)&&clearTimeout(this.updateTimeouts.get(r));const s=setTimeout(()=>{this.abstraction[t]=n,this.updateTimeouts.delete(r)},i);this.updateTimeouts.set(r,s)},notifyChange(e,t,n,i={}){if(!this.abstraction)return;const r=e.split(".")[0];this.triggerWatcher(r,t,i.oldValue,e),this.updateComputedProperties(r),this.scheduleUpdate(e,t),e!==r&&this.propagateNestedChange(r,this.abstraction[r],"nested-change",{nestedPath:e,newValue:t,oldValue:i.oldValue})},propagateNestedChange(e,t,n,i){this.triggerWatcher(e,t,i.oldValue,i.nestedPath),this.updateComputedProperties(e),this.scheduleUpdate(e,t)},applyVisibilityBinding(e,t){const n=e.element;if(t)n.hasAttribute("data-pac-hidden")&&(n.style.display=n.getAttribute("data-pac-orig-display")||"",n.removeAttribute("data-pac-hidden"),n.removeAttribute("data-pac-orig-display"));else if(!n.hasAttribute("data-pac-hidden")){const e=getComputedStyle(n).display;"none"!==e&&n.setAttribute("data-pac-orig-display",e),n.style.display="none",n.setAttribute("data-pac-hidden","true")}},applyConditionalBinding(e,t){if(e.isRendered===t)return;const{element:n,placeholder:i}=e;if(t)return i?.parentNode?.replaceChild(n,i),void(e.isRendered=!0);e.placeholder||(e.placeholder=document.createComment("pac-if: "+e.target)),n.parentNode?.replaceChild(e.placeholder,n),e.isRendered=!1},applyAttributeBinding(e,t){const i=e.element,r=e.attribute;"style"===r?"object"==typeof t&&t?Object.assign(i.style,t):i.style.cssText=t||"":"enable"===r?i.toggleAttribute("disabled",!t):n.includes(r)?i.toggleAttribute(r,!!t):null!=t?i.setAttribute(r,t):i.removeAttribute(r)},applyInputBinding(e,t){const n=e.element,i=(n.getAttribute("type")||"").toLowerCase(),r=String(t??"");"radio"!==i?"checkbox"!==i?"value"in n&&n.value!==r&&(n.value=r):n.checked=Boolean(t):n.checked=n.value===r},applyClassBinding(e,t){const n=e.element,i=n.dataset.pacPreviousClasses;i&&i.split(" ").forEach(e=>{e.trim()&&n.classList.remove(e.trim())});const r=this.parseClassValue(t);r.forEach(e=>n.classList.add(e)),n.dataset.pacPreviousClasses=r.join(" ")},applyStyleBinding(e,t){const n=e.element;"object"!=typeof t||null===t||Array.isArray(t)?"string"==typeof t&&(n.style.cssText=t):Object.keys(t).forEach(e=>{null!=t[e]&&(e.startsWith("--")?n.style.setProperty(e,t[e]):n.style[e]=t[e])})},applyTextBinding(e,t,n=null){const i=e.element,r=e.contextVars||n||this.abstraction,s=this.processTextInterpolation(e.originalText,r),a="text_"+e.id;this.lastValues.get(a)!==s&&(this.lastValues.set(a,s),i.textContent=s)},applyForeachBinding(e,t,n=null){if(!this.shouldUpdateForeach(e,t))return;const i=this.validateForeachBinding(e);if(!i)return;const r=this.getForeachArrayData(i,n);Array.isArray(r)&&(this.cleanupForeachContainer(i),this.renderForeachItems(i,r,n))},shouldUpdateForeach(e,t){return!t||e.collection===t||!!e.target?.includes(".")&&this.isComputedPropertyAffected(e.target,t)},isComputedPropertyAffected(e,t){const n=e.split(".")[0];return n===t||!!this.deps?.has(n)&&(this.deps.get(n).dependencies||[]).includes(t)},validateForeachBinding(e){const t=this.findBindingWithTemplate(e);return t&&t.element&&t.itemName&&t.indexName?t:null},getForeachArrayData(e,t){const n=t||this.abstraction,i=e.target||e.collection;try{if(i.includes("."))return a.resolveComputedPath(this,i);{const e=d.parseExpression(i);return l.evaluate(e,n)}}catch(e){return[]}},cleanupForeachContainer(e){this.cleanupForeachTextBindings(e),e.element.innerHTML=""},renderForeachItems(e,t,n){if(0===t.length||!e.template?.length)return;const i=n||this.abstraction,r=document.createDocumentFragment();t.forEach((t,n)=>{const s=this.createForeachItem(e,t,n,i);s&&r.appendChild(s)}),e.element.appendChild(r)},createForeachItem(e,t,n,i){try{const r=this.createForeachItemElement(e.template),a=s.createScopedContext("foreach",i,{[e.itemName]:t,[e.indexName]:n});return this.processTextBindingsForElement(r,a),this.processElementAttributeBindings(r,a),r}catch(e){return null}},parseClassValue(e){if(e&&"object"==typeof e&&!Array.isArray(e))return Object.entries(e).filter(([e,t])=>t&&e.trim()).map(([e])=>e.trim());if("string"==typeof e)return e.trim().split(/\s+/).filter(Boolean);if(e){const t=String(e).trim();return t?[t]:[]}return[]},readDOMValue:e=>{let t;if(t="string"!=typeof e?e&&e.nodeType?e:null:e.startsWith("#")?document.getElementById(e.slice(1)):document.querySelector(e),!t)return!1;switch(!0){case"SELECT"===t.tagName:return t.value;case"checkbox"===t.type:return t.checked;case"radio"===t.type:{const e=document.querySelector('input[name="'+t.name+'"]:checked');return e?e.value:""}case"INPUT"===t.tagName||"TEXTAREA"===t.tagName:return t.value;default:return t.textContent||t.innerText}},writeDOMValue:(e,t)=>{let n;if(n="string"!=typeof e?e&&e.nodeType?e:null:e.startsWith("#")?document.getElementById(e.slice(1)):document.querySelector(e),!n)return!1;switch(!0){case"SELECT"===n.tagName:return n.value=t,n.dispatchEvent(new Event("change",{bubbles:!0})),!0;case"checkbox"===n.type:return n.checked=Boolean(t),n.dispatchEvent(new Event("change",{bubbles:!0})),!0;case"radio"===n.type:{const e=document.querySelector('input[name="'+n.name+'"][value="'+t+'"]');return!!e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),!0)}case"INPUT"===n.tagName||"TEXTAREA"===n.tagName:return n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),!0;default:return n.textContent=t,!0}},isInForeachContext(e){if(!e)return!1;let t=e;for(;t;){if("foreach"===t._contextType)return!0;t=Object.getPrototypeOf(t)}return!1},findNearestForeachContext(e){if(!e)return null;let t=e;for(;t;){if("foreach"===t._contextType)return t;t=Object.getPrototypeOf(t)}return null},getParentBindingFromContext(e){const t=this.findNearestForeachContext(e);if(!t)return null;const n=Object.getOwnPropertyNames(t);return this.findMatchingForeachBinding(n)},findMatchingForeachBinding(e){for(const t of this.bindings.values())if("foreach"===t.type&&t.itemName&&t.indexName&&e.includes(t.itemName)&&e.includes(t.indexName))return t;return null},handleComputedForeachDependencies(){this.bindings.forEach(e=>{if("foreach"===e.type&&e.target&&e.target.includes(".")){const t=e.target.split(".")[0];if(this.deps&&this.deps.has(t)){const n=this.deps.get(t);n&&n.fn&&(n.dependencies||[]).forEach(t=>{this.bindingIndex.has(t)||this.bindingIndex.set(t,new Set),this.bindingIndex.get(t).add(e),e.dependencies||(e.dependencies=[]),e.dependencies.includes(t)||e.dependencies.push(t)})}}})},cleanupForeachTextBindings(e){const t=e.element,n=[];this.bindings.forEach(e=>{"text"===e.type&&e.element&&t.contains(e.element)&&n.push(e)}),n.forEach(e=>{this.removeBinding(e)})},removeBinding(e){this.bindings.delete(e.id),e.dependencies&&e.dependencies.forEach(t=>{const n=this.bindingIndex.get(t);n&&(n.delete(e),0===n.size&&this.bindingIndex.delete(t))})},establishHierarchy(){const{parent:e,children:t}=window.PACRegistry.getHierarchy(this.container);this.updateParentRelationship(e),this.updateChildrenRelationships(t),this.updateReactiveProperties()},updateParentRelationship(e){this.parent!==e&&(this.parent&&this.parent.children.delete(this),this.parent=e,e&&e.children.add(this))},updateChildrenRelationships(e){this.children.clear(),e.forEach(e=>{e.parent&&e.parent!==this&&e.parent.children.delete(e),e.parent=this,this.children.add(e)})},updateReactiveProperties(){this.abstraction&&(this.abstraction.childrenCount=this.children.size,this.abstraction.hasParent=!!this.parent)},notifyParent(e,t){this.parent&&"function"==typeof this.parent.receiveUpdate&&this.parent.receiveUpdate(e,t,this)},receiveUpdate(e,t,n){this.abstraction.receiveFromChild&&this.abstraction.receiveFromChild(e,t,n),this.container.dispatchEvent(new CustomEvent("pac:childupdate",{detail:{eventType:e,data:t,childPAC:n},bubbles:!0}))},receiveFromParent(e,t){this.abstraction.receiveFromParent&&this.abstraction.receiveFromParent(e,t),this.container.dispatchEvent(new CustomEvent("pac:parentcommand",{detail:{command:e,data:t},bubbles:!0}))},notifyChildren(e,t){this.children.forEach(n=>{"function"==typeof n.receiveFromParent&&n.receiveFromParent(e,t)})},notifyChild(e,t,n){const i=Array.from(this.children).find(t=>t.container.matches(e));i&&i.receiveFromParent&&i.receiveFromParent(t,n)},findBindingWithTemplate(e){if(e.template&&e.template.length>0)return e;let t=null;return window.PACRegistry&&window.PACRegistry.components&&window.PACRegistry.components.forEach(n=>{if(t)return;const i=Array.from(n.bindings.values()).find(t=>"foreach"===t.type&&t.collection===e.collection&&t.template&&t.template.length>0);i&&(t=i)}),t},findDataSource(e){let t=this.abstraction;const n=e.target||e.collection;if(!(n in this.abstraction)){for(const e of this.children)if(e.abstraction&&n in e.abstraction){t=e.abstraction;break}!(n in t)&&window.PACRegistry&&window.PACRegistry.components.forEach(e=>{e.abstraction&&n in e.abstraction&&(t=e.abstraction)})}return t},makeHttpRequest(e,t={}){const n=this.validateAndNormalizeConfig(e,t);this._requestGroups||(this._requestGroups=new Map);const i=this.setupRequestState(n),r=n.timeout>0?this.createTimeoutPromise(n.timeout,i.controller):null,s=this.executeFetch(n,i).then(e=>this.processResponse(e,n,i)).then(e=>this.handleSuccess(e,n,i)).catch(e=>this.handleError(e,n));return(r?Promise.race([s,r]):s).finally(()=>{this.cleanupRequest(n.groupKey,i.token)})},validateAndNormalizeConfig(e,t){if(!e||"string"!=typeof e)throw new Error("URL must be a non-empty string");this.validateCallbacks(t),this.validateAbortControls(t);const{method:n,body:i}=this.normalizeMethodAndBody(t),r=this.buildHeaders(t,i),s=this.buildFetchPassthrough(t);return{url:e,method:n,headers:r,body:i,groupKey:t.groupKey??(t.latestOnly?this.getGroupKeyFromUrl(e,t):null),fetchOptions:s,timeout:Math.max(0,parseInt(t.timeout)||3e4),ignoreAbort:!!t.ignoreAbort,validateStatus:t.validateStatus||(e=>e.ok),responseType:t.responseType||"auto",onSuccess:t.onSuccess,onError:t.onError,onProgress:t.onProgress,abortController:t.abortController}},validateCallbacks(e){[["onSuccess",e.onSuccess],["onError",e.onError],["onProgress",e.onProgress],["urlNormalizer",e.urlNormalizer]].forEach(([e,t])=>{if(t&&"function"!=typeof t)throw new Error(`${e} must be a function`)})},validateAbortControls(e){if(e.abortController&&"function"!=typeof e.abortController.abort)throw new Error("abortController must have an abort method")},normalizeMethodAndBody(e){const t=(e.method||"GET").toUpperCase();if(["GET","HEAD"].includes(t))return e.data,{method:t};let n;return void 0!==e.data&&(n="object"!=typeof e.data||e.data instanceof FormData||e.data instanceof Blob||e.data instanceof ArrayBuffer?JSON.stringify(e.data):e.data),{method:t,body:n}},buildHeaders(e,t){const n=new Headers;n.set("X-PAC-Request","true"),void 0!==t&&(t instanceof FormData||(t instanceof Blob||t instanceof ArrayBuffer?n.set("Content-Type","application/octet-stream"):"string"==typeof t?n.set("Content-Type","text/plain; charset=utf-8"):n.set("Content-Type","application/json; charset=utf-8")));const i=e.headers||{};return Object.keys(i).some(e=>"accept"===e.toLowerCase())||n.set("Accept","application/json, text/plain, */*"),Object.entries(i).forEach(([e,t])=>{n.set(e,t)}),n},buildFetchPassthrough(e){const t={};return["credentials","mode","cache","redirect","referrer","referrerPolicy","integrity","keepalive","priority"].forEach(n=>{void 0!==e[n]&&(t[n]=e[n])}),t},getGroupKeyFromUrl(e,t){return t.urlNormalizer?t.urlNormalizer(e):this.normalizeUrlForGrouping(e,t.baseUrl)},normalizeUrlForGrouping(e,t){try{let n;n="undefined"!=typeof globalThis&&globalThis.location?t||globalThis.location.origin:t||"http://localhost";const i=new URL(e,n);i.hash="";const r=new URLSearchParams(i.search),s=new URLSearchParams;return[...r.keys()].sort().forEach(e=>{r.getAll(e).sort().forEach(t=>{s.append(e,t)})}),i.search=s.toString(),i.toString()}catch{return e}},setupRequestState(e){const t=this.createCombinedController(e);let n=0;if(e.groupKey){const i=this._requestGroups.get(e.groupKey);i?(i.controller&&!i.controller.signal.aborted&&i.controller.abort(),n=i.token+1):n=1,this._requestGroups.set(e.groupKey,{token:n,controller:t})}return{token:n,controller:t,groupKey:e.groupKey}},createCombinedController:e=>e.abortController?e.abortController:new AbortController,createTimeoutPromise(e,t){return new Promise((n,i)=>{if(t.signal.aborted)return void i(this.createTaggedCancellationError("Request was cancelled before timeout","timeout"));const r=setTimeout(()=>{t.signal.aborted||(t.abort(),i(this.createTaggedCancellationError(`Request timeout after ${e}ms`,"timeout")))},e);t.signal.addEventListener("abort",()=>clearTimeout(r),{once:!0})})},async executeFetch(e,t){if(t.controller.signal.aborted)throw this.createTaggedCancellationError("Request was cancelled before execution","cancelled");const n={method:e.method,headers:e.headers,body:e.body,signal:t.controller.signal,...e.fetchOptions};try{return await fetch(e.url,n)}catch(e){throw"TypeError"!==e.name||t.controller.signal.aborted||(e.network=!0),e}},async processResponse(e,t,n){if(n.controller.signal.aborted)throw this.createTaggedCancellationError("Request was cancelled during processing","cancelled");if(!t.validateStatus(e)){const t=await this.safeGetResponseText(e);throw new Error(`HTTP ${e.status}: ${e.statusText}${t?` - ${t}`:""}`)}if("HEAD"!==t.method&&![204,205,304].includes(e.status))return this.parseResponse(e,t.responseType)},async parseResponse(e,t){try{switch(t){case"json":return await e.json();case"text":return await e.text();case"blob":return await e.blob();case"response":return e;default:return this.autoParseResponse(e)}}catch(e){throw new Error(`Failed to parse response as ${t}: ${e.message}`)}},async autoParseResponse(e){const t=e.headers.get("content-type")||"";if("0"!==e.headers.get("content-length")){if(/json|\+json/i.test(t)){const t=await e.text();return t.trim()?JSON.parse(t):void 0}return/^text\//i.test(t)?e.text():e.blob()}},async safeGetResponseText(e){try{if(e.bodyUsed)return null;const t=e.clone();return(await t.text()).substring(0,200)}catch{return null}},handleSuccess(e,t,n){if(n.controller.signal.aborted){if(t.ignoreAbort)return;throw this.createTaggedCancellationError("Request was cancelled","cancelled")}if(t.onSuccess)try{const n=this.abstraction||this;t.onSuccess.call(n,e)}catch(e){}return e},handleError(e,t){if(!this.isCancellationError(e)||!t.ignoreAbort){if(t.onError)try{const n=this.abstraction||this;t.onError.call(n,e)}catch(e){}throw e}},createTaggedCancellationError(e,t){const n=new Error(e);return n.name="CancellationError",n.cancellationType=t,n},isCancellationError:e=>"AbortError"===e.name||"CancellationError"===e.name||!!e.cancellationType&&["timeout","cancelled","superseded"].includes(e.cancellationType),cleanupRequest(e,t){if(!e)return;const n=this._requestGroups.get(e);n&&(n.token===t||n.token<t)&&this._requestGroups.delete(e)},serializeToJSON(){const e={},t=this.original.computed?Object.keys(this.original.computed):[];return Object.keys(this.abstraction).forEach(n=>{const i=this.abstraction[n];void 0===i||"function"==typeof i||t.includes(n)||(e[n]=i)}),e},destroy(){this._clearCollections(),this._unregisterFromGlobalRegistry(),this._cleanupHierarchy(),this._cleanupReactiveReferences(),this._removeEventListeners(),this._cleanupViewportTracking(),this._nullifyReferences()},_clearCollections(){this.updateTimeouts.forEach(e=>clearTimeout(e)),this.updateTimeouts.clear(),this.deps.clear(),this.lastValues.clear(),this.bindings.clear(),this.bindingIndex.clear(),this.children.clear(),this.eventListeners.clear()},_unregisterFromGlobalRegistry(){window.PACRegistry.unregister(this.selector),window._wakaPACGlobalHandlers&&0===window.PACRegistry.components.size&&(document.removeEventListener("visibilitychange",window._wakaPACGlobalHandlers.visibility),document.removeEventListener("keydown",window._wakaPACGlobalHandlers.keyboard_message,!0),document.removeEventListener("keyup",window._wakaPACGlobalHandlers.keyboard_message,!0),document.removeEventListener("mousedown",window._wakaPACGlobalHandlers.mouse_message,!0),document.removeEventListener("mouseup",window._wakaPACGlobalHandlers.mouse_message,!0),document.removeEventListener("focusin",window._wakaPACGlobalHandlers.focusin_message,!0),document.removeEventListener("focusout",window._wakaPACGlobalHandlers.focusout_message,!0),window.removeEventListener("online",window._wakaPACGlobalHandlers.online),window.removeEventListener("offline",window._wakaPACGlobalHandlers.offline),window.removeEventListener("scroll",window._wakaPACGlobalHandlers.scroll),window.removeEventListener("resize",window._wakaPACGlobalHandlers.resize),"connection"in navigator&&navigator.connection&&navigator.connection.removeEventListener("change",window._wakaPACGlobalHandlers.connectionChange),delete window._wakaPACGlobalHandlers,delete window._wakaPACBrowserListeners,window._wakaPACScrollTimeout&&clearTimeout(window._wakaPACScrollTimeout),window._wakaPACResizeTimeout&&clearTimeout(window._wakaPACResizeTimeout))},_cleanupHierarchy(){this.parent&&this.parent.children.delete(this),this.children.forEach(e=>{e.parent===this&&(e.parent=null)}),this.parent=null,this.children.clear()},_cleanupReactiveReferences(){this.abstraction&&Object.keys(this.abstraction).forEach(e=>{const t=this.abstraction[e];"function"==typeof t&&t.name.includes("bound")&&(this.abstraction[e]=null)})},_removeEventListeners(){this.eventListeners?.forEach((e,t)=>{this.container?.removeEventListener(t,e,!0)}),this.complexChangeHandler&&(this.container?.removeEventListener("pac:complex-change",this.complexChangeHandler),this.complexChangeHandler=null),this.eventListeners?.clear(),this.containerScrollHandler&&(this.container?.removeEventListener("scroll",this.containerScrollHandler),this.containerScrollHandler=null)},_cleanupViewportTracking(){this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),window._wakaPACViewportComponents&&window._wakaPACViewportComponents.delete(this)},_nullifyReferences(){this.abstraction=null,this.container=null}},g=function(e){const t={};return Object.keys(e.abstraction).forEach(n=>{const i=Object.getOwnPropertyDescriptor(e.abstraction,n);i&&Object.defineProperty(t,n,i)}),Object.assign(t,{control:(e,t={})=>p.makeHttpRequest(e,t),toJSON:()=>p.serializeToJSON(),getElementPosition:e=>s.getElementPosition(e),destroy:()=>p.destroy()}),t}(p.initialize());return window.PACRegistry.register(e,p),document.dispatchEvent(new CustomEvent("pac:component-ready",{detail:{component:p,selector:e}})),g}window.PACRegistry=window.PACRegistry||new c,window._wakaPACHierarchyListener||(window._wakaPACHierarchyListener=!0,document.addEventListener("pac:component-ready",()=>{clearTimeout(window._wakaPACHierarchyTimeout),window._wakaPACHierarchyTimeout=setTimeout(()=>{window.PACRegistry.hierarchyCache=new WeakMap,window.PACRegistry.components.forEach(e=>{e.establishHierarchy()})},20)})),window.wakaPAC=h,"undefined"!=typeof module&&module.exports&&(module.exports={wakaPAC:h,ComponentRegistry:c,Utils:s})}();