!function(){"use strict";const e={tokens:[],currentToken:0,OPERATOR_PRECEDENCE:{"||":1,"&&":2,"===":6,"!==":6,"==":6,"!=":6,"<":7,">":7,"<=":7,">=":7,"+":8,"-":8,"*":9,"/":9,"%":9,"!":10,"unary-":10,"unary+":10},OPERATOR_TYPES:{"||":"logical","&&":"logical","===":"comparison","!==":"comparison","==":"comparison","!=":"comparison",">=":"comparison","<=":"comparison",">":"comparison","<":"comparison","+":"arithmetic","-":"arithmetic","*":"arithmetic","/":"arithmetic","%":"arithmetic"},parseExpression(e){if("object"==typeof e&&null!==e){if(e.dependencies)return e;const t=this.extractDependencies(e);return Object.assign({},e,{dependencies:t})}e=String(e).trim();try{if(this.tokens=this.tokenize(e),this.currentToken=0,0===this.tokens.length)return null;const t=this.parseTernary();return t&&(t.dependencies=this.extractDependencies(t)),t}catch(t){throw new Error(`Expression parsing failed: "${e}"\nOriginal error: ${t.message}`)}},tokenize(e){const t=[];let r=0;for(;r<e.length;){const n=e[r];if(/\s/.test(n)){r++;continue}if('"'===n||"'"===n){const n=this.tokenizeString(e,r);t.push(n.token),r=n.nextIndex;continue}if(/\d/.test(n)||"."===n&&/\d/.test(e[r+1])){const n=this.tokenizeNumber(e,r);t.push(n.token),r=n.nextIndex;continue}const s=/^(===|!==|==|!=|>=|<=|&&|\|\|)/.exec(e.slice(r));if(s){const e=s[1];t.push({type:"OPERATOR",value:e,precedence:this.getOperatorPrecedence(e)}),r+=e.length;continue}const i={"(":"LPAREN",")":"RPAREN","{":"LBRACE","}":"RBRACE","[":"LBRACKET","]":"RBRACKET",",":"COMMA",".":"DOT"};if(i[n])t.push({type:i[n],value:n}),r++;else{if("+-*/<>!?:%".includes(n)){const e=this.getOperatorPrecedence(n);let s="?"===n?"QUESTION":":"===n?"COLON":"OPERATOR";t.push({type:s,value:n,precedence:e}),r++;continue}if(/[a-zA-Z_$]/.test(n)){const n=this.tokenizeIdentifier(e,r);t.push(n.token),r=n.nextIndex;continue}r++}}return t},tokenizeString(e,t){const r=e[t];let n=t+1,s="";for(;n<e.length;){const t=e[n];if("\\"===t&&n+1<e.length){const i=e[n+1];i===r||"\\"===i?(s+=i,n+=2):(s+=t,n++)}else{if(t===r)return{token:{type:"STRING",value:s},nextIndex:n+1};s+=t,n++}}throw new Error(`Unterminated string literal starting at position ${t}`)},tokenizeNumber(e,t){const r=/^(\d*\.?\d+(?:[eE][+-]?\d+)?)/.exec(e.slice(t));if(r)return{token:{type:"NUMBER",value:parseFloat(r[1])},nextIndex:t+r[1].length}},tokenizeIdentifier(e,t){const r=/^([a-zA-Z_$][a-zA-Z0-9_$]*)/.exec(e.slice(t));if(r){const e=r[1];return{token:{type:["true","false","null","undefined"].includes(e)?"KEYWORD":"IDENTIFIER",value:e},nextIndex:t+e.length}}},getOperatorPrecedence(e){return this.OPERATOR_PRECEDENCE[e]||0},parseTernary(){let e=this.parseBinaryWithPrecedence(1);if(this.match("QUESTION")){const t=this.parseTernary();return this.consume("COLON",'Expected ":" in ternary expression'),{type:"ternary",condition:e,trueValue:t,falseValue:this.parseTernary()}}return e},parseBinaryWithPrecedence(e){let t=this.parseUnary();for(;"OPERATOR"===this.peek().type;){const r=this.getOperatorPrecedence(this.peek().value);if(r<e)break;const n=this.advance().value,s=this.parseBinaryWithPrecedence(r+1);t={type:this.OPERATOR_TYPES[n]||"arithmetic",left:t,operator:n,right:s}}return t},parseUnary(){return this.matchOperator("!","-","+")?{type:"unary",operator:this.previous().value,operand:this.parseUnary()}:this.parsePrimary()},parsePrimary(){if(this.match("LPAREN")){const e=this.parseTernary();return this.consume("RPAREN","Expected closing parenthesis"),{type:"parentheses",inner:e}}return this.match("LBRACE")?this.parseObjectLiteral():this.check("STRING")||this.check("NUMBER")?{type:"literal",value:this.advance().value}:this.check("KEYWORD")?{type:"literal",value:{true:!0,false:!1,null:null,undefined:void 0}[this.advance().value]}:this.check("IDENTIFIER")?this.parsePropertyAccess():null},parseObjectLiteral(){const e=[];if(!this.check("RBRACE"))do{let t;if(this.check("STRING"))t=this.advance().value;else{if(!this.check("IDENTIFIER"))throw new Error("Expected property name");t=this.advance().value}this.consume("COLON",'Expected ":" after object key');const r=this.parseTernary();e.push({key:t,value:r})}while(this.match("COMMA")&&!this.check("RBRACE"));return this.consume("RBRACE","Expected closing brace"),{type:"object",pairs:e}},parsePropertyAccess(){let e=this.advance().value;for(;;)if(this.match("DOT")){if(!this.check("IDENTIFIER"))throw new Error('Expected property name after "."');e+="."+this.advance().value}else{if(!this.match("LBRACKET"))break;{const t=this.parseTernary();this.consume("RBRACKET","Expected closing bracket"),"literal"===t.type?e+="["+JSON.stringify(t.value)+"]":e+="["+this.reconstructExpression(t)+"]"}}return{type:"property",path:e}},reconstructExpression(e){if(!e)return"";switch(e.type){case"literal":return"string"==typeof e.value?'"'+e.value+'"':String(e.value);case"property":return e.path;case"arithmetic":return`${this.reconstructExpression(e.left)} ${e.operator} ${this.reconstructExpression(e.right)}`;default:return"unknown"}},match(...e){for(const t of e)if(this.check(t))return this.advance(),!0;return!1},matchOperator(...e){if(this.check("OPERATOR")){const t=this.peek();if(e.includes(t.value))return this.advance(),!0}return!1},check(e){return!this.isAtEnd()&&this.peek().type===e},advance(){return this.isAtEnd()||this.currentToken++,this.previous()},isAtEnd(){return this.currentToken>=this.tokens.length},peek(){return this.tokens[this.currentToken]||{type:"EOF",value:null}},previous(){return this.tokens[this.currentToken-1]},consume(e,t){if(this.check(e))return this.advance();throw new Error(t+` at token: ${JSON.stringify(this.peek())}`)},evaluate(e,t){if(e)switch(e.type){case"literal":return e.value;case"property":return this.getProperty(t,e.path);case"parentheses":return this.evaluate(e.inner,t);case"object":return this.evaluateObjectLiteral(e,t);case"ternary":return this.evaluate(e.condition,t)?this.evaluate(e.trueValue,t):this.evaluate(e.falseValue,t);case"logical":{const r=this.evaluate(e.left,t);return"&&"===e.operator?!!r&&this.evaluate(e.right,t):"||"===e.operator&&(!!r||this.evaluate(e.right,t))}case"comparison":case"arithmetic":{const r=this.evaluate(e.left,t),n=this.evaluate(e.right,t);return this.performOperation(r,e.operator,n)}case"unary":{const r=this.evaluate(e.operand,t);switch(e.operator){case"!":return!r;case"-":return-r;case"+":return+r;default:return r}}default:return}},getProperty(e,t){if(!e||!t)return;if(-1===t.indexOf("."))return e[t];const r=t.split(".");let n=e;for(let e=0;e<r.length;e++){if(null==n)return;n=n[r[e]]}return n},evaluateObjectLiteral(e,t){const r={};return e.pairs&&e.pairs.forEach(({key:e,value:n})=>{r[e]=this.evaluate(n,t)}),r},performOperation(e,t,r){switch(t){case"+":return e+r;case"-":return Number(e)-Number(r);case"*":return Number(e)*Number(r);case"/":return Number(e)/Number(r);case"%":return Number(e)%Number(r);case"===":return e===r;case"!==":return e!==r;case"==":return e==r;case"!=":return e!=r;case">=":return e>=r;case"<=":return e<=r;case">":return e>r;case"<":return e<r;default:return!1}},extractDependencies(e){if(!e)return[];const t=new Set,r=e=>{if(e)switch(e.type){case"property":{const r=e.path.split(/[.[]/,1)[0];r&&!["true","false","null","undefined"].includes(r)&&t.add(r);break}case"ternary":r(e.condition),r(e.trueValue),r(e.falseValue);break;case"logical":case"comparison":case"arithmetic":r(e.left),r(e.right);break;case"unary":r(e.operand);break;case"parentheses":r(e.inner);break;case"object":e.pairs&&e.pairs.forEach(e=>r(e.value))}};return r(e),Array.from(t)}},t={cache:new Map,maxSize:500,parseExpression(t){const r=String(t).trim();if(this.cache.has(r)){const e=this.cache.get(r);return this.cache.delete(r),this.cache.set(r,e),e}const n=e.parseExpression(t);if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}return this.cache.set(r,n),n}};function r(e){const t=["push","pop","shift","unshift","splice","sort","reverse"];function r(t,r,n){e.dispatchEvent(new CustomEvent("property:changed",{detail:{path:t,newValue:r,oldValue:n}}))}this.makeReactive=function(e,n=[]){if(null===e||"object"!=typeof e)return e;const s=this;return new Proxy(e,{get(e,i){const a=e[i];if(Array.isArray(e)&&t.includes(i))return function(...t){const s=Array.prototype[i].apply(e,t);return r([...n],e),s};if(a&&"object"==typeof a&&!a._isReactive){const t=s.makeReactive(a,[...n,i]);t._isReactive=!0,e[i]=t}return e[i]},set(e,t,i){const a=e[t];if(a===i)return!0;if(i&&"object"==typeof i){const r=s.makeReactive(i,[...n,t]);r._isReactive=!0,e[t]=r}else e[t]=i;return r([...n,t],i,a),!0}})}}function n(e,t){const r=new Map,n=new Map,s=new Set;Object.keys(t).forEach(i=>{const a=t[i],c=function(e){const t=e.toString().match(/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g)||[];return[...new Set(t.map(e=>e.replace("this.","")))]}(a);n.set(i,{fn:a,dependencies:c,isDirty:!0,lastValue:void 0}),Object.defineProperty(e,i,{get(){const e=n.get(i);if(e.isDirty||!r.has(i)){const t=e.fn.call(this),n=e.lastValue;r.set(i,t),e.isDirty=!1,e.lastValue=t,n!==t&&s.forEach(e=>{e(i,t,n)})}return r.get(i)},enumerable:!0})}),this.invalidateComputed=function(t){const r=[];return n.forEach((n,s)=>{n.dependencies.includes(t)&&(n.isDirty=!0,r.push(s),e[s])}),r},this.addChangeListener=function(e){s.add(e)},this.removeChangeListener=function(e){s.delete(e)}}function s(r,n,s){const i=new Map,a=new WeakMap;function c(r){const s=a.get(r);if(!s)return;const i=e.evaluate(s.parsed,n);!function(r,s,i,a){switch(s){case"text":const c=function(r,n){let s=String(r||"");const i=s.match(/\{\{\s*([^}]+)\s*}}/g);if(i)for(const r of i){const i=r.replace(/^\{\{\s*|\s*}}$/g,"").trim();try{const a=t.parseExpression(i),c=e.evaluate(a,n),o=null!=c?String(c):"";s=s.replace(r,o)}catch(e){}}return s}(a.originalText,n);r.textContent!==c&&(r.textContent=c);break;case"visible":if(i)r.hasAttribute("data-hidden")&&(r.style.display=r.getAttribute("data-orig-display")||"",r.removeAttribute("data-hidden"),r.removeAttribute("data-orig-display"));else if(!r.hasAttribute("data-hidden")){const e=getComputedStyle(r).display;"none"!==e&&r.setAttribute("data-orig-display",e),r.style.display="none",r.setAttribute("data-hidden","true")}break;case"value":const o=String(i||"");"value"in r&&r.value!==o&&(r.value=o);break;case"checked":r.checked=Boolean(i);break;default:["readonly","required","selected","checked","hidden","multiple"].includes(s)?r.toggleAttribute(s,!!i):null!=i?r.setAttribute(s,i):r.removeAttribute(s)}}(r,s.type,i,s)}this.subscribe=function(e,t,r){i.has(t)||i.set(t,new Set),i.get(t).add(e),a.set(e,r)},this.handleChange=function(e){const t=e[0];s.invalidateComputed(t);const r=i.get(t)||new Set;r.forEach(e=>{e.isConnected?c(e):r.delete(e)})},s.addChangeListener((e,t,r)=>{const n=i.get(e)||new Set;n.forEach(e=>{e.isConnected?c(e):n.delete(e)})})}window.PACRegistry=window.PACRegistry||new function(){this.components=new Map,this.register=function(e,t){this.components.set(e,t)},this.unregister=function(e){this.components.delete(e)}},window.wakaPAC=function(e,i,a){i=i||{},a=a||{};const c=document.querySelector(e);if(!c)throw new Error("Container not found: "+e);const o=new r(c).makeReactive(i);Object.keys(i).forEach(e=>{"function"==typeof i[e]&&"computed"!==e&&(o[e]=i[e].bind(o))});const u=new n(o,i.computed||{}),h=new s(c,o,u);function l(e){const t=[],r=["value","checked","visible","if","foreach","class","style","click","change","input","submit","focus","blur","keyup","keydown"];let n="",s=!1,i="",a=0,c=0;for(let o=0;o<e.length;o++){const u=e[o],h=o>0&&"\\"===e[o-1];'"'!==u&&"'"!==u||h||(s?u===i&&(s=!1,i=""):(s=!0,i=u)),s||("("===u?a++:")"===u?a--:"{"===u?c++:"}"===u&&c--),","!==u||s||0!==a||0!==c?n+=u:(p(n.trim(),t,r),n="")}return p(n.trim(),t,r),t}function p(e,t,r){if(!e)return;const n=function(e,t){for(const r of t)if(e.startsWith(r+":"))return r.length;let r=!1,n="",s=0;for(let t=0;t<e.length;t++){const i=e[t],a=t>0&&"\\"===e[t-1];if('"'!==i&&"'"!==i||a||(r?i===n&&(r=!1,n=""):(r=!0,n=i)),!r)if("("===i)s++;else if(")"===i)s--;else if(":"===i&&0===s)return t}return-1}(e,r);-1===n?t.push({type:e,target:""}):t.push({type:e.substring(0,n).trim(),target:e.substring(n+1).trim()})}return function(){const e=document.createTreeWalker(c,NodeFilter.SHOW_TEXT,{acceptNode:e=>/\{\{.*\}\}/.test(e.textContent)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}),r=[];let n;for(;n=e.nextNode();)r.push(n);r.forEach(e=>{const r=e.textContent,n=r.match(/\{\{\s*([^}]+)\s*}}/g);n&&n.forEach(n=>{const s=n.replace(/^\{\{\s*|\s*}}$/g,"").trim(),i=t.parseExpression(s),a=i.dependencies||[],c={type:"text",originalText:r,parsed:i};a.forEach(t=>{h.subscribe(e,t,c)})})})}(),function(){const e=c.querySelectorAll("[data-pac-bind]");Array.from(e).forEach(e=>{l(e.getAttribute("data-pac-bind")).forEach(r=>{if(r.target){const n=t.parseExpression(r.target),s=n.dependencies||[],i={type:r.type,parsed:n};s.forEach(t=>{h.subscribe(e,t,i)})}})})}(),function(){const e=c.querySelectorAll("[data-pac-bind]");Array.from(e).forEach(e=>{l(e.getAttribute("data-pac-bind")).forEach(t=>{"click"===t.type&&t.target&&e.addEventListener("click",function(e){const r=o[t.target];if("function"==typeof r)try{r.call(o,e)}catch(e){}})})})}(),c.addEventListener("property:changed",function(e){h.handleChange(e.detail.path)}),Object.keys(o).filter(e=>"function"!=typeof o[e]&&!e.startsWith("_")).forEach(e=>{h.handleChange([e])}),i.init&&i.init.call(o),o}}();