!function(){"use strict";const e={tokens:[],currentToken:0,OPERATOR_PRECEDENCE:{"||":1,"&&":2,"===":6,"!==":6,"==":6,"!=":6,"<":7,">":7,"<=":7,">=":7,"+":8,"-":8,"*":9,"/":9,"%":9,"!":10,"unary-":10,"unary+":10},OPERATOR_TYPES:{"||":"logical","&&":"logical","===":"comparison","!==":"comparison","==":"comparison","!=":"comparison",">=":"comparison","<=":"comparison",">":"comparison","<":"comparison","+":"arithmetic","-":"arithmetic","*":"arithmetic","/":"arithmetic","%":"arithmetic"},parseExpression(e){if("object"==typeof e&&null!==e){if(e.dependencies)return e;const t=this.extractDependencies(e);return Object.assign({},e,{dependencies:t})}e=String(e).trim();try{if(this.tokens=this.tokenize(e),this.currentToken=0,0===this.tokens.length)return null;const t=this.parseTernary();return t&&(t.dependencies=this.extractDependencies(t)),t}catch(t){throw new Error(`Expression parsing failed: "${e}"\nOriginal error: ${t.message}`)}},tokenize(e){const t=[];let n=0;for(;n<e.length;){const i=e[n];if(/\s/.test(i)){n++;continue}if('"'===i||"'"===i){const i=this.tokenizeString(e,n);t.push(i.token),n=i.nextIndex;continue}if(/\d/.test(i)||"."===i&&/\d/.test(e[n+1])){const i=this.tokenizeNumber(e,n);t.push(i.token),n=i.nextIndex;continue}const r=/^(===|!==|==|!=|>=|<=|&&|\|\|)/.exec(e.slice(n));if(r){const e=r[1];t.push({type:"OPERATOR",value:e,precedence:this.getOperatorPrecedence(e)}),n+=e.length;continue}const s={"(":"LPAREN",")":"RPAREN","{":"LBRACE","}":"RBRACE","[":"LBRACKET","]":"RBRACKET",",":"COMMA",".":"DOT"};if(s[i])t.push({type:s[i],value:i}),n++;else{if("+-*/<>!?:%".includes(i)){const e=this.getOperatorPrecedence(i);let r="?"===i?"QUESTION":":"===i?"COLON":"OPERATOR";t.push({type:r,value:i,precedence:e}),n++;continue}if(/[a-zA-Z_$]/.test(i)){const i=this.tokenizeIdentifier(e,n);t.push(i.token),n=i.nextIndex;continue}n++}}return t},tokenizeString(e,t){const n=e[t];let i=t+1,r="";for(;i<e.length;){const t=e[i];if("\\"===t&&i+1<e.length){const s=e[i+1];s===n||"\\"===s?(r+=s,i+=2):(r+=t,i++)}else{if(t===n)return{token:{type:"STRING",value:r},nextIndex:i+1};r+=t,i++}}throw new Error(`Unterminated string literal starting at position ${t}`)},tokenizeNumber(e,t){const n=/^(\d*\.?\d+(?:[eE][+-]?\d+)?)/.exec(e.slice(t));if(n)return{token:{type:"NUMBER",value:parseFloat(n[1])},nextIndex:t+n[1].length}},tokenizeIdentifier(e,t){const n=/^([a-zA-Z_$][a-zA-Z0-9_$]*)/.exec(e.slice(t));if(n){const e=n[1];return{token:{type:["true","false","null","undefined"].includes(e)?"KEYWORD":"IDENTIFIER",value:e},nextIndex:t+e.length}}},getOperatorPrecedence(e){return this.OPERATOR_PRECEDENCE[e]||0},parseTernary(){let e=this.parseBinaryWithPrecedence(1);if(this.match("QUESTION")){const t=this.parseTernary();return this.consume("COLON",'Expected ":" in ternary expression'),{type:"ternary",condition:e,trueValue:t,falseValue:this.parseTernary()}}return e},parseBinaryWithPrecedence(e){let t=this.parseUnary();for(;"OPERATOR"===this.peek().type;){const n=this.getOperatorPrecedence(this.peek().value);if(n<e)break;const i=this.advance().value,r=this.parseBinaryWithPrecedence(n+1);t={type:this.OPERATOR_TYPES[i]||"arithmetic",left:t,operator:i,right:r}}return t},parseUnary(){return this.matchOperator("!","-","+")?{type:"unary",operator:this.previous().value,operand:this.parseUnary()}:this.parsePrimary()},parsePrimary(){if(this.match("LPAREN")){const e=this.parseTernary();return this.consume("RPAREN","Expected closing parenthesis"),{type:"parentheses",inner:e}}return this.match("LBRACE")?this.parseObjectLiteral():this.check("STRING")||this.check("NUMBER")?{type:"literal",value:this.advance().value}:this.check("KEYWORD")?{type:"literal",value:{true:!0,false:!1,null:null,undefined:void 0}[this.advance().value]}:this.check("IDENTIFIER")?this.parsePropertyAccess():null},parseObjectLiteral(){const e=[];if(!this.check("RBRACE"))do{let t;if(this.check("STRING"))t=this.advance().value;else{if(!this.check("IDENTIFIER"))throw new Error("Expected property name");t=this.advance().value}this.consume("COLON",'Expected ":" after object key');const n=this.parseTernary();e.push({key:t,value:n})}while(this.match("COMMA")&&!this.check("RBRACE"));return this.consume("RBRACE","Expected closing brace"),{type:"object",pairs:e}},parsePropertyAccess(){let e=this.advance().value;for(;;)if(this.match("DOT")){if(!this.check("IDENTIFIER"))throw new Error('Expected property name after "."');e+="."+this.advance().value}else{if(!this.match("LBRACKET"))break;{const t=this.parseTernary();this.consume("RBRACKET","Expected closing bracket"),"literal"===t.type?e+="["+JSON.stringify(t.value)+"]":e+="["+this.reconstructExpression(t)+"]"}}return{type:"property",path:e}},reconstructExpression(e){if(!e)return"";switch(e.type){case"literal":return"string"==typeof e.value?'"'+e.value+'"':String(e.value);case"property":return e.path;case"arithmetic":return`${this.reconstructExpression(e.left)} ${e.operator} ${this.reconstructExpression(e.right)}`;default:return"unknown"}},match(...e){for(const t of e)if(this.check(t))return this.advance(),!0;return!1},matchOperator(...e){if(this.check("OPERATOR")){const t=this.peek();if(e.includes(t.value))return this.advance(),!0}return!1},check(e){return!this.isAtEnd()&&this.peek().type===e},advance(){return this.isAtEnd()||this.currentToken++,this.previous()},isAtEnd(){return this.currentToken>=this.tokens.length},peek(){return this.tokens[this.currentToken]||{type:"EOF",value:null}},previous(){return this.tokens[this.currentToken-1]},consume(e,t){if(this.check(e))return this.advance();throw new Error(t+` at token: ${JSON.stringify(this.peek())}`)},evaluate(e,t){if(e)switch(e.type){case"literal":return e.value;case"property":return this.getProperty(t,e.path);case"parentheses":return this.evaluate(e.inner,t);case"object":return this.evaluateObjectLiteral(e,t);case"ternary":return this.evaluate(e.condition,t)?this.evaluate(e.trueValue,t):this.evaluate(e.falseValue,t);case"logical":{const n=this.evaluate(e.left,t);return"&&"===e.operator?!!n&&this.evaluate(e.right,t):"||"===e.operator&&(!!n||this.evaluate(e.right,t))}case"comparison":case"arithmetic":{const n=this.evaluate(e.left,t),i=this.evaluate(e.right,t);return this.performOperation(n,e.operator,i)}case"unary":{const n=this.evaluate(e.operand,t);switch(e.operator){case"!":return!n;case"-":return-n;case"+":return+n;default:return n}}default:return}},getProperty(e,t){if(!e||!t)return;if(-1===t.indexOf("."))return e[t];const n=t.split(".");let i=e;for(let e=0;e<n.length;e++){if(null==i)return;i=i[n[e]]}return i},evaluateObjectLiteral(e,t){const n={};return e.pairs&&e.pairs.forEach(({key:e,value:i})=>{n[e]=this.evaluate(i,t)}),n},performOperation(e,t,n){switch(t){case"+":return e+n;case"-":return Number(e)-Number(n);case"*":return Number(e)*Number(n);case"/":return Number(e)/Number(n);case"%":return Number(e)%Number(n);case"===":return e===n;case"!==":return e!==n;case"==":return e==n;case"!=":return e!=n;case">=":return e>=n;case"<=":return e<=n;case">":return e>n;case"<":return e<n;default:return!1}},extractDependencies(e){if(!e)return[];const t=new Set,n=e=>{if(e)switch(e.type){case"property":{const n=e.path.split(/[.[]/,1)[0];n&&!["true","false","null","undefined"].includes(n)&&t.add(n);break}case"ternary":n(e.condition),n(e.trueValue),n(e.falseValue);break;case"logical":case"comparison":case"arithmetic":n(e.left),n(e.right);break;case"unary":n(e.operand);break;case"parentheses":n(e.inner);break;case"object":e.pairs&&e.pairs.forEach(e=>n(e.value))}};return n(e),Array.from(t)},parseBindingString(e){const t=[];let n="",i=!1,r="",s=0,a=0;for(let c=0;c<e.length;c++){const o=e[c],u=c>0&&"\\"===e[c-1];'"'!==o&&"'"!==o||u||(i?o===r&&(i=!1,r=""):(i=!0,r=o)),i||("("===o?s++:")"===o?s--:"{"===o?a++:"}"===o&&a--),","!==o||i||0!==s||0!==a?n+=o:(this.addBindingPairIfValid(n,t),n="")}return this.addBindingPairIfValid(n,t),t},addBindingPairIfValid(e,t){const n=e.trim();if(!n)return;const i=this.findBindingColon(n);-1===i?t.push({type:n,target:""}):t.push({type:n.substring(0,i).trim(),target:n.substring(i+1).trim()})},findBindingColon(e){const t=["value","checked","visible","if","foreach","class","style","click","change","input","submit","focus","blur","keyup","keydown"];for(const n of t)if(e.startsWith(n+":"))return n.length;let n=!1,i="",r=0;for(let t=0;t<e.length;t++){const s=e[t],a=t>0&&"\\"===e[t-1];if('"'!==s&&"'"!==s||a||(n?s===i&&(n=!1,i=""):(n=!0,i=s)),!n)if("("===s)r++;else if(")"===s)r--;else if(":"===s&&0===r)return t}return-1}},t={cache:new Map,maxSize:500,parseExpression(t){const n=String(t).trim();if(this.cache.has(n)){const e=this.cache.get(n);return this.cache.delete(n),this.cache.set(n,e),e}const i=e.parseExpression(t);if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}return this.cache.set(n,i),i}};function n(e,t){const n=new Map,i=new Map;Object.keys(t).forEach(r=>{const s=t[r],a=function(e){const t=e.toString().match(/this\.([a-zA-Z_$][a-zA-Z0-9_$]*)/g)||[];return[...new Set(t.map(e=>e.replace("this.","")))]}(s);i.set(r,{fn:s,dependencies:a,isDirty:!0}),Object.defineProperty(e,r,{get(){const e=i.get(r);if(e.isDirty||!n.has(r)){const t=e.fn.call(this);n.set(r,t),e.isDirty=!1}return n.get(r)},enumerable:!0})}),this.invalidateComputed=function(e){const t=[];return i.forEach((i,r)=>{i.dependencies.includes(e)&&(i.isDirty=!0,n.delete(r),t.push(r))}),t}}function i(e){this.container=e,this.propertyToElements=new Map,this.container.setAttribute("data-pac-container","")}function r(){this.elementToBindings=new WeakMap,this.bindingToElement=new WeakMap}i.prototype.subscribe=function(e,t){return!!this.belongsToThisContainer(e)&&(this.propertyToElements.has(t)||this.propertyToElements.set(t,new Set),this.propertyToElements.get(t).add(e),!0)},i.prototype.belongsToThisContainer=function(e){if(e.nodeType===Node.TEXT_NODE){const t=e.parentElement;return!!t&&t.closest("[data-pac-container]")===this.container}return e.closest("[data-pac-container]")===this.container},i.prototype.getSubscribedElements=function(e){const t=this.propertyToElements.get(e)||new Set,n=new Set,i=this;return t.forEach(function(e){e.isConnected&&i.belongsToThisContainer(e)&&n.add(e)}),this.propertyToElements.set(e,n),n},r.prototype.addBinding=function(e,t){this.elementToBindings.has(e)||this.elementToBindings.set(e,new Set),this.elementToBindings.get(e).add(t),this.bindingToElement.set(t,e)},r.prototype.getBindingsForElement=function(e){return this.elementToBindings.get(e)||new Set},r.prototype.getBindingForElementAndProperty=function(e,t){const n=this.getBindingsForElement(e);for(const e of n)if(e.dependencies&&e.dependencies.includes(t))return e;return null},window.PACRegistry=window.PACRegistry||new function(){this.components=new Map,this.register=function(e,t){this.components.set(e,t)},this.unregister=function(e){this.components.delete(e)}},window.wakaPAC=function(s,a,c){a=a||{},c=c||{};const o=document.querySelector(s);if(!o)throw new Error("Container not found: "+s);const u={selector:s,container:o,config:{updateMode:c.updateMode||"batched",delay:c.delay||300},original:a,abstraction:null,bindings:new Map,deps:new Map,subscriptionMap:null,eventBindings:[],initialize:function(){return this.bindingMap=new r,this.subscriptionMap=new i(this.container),this.setupTextBindings(),this.setupAttributeBindings(),this.setupSimpleEventCapture(),this.abstraction=this.createReactiveAbstraction(),this.setupEventHandlers(),this.performInitialUpdate(),this},createReactiveAbstraction:function(){const e={},t=this;Object.keys(this.original).forEach(function(n){"computed"!==n&&"function"!=typeof t.original[n]&&(e[n]=t.original[n])});const i=function(e,t){const n=["push","pop","shift","unshift","splice","sort","reverse"];return e&&"object"==typeof e?function e(i,r){return r=r||[],new Proxy(i,{get:function(i,s){const a=i[s];if(Array.isArray(i)&&"function"==typeof a&&n.includes(s))return function(){const e=Array.prototype.slice.call(i),n=Array.prototype[s].apply(i,arguments);return t.dispatchEvent(new CustomEvent("pac:change",{detail:{path:r,oldValue:e,newValue:Array.prototype.slice.call(i)}})),n};if(a&&"object"==typeof a&&!a._isReactive){const t=r.concat([s]);i[s]=e(a,t),i[s]._isReactive=!0}return i[s]},set:function(n,i,s){const a=n[i],c=r.concat([i]);return a===s||(s&&"object"==typeof s?(n[i]=e(s,c),n[i]._isReactive=!0):n[i]=s,t.dispatchEvent(new CustomEvent("pac:change",{detail:{path:c,oldValue:a,newValue:n[i]}}))),!0}})}(e,[]):e}(e,this.container);return Object.keys(this.original).forEach(function(e){"function"==typeof t.original[e]&&"computed"!==e&&(i[e]=t.original[e].bind(i))}),this.original.computed&&(this.computedManager=new n(i,this.original.computed)),i},setupTextBindings:function(){const e=this.getTextNodesFromElement(this.container),n=this;e.forEach(function(e){const i=e.textContent,r=i.match(/\{\{\s*([^}]+)\s*}}/g);r&&r.forEach(function(r){const s=r.replace(/^\{\{\s*|\s*}}$/g,"").trim(),a=t.parseExpression(s).dependencies||[],c=n.createBinding("text",e,{target:s,originalText:i,fullMatch:r,dependencies:a});n.bindingMap.addBinding(e,c),a.forEach(function(t){n.subscriptionMap.subscribe(e,t)})})})},getTextNodesFromElement:function(e){const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:e=>/\{\{.*\}\}/.test(e.textContent)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let i;for(;i=n.nextNode();)t.push(i);return t},setupAttributeBindings:function(){const n=this.container.querySelectorAll("[data-pac-bind]"),i=this;Array.from(n).forEach(function(n){const r=n.getAttribute("data-pac-bind"),s=e.parseBindingString(r);if(s.forEach(function(e){const r=e.type,s=e.target;if("click"!==r){if(s){const e=t.parseExpression(s).dependencies||[],a=i.createBinding(r,n,{target:s,dependencies:e});a&&(i.bindingMap.addBinding(n,a),e.forEach(e=>i.subscriptionMap.subscribe(n,e)))}}else i.eventBindings.push({element:n,type:r,target:s})}),i.original.computed){const e=Object.keys(i.original.computed);s.forEach(function(t){t.target&&e.forEach(function(e){t.target.includes(e)&&i.subscriptionMap.subscribe(n,e)})})}})},setupEventHandlers:function(){const e=this;this.eventBindings.forEach(function(t){"click"===t.type&&e.setupClickBinding(t.element,t.target)})},setupClickBinding:function(e,t){const n=this;e.addEventListener("click",function(e){const i=n.abstraction[t];if("function"==typeof i)try{i.call(n.abstraction,e)}catch(e){}})},createBinding:function(e,t,n){return{id:Date.now()+"_"+(1e4*Math.random()|0),type:e,element:t,target:n.target,originalText:n.originalText,fullMatch:n.fullMatch,dependencies:n.dependencies}},setupSimpleEventCapture:function(){const e=this;this.container.addEventListener("pac:change",function(t){const n=t.detail.path,i=n.join(".");e.handlePropertyChange(i),n.length>1&&e.handlePropertyChange(n[0])})},handlePropertyChange:function(e){const t=this,n=this.subscriptionMap.getSubscribedElements(e);n.size>0&&(n.forEach(function(n){t.updateElementForProperty(n,e)}),this.invalidateComputedDependents(e))},updateElementForProperty:function(n,i){const r=this.bindingMap.getBindingForElementAndProperty(n,i);if(!r)return;const s=this.abstraction,a=t.parseExpression(r.target),c=e.evaluate(a,s);switch(r.type){case"text":this.applyTextBinding(r,s);break;case"visible":this.applyVisibilityBinding(r,c);break;case"value":this.applyInputBinding(r,c);break;case"checked":this.applyCheckedBinding(r,c);break;default:this.applyAttributeBinding(r,c)}},invalidateComputedDependents:function(e){if(!this.computedManager)return;const t=this.computedManager.invalidateComputed(e),n=this;t.forEach(function(e){n.abstraction[e],n.handlePropertyChange(e)})},performInitialUpdate:function(){const e=this;Object.keys(this.abstraction).filter(function(t){return"function"!=typeof e.abstraction[t]&&!t.startsWith("_")}).forEach(function(t){const n=e.abstraction[t];e.handlePropertyChange(t,void 0,n)}),this.original.init&&this.original.init.call(this.abstraction)},processTextInterpolation:function(n,i){let r=String(n||"");const s=r.match(/\{\{\s*([^}]+)\s*}}/g);if(s)for(let n=0;n<s.length;n++){const a=s[n],c=a.replace(/^\{\{\s*|\s*}}$/g,"").trim();try{const n=t.parseExpression(c),s=e.evaluate(n,i),o=null!=s?String(s):"";r=r.replace(a,o)}catch(e){}}return r},applyTextBinding:function(e,t){const n=e.element,i=this.processTextInterpolation(e.originalText,t);n.textContent!==i&&(n.textContent=i)},applyVisibilityBinding:function(e,t){const n=e.element;if(t)n.hasAttribute("data-pac-hidden")&&(n.style.display=n.getAttribute("data-pac-orig-display")||"",n.removeAttribute("data-pac-hidden"),n.removeAttribute("data-pac-orig-display"));else if(!n.hasAttribute("data-pac-hidden")){const e=getComputedStyle(n).display;"none"!==e&&n.setAttribute("data-pac-orig-display",e),n.style.display="none",n.setAttribute("data-pac-hidden","true")}},applyInputBinding:function(e,t){const n=e.element,i=String(t||"");"value"in n&&n.value!==i&&(n.value=i)},applyCheckedBinding:function(e,t){e.element.checked=Boolean(t)},applyAttributeBinding:function(e,t){const n=e.element,i=e.type;["readonly","required","selected","checked","hidden","multiple"].includes(i)?n.toggleAttribute(i,!!t):null!=t?n.setAttribute(i,t):n.removeAttribute(i)}},p=function(e){const t={};return Object.keys(e.abstraction).forEach(function(n){const i=Object.getOwnPropertyDescriptor(e.abstraction,n);i&&Object.defineProperty(t,n,i)}),t}(u.initialize());return window.PACRegistry.register(s,u),p}}();