<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WakaSync + WakaPAC Integration Demo</title>

    <!--
        Load both libraries. Order matters: both must be loaded
        before any wakaPAC.use() call or component initialization.
    -->
    <script src="../wakapac.js"></script>
    <script src="../wakasync.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap');

        :root {
            --bg: #fafafa;
            --surface: #ffffff;
            --border: #e2e2e2;
            --text: #1a1a1a;
            --text-muted: #777;
            --accent: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --warn: #ca8a04;
            --mono: 'IBM Plex Mono', monospace;
            --sans: 'DM Sans', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--sans), serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        h1 {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
        }

        h1 span {
            color: var(--accent);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.8125rem;
            margin-bottom: 1.75rem;
        }

        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-width: 960px;
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-family: var(--mono), serif;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
        }

        .panel-body {
            padding: 1rem;
        }

        .btn-row {
            display: flex;
            gap: 0.375rem;
        }

        button {
            font-family: var(--mono), serif;
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            transition: border-color 0.15s;
        }

        button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        button:active {
            transform: scale(0.97);
        }

        button.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        button.primary:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
            color: #fff;
        }

        button.danger {
            border-color: var(--error);
            color: var(--error);
        }

        button.danger:hover {
            background: var(--error);
            color: #fff;
        }

        .log {
            font-family: var(--mono), serif;
            font-size: 0.7rem;
            line-height: 1.75;
            max-height: 280px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.2rem 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .log-time {
            color: var(--text-muted);
            white-space: nowrap;
        }

        .log-tag {
            font-weight: 600;
            padding: 0.0625rem 0.3rem;
            border-radius: 3px;
            font-size: 0.65rem;
            white-space: nowrap;
        }

        .log-tag.success {
            color: var(--success);
            background: #dcfce7;
        }

        .log-tag.error {
            color: var(--error);
            background: #fee2e2;
        }

        .log-tag.abort {
            color: var(--warn);
            background: #fef9c3;
        }

        .log-tag.info {
            color: var(--accent);
            background: #dbeafe;
        }

        .log-msg {
            color: var(--text);
            word-break: break-word;
        }

        .user-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 0.875rem;
            margin-bottom: 0.5rem;
        }

        .user-card .name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-card .email {
            font-family: var(--mono), serif;
            font-size: 0.7rem;
            color: var(--accent);
        }

        .user-card .company {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 1.75rem 1rem;
            font-size: 0.8125rem;
        }

        .status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 0.3rem;
            vertical-align: middle;
        }

        .status-dot.idle {
            background: #ccc;
        }

        .status-dot.loading {
            background: var(--accent);
            animation: pulse 1s infinite;
        }

        .status-dot.success {
            background: var(--success);
        }

        .status-dot.error {
            background: var(--error);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>

<h1>waka<span>Sync</span> + wakaPAC</h1>
<p class="subtitle">HTTP requests delivered as Win32-style messages to reactive components</p>

<div class="panels">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         Panel 1: User list component
         Fetches /users from JSONPlaceholder and shows
         results. Demonstrates GET + msgProc handling.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="user-list" data-pac-id="user-list">
        <div class="panel-header">
            <span class="panel-title">
                <span data-pac-bind="class: status === 'loading' ? 'status-dot loading' : status === 'error' ? 'status-dot error' : status === 'success' ? 'status-dot success' : 'status-dot idle'"></span>
                Users
                <span data-pac-bind="if: status === 'loading'"> â€” fetchingâ€¦</span>
            </span>
            <div class="btn-row">
                <button class="primary" data-pac-bind="click: loadUsers">Fetch users</button>
                <button class="danger" data-pac-bind="click: cancelRequest">Cancel</button>
            </div>
        </div>
        <div class="panel-body">
            <div data-pac-bind="if: users.length === 0 && status !== 'loading'">
                <div class="empty-state">
                    Click <strong>Fetch users</strong> to load data via wakaSync
                </div>
            </div>
            <div data-pac-bind="foreach: users" data-pac-item="user">
                <div class="user-card">
                    <div class="name">{{ user.name }}</div>
                    <div class="email">{{ user.email }}</div>
                    <div class="company">ğŸ¢ {{ user.company.name }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         Panel 2: Create post component
         Demonstrates POST with body, and shows how
         different request IDs can be correlated in
         msgProc via event.wParam.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="post-lookup" data-pac-id="post-lookup">
        <div class="panel-header">
            <span class="panel-title">
                <span data-pac-bind="class: status === 'loading' ? 'status-dot loading' : status === 'error' ? 'status-dot error' : status === 'success' ? 'status-dot success' : 'status-dot idle'"></span>
                Create Post
            </span>
            <div class="btn-row">
                <button class="primary" data-pac-bind="click: createPost">Submit</button>
            </div>
        </div>
        <div class="panel-body">
            <div data-pac-bind="if: !result">
                <div class="empty-state">
                    Click <strong>Submit</strong> to POST new data and receive the response as a message
                </div>
            </div>
            <div data-pac-bind="if: result">
                <div class="user-card">
                    <div class="name">Post #{{ result.id }}</div>
                    <div class="email">{{ result.title }}</div>
                    <div class="company">{{ result.body }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         Panel 3: Message log
         A separate wakaPAC component that receives
         custom log messages to show the full
         message flow visually.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel full-width" id="msg-log" data-pac-id="msg-log">
        <div class="panel-header">
            <span class="panel-title">Message Log</span>
            <button data-pac-bind="click: clear">Clear</button>
        </div>
        <div class="panel-body">
            <div class="log">
                <div data-pac-bind="if: entries.length === 0">
                    <div class="empty-state">Messages will appear here as wakaSync delivers HTTP results to msgProc
                    </div>
                </div>
                <div data-pac-bind="foreach: entries" data-pac-item="entry">
                    <div class="log-entry">
                        <span class="log-time">{{ entry.time }}</span>
                        <span data-pac-bind="class: 'log-tag ' + entry.type">{{ entry.tag }}</span>
                        <span class="log-msg">{{ entry.msg }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 1: Register wakaSync as a wakaPAC plugin.
    //
    // This calls wakaSync.createPacPlugin(wakaPAC), which:
    //   - Derives MSG_HTTP_SUCCESS/ERROR/ABORT from wakaPAC.MSG_USER
    //   - Attaches those constants to the wakaPAC object
    //   - Returns lifecycle hooks (onComponentCreated, onComponentDestroyed)
    //
    // After this call, every new wakaPAC component automatically
    // receives a this._http handle scoped to its pacId.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    wakaPAC.use(wakaSync);

    // Helper: post a log entry to the msg-log component via postMessage
    const MSG_LOG = wakaPAC.MSG_USER + 0x200;

    function logMessage(type, tag, msg) {
        const now = new Date();
        const time = [now.getHours(), now.getMinutes(), now.getSeconds()]
                .map(n => String(n).padStart(2, '0')).join(':')
            + '.' + String(now.getMilliseconds()).padStart(3, '0');

        wakaPAC.postMessage('msg-log', MSG_LOG, 0, 0, {
            time: time,
            type: type,
            tag: tag,
            msg: msg
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 2: Initialize the log viewer FIRST.
    //
    // This component does NOT use wakaSync â€” it receives custom
    // MSG_LOG messages via wakaPAC.postMessage(). Must be registered
    // before the other components, because their init() hooks call
    // logMessage() which targets this pacId.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    wakaPAC('#msg-log', {
        entries: [],

        clear() {
            this.entries = [];
        },

        msgProc(event) {
            if (event.message === MSG_LOG) {
                this.entries.push(event.detail);
            }
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 3: Define the "User List" component.
    //
    // After wakaPAC initializes this component, the wakaSync plugin's
    // onComponentCreated hook injects this._http with methods:
    //   get(url, opts), post(url, data, opts), put(), patch(),
    //   delete(), head(), cancel()
    //
    // Each method returns a numeric requestId. The HTTP result is
    // delivered asynchronously to msgProc as a message, not as a
    // promise. This keeps the component's control flow message-driven.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    wakaPAC('#user-list', {
        // â”€â”€ Reactive state â”€â”€
        users: [],
        status: 'idle',           // idle | loading | success | error
        pendingRequestId: null,   // track which request we're waiting for

        // â”€â”€ Lifecycle â”€â”€
        init() {
            logMessage('info', 'INIT', 'user-list component created â€” this._http is available');
        },

        // â”€â”€ Actions (triggered via data-pac-bind="click: ...") â”€â”€
        loadUsers() {
            this.users = [];
            this.status = 'loading';

            // Fire a GET request. The result comes back through msgProc,
            // not through a .then() chain. The returned ID lets us
            // correlate the response in msgProc via event.wParam.
            this.pendingRequestId = this._http.get(
                'https://jsonplaceholder.typicode.com/users'
            );

            logMessage('info', 'GET', 'Requesting /users  â†’  requestId=' + this.pendingRequestId);
        },

        cancelRequest() {
            // Cancels all in-flight requests grouped under this component's
            // pacId. wakaSync will deliver MSG_HTTP_ABORT to msgProc.
            this._http.cancel();
            logMessage('abort', 'CANCEL', 'Cancelled all requests for user-list');
        },

        // â”€â”€ Message handler â”€â”€
        // Every wakaPAC event (mouse, keyboard, timer, AND wakaSync
        // HTTP results) flows through msgProc. The message constants
        // MSG_HTTP_SUCCESS, MSG_HTTP_ERROR, MSG_HTTP_ABORT were
        // attached to wakaPAC by the plugin registration.
        msgProc(event) {
            switch (event.message) {

                case wakaPAC.MSG_HTTP_SUCCESS: {
                    // event.wParam  = requestId (correlate with pendingRequestId)
                    // event.lParam  = 0
                    // event.detail  = { data, url, method, timing }
                    const {data, timing} = event.detail;

                    this.users = data;
                    this.status = 'success';

                    logMessage(
                        'success', 'HTTP OK',
                        'Received ' + data.length + ' users in ' + timing.duration + 'ms' +
                        '  (requestId=' + event.wParam + ')'
                    );
                    break;
                }

                case wakaPAC.MSG_HTTP_ERROR: {
                    // event.wParam  = requestId
                    // event.lParam  = HTTP status code (e.g. 404, 500) or 0 if network error
                    // event.detail  = { error, url, method, status, code }
                    this.status = 'error';

                    logMessage(
                        'error', 'HTTP ERR',
                        'Request failed: status=' + event.lParam +
                        ' code=' + (event.detail.code || 'none') +
                        '  (requestId=' + event.wParam + ')'
                    );
                    break;
                }

                case wakaPAC.MSG_HTTP_ABORT: {
                    // event.wParam  = requestId
                    // event.detail  = { error, url, method }
                    this.status = 'idle';

                    logMessage(
                        'abort', 'ABORT',
                        'Request aborted for ' + event.detail.url +
                        '  (requestId=' + event.wParam + ')'
                    );
                    break;
                }
            }
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 4: Define the "Create Post" component.
    //
    // Demonstrates this._http.post() with a JSON body.
    // wakaSync serializes the data and sets Content-Type automatically.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    wakaPAC('#post-lookup', {
        result: null,
        status: 'idle',

        init() {
            logMessage('info', 'INIT', 'post-lookup component created');
        },

        createPost() {
            this.status = 'loading';
            this.result = null;

            // POST with a JSON body. The second argument is the payload.
            const reqId = this._http.post(
                'https://jsonplaceholder.typicode.com/posts',
                {
                    title: 'Message-driven HTTP with wakaSync',
                    body: 'No promises in the component â€” results arrive via msgProc.',
                    userId: 1
                }
            );

            logMessage('info', 'POST', 'Creating post  â†’  requestId=' + reqId);
        },

        msgProc(event) {
            switch (event.message) {

                case wakaPAC.MSG_HTTP_SUCCESS: {
                    const {data, timing} = event.detail;

                    this.result = data;
                    this.status = 'success';

                    logMessage(
                        'success', 'HTTP OK',
                        'Post created: id=' + data.id + ' in ' + timing.duration + 'ms'
                    );
                    break;
                }

                case wakaPAC.MSG_HTTP_ERROR: {
                    this.status = 'error';

                    logMessage(
                        'error', 'HTTP ERR',
                        'POST failed: ' + event.lParam
                    );
                    break;
                }

                case wakaPAC.MSG_HTTP_ABORT: {
                    this.status = 'idle';

                    logMessage('abort', 'ABORT', 'POST request aborted');
                    break;
                }
            }
        }
    });
</script>

</body>
</html>