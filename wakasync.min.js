!function(){"use strict";function t(){this._requestGroups=new Map,this.config={timeout:3e4,retries:0,retryDelay:1e3,validateStatus:t=>t.ok,responseType:"auto",headers:{"User-Agent":"WakaSync/1.0"}}}t.prototype={request(t,e={}){const r=this.validateAndNormalizeConfig(t,e);this._requestGroups||(this._requestGroups=new Map);const o=this.setupRequestState(r),n=r.timeout>0?this.createTimeoutPromise(r.timeout,o.controller):null,a=this.executeWithRetry(r,o).then(t=>this.processResponse(t,r,o)).then(t=>this.handleSuccess(t,r,o)).catch(t=>this.handleError(t,r));return(n?Promise.race([a,n]):a).finally(()=>{this.cleanupRequest(r.groupKey,o.token)})},get(t,e={}){return this.request(t,{...e,method:"GET"})},post(t,e,r={}){return this.request(t,{...r,method:"POST",data:e})},put(t,e,r={}){return this.request(t,{...r,method:"PUT",data:e})},delete(t,e={}){return this.request(t,{...e,method:"DELETE"})},patch(t,e,r={}){return this.request(t,{...r,method:"PATCH",data:e})},head(t,e={}){return this.request(t,{...e,method:"HEAD"})},create(e={}){const r=new t;return r.config={...this.config,...e},r},cancelGroup(t){if(!t||!this._requestGroups)return;const e=this._requestGroups.get(t);e&&e.controller&&!e.controller.signal.aborted&&e.controller.abort()},cancelAll(){this._requestGroups&&(this._requestGroups.forEach(t=>{t.controller&&!t.controller.signal.aborted&&t.controller.abort()}),this._requestGroups.clear())},getActiveRequestCount(){if(!this._requestGroups)return 0;let t=0;return this._requestGroups.forEach(e=>{e.controller&&!e.controller.signal.aborted&&t++}),t},validateAndNormalizeConfig(t,e){if(!t||"string"!=typeof t)throw new Error("URL must be a non-empty string");const r={...this.config,...e};this.validateCallbacks(r),this.validateAbortControls(r);const{method:o,body:n}=this.normalizeMethodAndBody(r),a=this.buildHeaders(r,n),s=this.buildFetchPassthrough(r);return{url:t,method:o,headers:a,body:n,groupKey:r.groupKey??(r.latestOnly?this.getGroupKeyFromUrl(t,r):null),fetchOptions:s,timeout:Math.max(0,parseInt(r.timeout)||3e4),ignoreAbort:!!r.ignoreAbort,validateStatus:r.validateStatus||(t=>t.ok),responseType:r.responseType||"auto",onSuccess:r.onSuccess,onError:r.onError,onProgress:r.onProgress,abortController:r.abortController,retries:Math.max(0,parseInt(r.retries)||0),retryDelay:Math.max(0,parseInt(r.retryDelay)||1e3),shouldRetry:r.shouldRetry}},validateCallbacks(t){[["onSuccess",t.onSuccess],["onError",t.onError],["onProgress",t.onProgress],["urlNormalizer",t.urlNormalizer],["shouldRetry",t.shouldRetry]].forEach(([t,e])=>{if(e&&"function"!=typeof e)throw new Error(`${t} must be a function`)})},validateAbortControls(t){if(t.abortController&&"function"!=typeof t.abortController.abort)throw new Error("abortController must have an abort method")},normalizeMethodAndBody(t){const e=(t.method||"GET").toUpperCase();if(["GET","HEAD"].includes(e))return t.data,{method:e};let r;return void 0!==t.data&&(r="string"==typeof t.data||t.data instanceof FormData||t.data instanceof Blob||t.data instanceof ArrayBuffer?t.data:JSON.stringify(t.data)),{method:e,body:r}},buildHeaders(t,e){const r=new Headers;r.set("X-WakaSync-Request","true"),void 0!==e&&(e instanceof FormData||(e instanceof Blob||e instanceof ArrayBuffer?r.set("Content-Type","application/octet-stream"):"string"==typeof e?r.set("Content-Type","text/plain; charset=utf-8"):r.set("Content-Type","application/json; charset=utf-8")));const o=t.headers||{};return Object.keys(o).some(t=>"accept"===t.toLowerCase())||r.set("Accept","application/json, text/plain, */*"),Object.entries(o).forEach(([t,e])=>{r.set(t,e)}),r},buildFetchPassthrough(t){const e={};return["credentials","mode","cache","redirect","referrer","referrerPolicy","integrity","keepalive","priority"].forEach(r=>{void 0!==t[r]&&(e[r]=t[r])}),e},getGroupKeyFromUrl(t,e){return e.urlNormalizer?e.urlNormalizer(t):this.normalizeUrlForGrouping(t,e.baseUrl)},normalizeUrlForGrouping(t,e){try{let r;r="undefined"!=typeof globalThis&&globalThis.location?e||globalThis.location.origin:e||"http://localhost";const o=new URL(t,r);o.hash="";const n=new URLSearchParams(o.search),a=new URLSearchParams;return[...n.keys()].sort().forEach(t=>{n.getAll(t).sort().forEach(e=>{a.append(t,e)})}),o.search=a.toString(),o.toString()}catch{return t}},setupRequestState(t){const e=this.createCombinedController(t);let r=0;if(t.groupKey){const o=this._requestGroups.get(t.groupKey);o?(o.controller&&!o.controller.signal.aborted&&o.controller.abort(),r=o.token+1):r=1,this._requestGroups.set(t.groupKey,{token:r,controller:e})}return{token:r,controller:e,groupKey:t.groupKey}},createCombinedController:t=>t.abortController?t.abortController:new AbortController,createTimeoutPromise(t,e){return new Promise((r,o)=>{if(e.signal.aborted)return void o(this.createTaggedCancellationError("Request was cancelled before timeout","timeout"));const n=setTimeout(()=>{e.signal.aborted||(e.abort(),o(this.createTaggedCancellationError(`Request timeout after ${t}ms`,"timeout")))},t);e.signal.addEventListener("abort",()=>clearTimeout(n),{once:!0})})},async executeWithRetry(t,e){let r;const o=t.retries+1;for(let n=1;n<=o;n++)try{return await this.executeFetch(t,e)}catch(e){if(r=e,this.isCancellationError(e))throw e;if(!(t.shouldRetry?t.shouldRetry(e,n,o):this.defaultShouldRetry(e,n,o))||n===o)throw e;t.retryDelay>0&&await this.delay(t.retryDelay)}throw r},defaultShouldRetry(t,e,r){return!(e>=r||this.isCancellationError(t)||!t.network&&!(t.response&&t.response.status>=500)&&(!t.response||429!==t.response.status))},delay:t=>new Promise(e=>setTimeout(e,t)),async executeFetch(t,e){if(e.controller.signal.aborted)throw this.createTaggedCancellationError("Request was cancelled before execution","cancelled");const r={method:t.method,headers:t.headers,body:t.body,signal:e.controller.signal,...t.fetchOptions};try{return await fetch(t.url,r)}catch(t){throw"TypeError"!==t.name||e.controller.signal.aborted||(t.network=!0),t}},async processResponse(t,e,r){if(r.controller.signal.aborted)throw this.createTaggedCancellationError("Request was cancelled during processing","cancelled");if(!e.validateStatus(t)){const e=await this.safeGetResponseText(t),r=new Error(`HTTP ${t.status}: ${t.statusText}${e?` - ${e}`:""}`);throw r.response=t,r}if("HEAD"!==e.method&&![204,205,304].includes(t.status))return this.parseResponse(t,e.responseType)},async parseResponse(t,e){try{switch(e){case"json":return await t.json();case"text":return await t.text();case"blob":return await t.blob();case"response":return t;default:return this.autoParseResponse(t)}}catch(t){throw new Error(`Failed to parse response as ${e}: ${t.message}`)}},async autoParseResponse(t){const e=t.headers.get("content-type")||"";if("0"!==t.headers.get("content-length")){if(/json|\+json/i.test(e)){const e=await t.text();return e.trim()?JSON.parse(e):void 0}return/^text\//i.test(e)?t.text():t.blob()}},async safeGetResponseText(t){try{if(t.bodyUsed)return null;const e=t.clone();return(await e.text()).substring(0,200)}catch{return null}},handleSuccess(t,e,r){if(r.controller.signal.aborted){if(e.ignoreAbort)return;throw this.createTaggedCancellationError("Request was cancelled","cancelled")}if(e.onSuccess)try{e.onSuccess(t)}catch(t){}return t},handleError(t,e){if(!this.isCancellationError(t)||!e.ignoreAbort){if(e.onError)try{e.onError(t)}catch(t){}throw t}},createTaggedCancellationError(t,e){const r=new Error(t);return r.name="CancellationError",r.cancellationType=e,r},isCancellationError:t=>"AbortError"===t.name||"CancellationError"===t.name||!!t.cancellationType&&["timeout","cancelled","superseded"].includes(t.cancellationType),cleanupRequest(t,e){if(!t)return;const r=this._requestGroups.get(t);r&&(r.token===e||r.token<e)&&this._requestGroups.delete(t)}};const e=new t;!function(){if("undefined"!=typeof window&&"undefined"!=typeof document){if(!t()){let e=0;const r=20,o=setInterval(()=>{e++,(t()||e>=r)&&clearInterval(o)},500)}"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",t)}function t(){return"function"==typeof window.wakaPAC&&void 0!==window.Context&&!!function(){if(void 0===window.Context)return!1;const t=window.Context.prototype,r=window.Context;function o(t,o,n){r.call(this,t,o,n);const a=this;a.abstraction.control=function(t){const r=e.create({timeout:3e4,retries:1,headers:{"X-Component-ID":t.container.getAttribute("data-pac-container")||"unknown"}});return t._wakaHttpClient=r,function(e,o={}){const n={groupKey:t.container.getAttribute("data-pac-container"),latestOnly:!0,ignoreAbort:!0,...o};return r.request(e,n)}}(a),a.abstraction.get=function(t,e){return a.abstraction.control(t,{...e,method:"GET"})},a.abstraction.post=function(t,e,r){return a.abstraction.control(t,{...r,method:"POST",data:e})},a.abstraction.put=function(t,e,r){return a.abstraction.control(t,{...r,method:"PUT",data:e})},a.abstraction.delete=function(t,e){return a.abstraction.control(t,{...e,method:"DELETE"})},a.abstraction.patch=function(t,e,r){return a.abstraction.control(t,{...r,method:"PATCH",data:e})},a.abstraction.head=function(t,e){return a.abstraction.control(t,{...e,method:"HEAD"})},a.abstraction.cancelRequests=function(){const t=a.container.getAttribute("data-pac-container");t&&a._wakaHttpClient&&a._wakaHttpClient.cancelGroup(t)}}o.prototype=t,o.prototype.constructor=o,window.Context=o;const n=t.destroy;return n&&(t.destroy=function(){if(this._wakaHttpClient){const t=this.container.getAttribute("data-pac-container");t&&this._wakaHttpClient.cancelGroup(t),this._wakaHttpClient=null}n.call(this)}),!0}()&&("function"==typeof window.wakaPAC&&(window.wakaPAC.http=e,window.wakaPAC.cancelAllRequests=()=>e.cancelAll(),window.wakaPAC.getActiveRequestCount=()=>e.getActiveRequestCount()),!0)}}(),"undefined"!=typeof window&&(window.WakaSync=t,window.wakaSync=e)}();