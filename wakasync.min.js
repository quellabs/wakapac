!function(){"use strict";const e="1.3.0";function t(){this._requestGroups=new Map,this._interceptorId=0,this.interceptors={request:[],response:[]},this.config={timeout:3e4,retries:0,retryDelay:1e3,retryBackoff:"exponential",retryBackoffMax:3e4,validateStatus:function(e){return e.ok},responseType:"auto",headers:{}}}t.prototype={constructor:t,createPacPlugin(e){const t=this;let r=0;const o=e.MSG_USER+256,n=e.MSG_USER+257,s=e.MSG_USER+258;function a(a,i,c,l){l=l||{};const u=++r,d=Date.now(),h=void 0!==l.groupKey?l.groupKey:a;return t.request(c,Object.assign({},l,{method:i,groupKey:h})).then(function(t){const r=Date.now();e.postMessage(a,o,u,0,{data:t,url:c,method:i,timing:{startTime:d,endTime:r,duration:r-d}})}).catch(function(r){if(t.isCancellationError(r))e.postMessage(a,s,u,0,{error:r,url:c,method:i});else{const t=r.response&&r.response.status?r.response.status:0;e.postMessage(a,n,u,t,{error:r,url:c,method:i,status:t,code:r.code||null})}}),u}return e.MSG_HTTP_SUCCESS=o,e.MSG_HTTP_ERROR=n,e.MSG_HTTP_ABORT=s,{onComponentCreated:function(e,r){e.http=function(e){return{get:function(t,r){return a(e,"GET",t,r)},post:function(t,r,o){return a(e,"POST",t,Object.assign({},o,{data:r}))},put:function(t,r,o){return a(e,"PUT",t,Object.assign({},o,{data:r}))},patch:function(t,r,o){return a(e,"PATCH",t,Object.assign({},o,{data:r}))},delete:function(t,r){return a(e,"DELETE",t,r)},head:function(t,r){return a(e,"HEAD",t,r)},cancel:function(){t.cancelGroup(e)}}}(r)},onComponentDestroyed:function(e){t.cancelGroup(e)}}},addRequestInterceptor(e){if("function"!=typeof e)throw new Error("Interceptor must be a function");const t={id:++this._interceptorId,fn:e};return this.interceptors.request.push(t),()=>{const e=this.interceptors.request.indexOf(t);-1!==e&&this.interceptors.request.splice(e,1)}},addResponseInterceptor(e){if("function"!=typeof e)throw new Error("Interceptor must be a function");const t={id:++this._interceptorId,fn:e};return this.interceptors.response.push(t),()=>{const e=this.interceptors.response.indexOf(t);-1!==e&&this.interceptors.response.splice(e,1)}},async request(e,t={}){const r=Date.now();let o=this.validateAndNormalizeConfig(e,t);for(const e of this.interceptors.request)try{const t="function"==typeof e?e:e.fn,r=await t(o);o=void 0!==r?r:o}catch(e){const t=new Error("Request interceptor failed");throw t.code="INTERCEPTOR_ERROR",t.originalError=e,t}const n=this.setupRequestState(o);let s=null;o.timeout>0&&(s=setTimeout(()=>{n.controller.signal.aborted||(n.timedOut=!0,n.controller.abort())},o.timeout),n.controller.signal.addEventListener("abort",()=>{clearTimeout(s)},{once:!0}));try{let e=await this.executeWithRetry(o,n),t=await this.processResponse(e,o,n);const s=Date.now(),a={startTime:r,endTime:s,duration:s-r};for(const e of this.interceptors.response)try{const r="function"==typeof e?e:e.fn,n=await r(t,o,a);t=void 0!==n?n:t}catch(e){const t=new Error("Response interceptor failed");throw t.code="INTERCEPTOR_ERROR",t.originalError=e,t}return this.handleSuccess(t,o,n)}catch(e){if(n.timedOut&&("AbortError"===e.name||"CancellationError"===e.name)){const e=this.createTaggedCancellationError(`Request timeout after ${o.timeout}ms`,"timeout");return this.handleError(e,o)}return this.handleError(e,o)}finally{null!==s&&clearTimeout(s),this.cleanupRequest(o.groupKey,n.token)}},get(e,t={}){return this.request(e,{...t,method:"GET"})},post(e,t,r={}){return this.request(e,{...r,method:"POST",data:t})},put(e,t,r={}){return this.request(e,{...r,method:"PUT",data:t})},delete(e,t={}){return this.request(e,{...t,method:"DELETE"})},patch(e,t,r={}){return this.request(e,{...r,method:"PATCH",data:t})},head(e,t={}){return this.request(e,{...t,method:"HEAD"})},create(e={},r={}){const o=new t;return o.config={...this.config,...e,headers:{...this.config.headers,...e.headers||{}}},r.copyInterceptors&&(o.interceptors={request:[...this.interceptors.request],response:[...this.interceptors.response]}),o},cancelGroup(e){if(!e)return;const t=this._requestGroups.get(e);t&&t.controller&&!t.controller.signal.aborted&&t.controller.abort()},cancelAll(){this._requestGroups.forEach(function(e){e.controller&&!e.controller.signal.aborted&&e.controller.abort()}),this._requestGroups.clear()},getActiveRequestCount(){let e=0;return this._requestGroups.forEach(function(t){t.controller&&!t.controller.signal.aborted&&e++}),e},validateAndNormalizeConfig(e,t){if(!e||"string"!=typeof e){const e=new Error("URL must be a non-empty string");throw e.code="INVALID_URL",e}const r={...this.config,...t,headers:{...this.config.headers,...t.headers||{}}};this.validateCallbacks(r),this.validateAbortControls(r);const{method:o,body:n,bodyIsJson:s}=this.normalizeMethodAndBody(r),a=this.buildHeaders(r,n,s),i=this.buildFetchPassthrough(r);return{url:e,method:o,headers:a,body:n,groupKey:r.groupKey??(r.latestOnly?this.getGroupKeyFromUrl(e,r):null),fetchOptions:i,timeout:Math.max(0,parseInt(r.timeout)||3e4),ignoreAbort:!!r.ignoreAbort,validateStatus:r.validateStatus||(e=>e.ok),responseType:r.responseType||"auto",onSuccess:r.onSuccess,onError:r.onError,onProgress:r.onProgress,abortController:r.abortController,retries:Math.max(0,parseInt(r.retries)||0),retryDelay:Math.max(0,parseInt(r.retryDelay)||1e3),retryBackoff:r.retryBackoff||"exponential",retryBackoffMax:Math.max(0,parseInt(r.retryBackoffMax)||3e4),shouldRetry:r.shouldRetry,urlNormalizer:r.urlNormalizer,baseUrl:r.baseUrl}},validateCallbacks(e){[["onSuccess",e.onSuccess],["onError",e.onError],["onProgress",e.onProgress],["urlNormalizer",e.urlNormalizer],["shouldRetry",e.shouldRetry]].forEach(function(e){const t=e[0],r=e[1];if(r&&"function"!=typeof r){const e=new Error(`${t} must be a function`);throw e.code="INVALID_CALLBACK",e}})},validateAbortControls(e){if(e.abortController&&"function"!=typeof e.abortController.abort){const e=new Error("abortController must have an abort method");throw e.code="INVALID_ABORT_CONTROLLER",e}},normalizeMethodAndBody(e){const t=(e.method||"GET").toUpperCase();if(["GET","HEAD"].includes(t))return e.data,{method:t,body:void 0,bodyIsJson:!1};let r,o=!1;return void 0!==e.data&&("string"==typeof e.data||e.data instanceof FormData||e.data instanceof Blob||e.data instanceof ArrayBuffer?r=e.data:(r=JSON.stringify(e.data),o=!0)),{method:t,body:r,bodyIsJson:o}},buildHeaders(t,r,o){const n=new Headers;n.set("X-WakaSync-Request","true"),n.set("X-WakaSync-Version",e),void 0!==r&&(r instanceof FormData||(r instanceof Blob||r instanceof ArrayBuffer?n.set("Content-Type","application/octet-stream"):o?n.set("Content-Type","application/json; charset=utf-8"):n.set("Content-Type","text/plain; charset=utf-8")));const s=t.headers||{};return Object.keys(s).some(e=>"accept"===e.toLowerCase())||n.set("Accept","application/json, text/plain, */*"),Object.entries(s).forEach(([e,t])=>{n.set(e,t)}),n},buildFetchPassthrough(e){const t={};return["credentials","mode","cache","redirect","referrer","referrerPolicy","integrity","keepalive","priority"].forEach(r=>{void 0!==e[r]&&(t[r]=e[r])}),t},getGroupKeyFromUrl(e,t){return t.urlNormalizer?t.urlNormalizer(e,t):this.normalizeUrlForGrouping(e,t.baseUrl)},normalizeUrlForGrouping(e,t){try{let r;r="undefined"!=typeof globalThis&&globalThis.location?t||globalThis.location.origin:t||"http://localhost";const o=new URL(e,r);o.hash="";const n=new URLSearchParams(o.search),s=new URLSearchParams;return[...new Set(n.keys())].sort().forEach(e=>{n.getAll(e).forEach(t=>{s.append(e,t)})}),o.search=s.toString(),o.toString()}catch(e){const t=new Error("Invalid URL for request");throw t.code="INVALID_URL",t.originalError=e,t}},setupRequestState(e){const t=this.createCombinedController(e);let r=0;if(e.groupKey){const o=this._requestGroups.get(e.groupKey);o?(o.controller&&!o.controller.signal.aborted&&o.controller.abort(),r=o.token+1):r=1,this._requestGroups.set(e.groupKey,{token:r,controller:t})}return{token:r,controller:t,groupKey:e.groupKey,timedOut:!1}},createCombinedController(e){const t=new AbortController;if(!e.abortController)return t;if("function"==typeof AbortSignal.any){const r=new AbortController,o=AbortSignal.any([t.signal,e.abortController.signal]);o.addEventListener("abort",()=>{r.signal.aborted||r.abort(o.reason)},{once:!0});const n=r.abort.bind(r);return r.abort=function(e){t.abort(e),n(e)},r}return e.abortController.signal.aborted?t.abort():e.abortController.signal.addEventListener("abort",()=>{t.signal.aborted||t.abort()},{once:!0}),t},async executeWithRetry(e,t){let r;const o=e.retries+1;for(let n=1;n<=o;n++)try{return await this.executeFetch(e,t)}catch(s){if(r=s,this.isCancellationError(s))throw s;if(!(e.shouldRetry?e.shouldRetry(s,n,o):this.defaultShouldRetry(s,n,o))||n===o)throw s;const a=this.calculateRetryDelay(e,n,s);a>0&&await this.delayWithAbortCheck(a,t.controller)}throw r},calculateRetryDelay(e,t,r){if(r.response&&429===r.response.status){const t=r.response.headers.get("Retry-After");if(t){const r=parseInt(t,10);if(!isNaN(r))return Math.min(1e3*r,e.retryBackoffMax);const o=Date.parse(t);if(!isNaN(o)){const t=o-Date.now();return Math.min(Math.max(0,t),e.retryBackoffMax)}}}const o=e.retryDelay;switch(e.retryBackoff){case"linear":return Math.min(o*t,e.retryBackoffMax);case"fixed":return o;default:{const r=o*Math.pow(2,t-1),n=.1*r*Math.random();return Math.min(r+n,e.retryBackoffMax)}}},defaultShouldRetry(e,t,r){return!(t>=r)&&!this.isCancellationError(e)&&(!!e.network||!!(e.response&&e.response.status>=500)||e.response&&429===e.response.status)},delayWithAbortCheck(e,t){const r=this;return new Promise(function(o,n){if(t.signal.aborted)return void n(r.createTaggedCancellationError("Request was cancelled during retry delay","cancelled"));const s=setTimeout(function(){o()},e);t.signal.addEventListener("abort",function(){clearTimeout(s),n(r.createTaggedCancellationError("Request was cancelled during retry delay","cancelled"))},{once:!0})})},async executeFetch(e,t){if(t.controller.signal.aborted)throw this.createTaggedCancellationError("Request was cancelled before execution","cancelled");const r={method:e.method,headers:e.headers,body:e.body,signal:t.controller.signal,...e.fetchOptions};try{return await fetch(e.url,r)}catch(e){throw"TypeError"!==e.name||t.controller.signal.aborted||(e.network=!0),e}},async processResponse(e,t,r){if(r.controller.signal.aborted){if(t.ignoreAbort)return;throw this.createTaggedCancellationError("Request was cancelled during processing","cancelled")}if(!t.validateStatus(e)){const t=await this.safeGetResponseText(e),r=new Error(`HTTP ${e.status}: ${e.statusText}${t?` - ${t}`:""}`);throw r.code=`HTTP_${e.status}`,r.response=e,r}if("HEAD"!==t.method&&![204,205,304].includes(e.status))return this.parseResponse(e,t.responseType)},async parseResponse(e,t){try{switch(t){case"json":return await e.json();case"text":return await e.text();case"blob":return await e.blob();case"response":return e;default:return this.autoParseResponse(e)}}catch(r){const o=new Error(`Failed to parse response as ${t}: ${r.message}`);throw o.code="PARSE_ERROR",o.response=e,o.originalError=r,o}},async autoParseResponse(e){const t=e.headers.get("content-type")||"";if("0"!==e.headers.get("content-length")){if(/application\/(.+\+)?json/i.test(t)){const t=await e.text();return t.trim()?JSON.parse(t):void 0}return/^text\//i.test(t)?e.text():e.blob()}},async safeGetResponseText(e,t=512){try{if(e.bodyUsed)return null;const r=e.clone();if(r.body&&"function"==typeof r.body.getReader){const e=r.body.getReader(),o=[];let n=0;try{for(;n<t;){const{done:r,value:s}=await e.read();if(r)break;const a=t-n;s.length>a?(o.push(s.slice(0,a)),n+=a):(o.push(s),n+=s.length)}}finally{await e.cancel()}if(0===o.length)return null;const s=new TextDecoder("utf-8",{fatal:!1});return o.map(e=>s.decode(e,{stream:!0})).join("").slice(0,200)}return(await r.text()).slice(0,200)}catch{return null}},handleSuccess(e,t,r){if(r.controller.signal.aborted){if(t.ignoreAbort)return;throw this.createTaggedCancellationError("Request was cancelled","cancelled")}if(t.onSuccess)try{t.onSuccess(e)}catch(e){}return e},handleError(e,t){if(!this.isCancellationError(e)||!t.ignoreAbort){if(t.onError)try{t.onError(e)}catch(e){}throw e}},createTaggedCancellationError(e,t){const r=new Error(e);return r.name="CancellationError",r.code=`CANCEL_${t.toUpperCase()}`,r.cancellationType=t,r},isCancellationError:e=>"AbortError"===e.name||"CancellationError"===e.name||!!e.cancellationType&&["timeout","cancelled","superseded"].includes(e.cancellationType),cleanupRequest(e,t){if(!e)return;const r=this._requestGroups.get(e);r&&r.token===t&&this._requestGroups.delete(e)}},t.VERSION=e;const r=new t;"undefined"!=typeof module&&module.exports?module.exports={WakaSync:t,wakaSync:r}:"function"==typeof define&&define.amd?define(function(){return{WakaSync:t,wakaSync:r}}):"undefined"!=typeof window&&(window.WakaSync=t,window.wakaSync=r)}();