!function(){"use strict";const e="1.1.0";function t(){this._requestGroups=new Map,this.interceptors={request:[],response:[]},this.config={timeout:3e4,retries:0,retryDelay:1e3,validateStatus:function(e){return e.ok},responseType:"auto",headers:{"User-Agent":`WakaSync/${e}`}}}t.prototype={request(e,t={}){let r=this.validateAndNormalizeConfig(e,t);for(const e of this.interceptors.request)try{r=e(r)||r}catch(e){const t=new Error("Request interceptor failed");return t.code="INTERCEPTOR_ERROR",t.originalError=e,Promise.reject(t)}this._requestGroups||(this._requestGroups=new Map);const o=this.setupRequestState(r),n=r.timeout>0?this.createTimeoutPromise(r.timeout,o.controller):null,s=this,a=this.executeWithRetry(r,o).then(function(e){return s.processResponse(e,r,o)}).then(function(e){let t=e;for(const e of s.interceptors.response)try{t=e(t,r)||t}catch(e){const t=new Error("Response interceptor failed");throw t.code="INTERCEPTOR_ERROR",t.originalError=e,t}return t}).then(function(e){return s.handleSuccess(e,r,o)}).catch(function(e){return s.handleError(e,r)});return(n?Promise.race([a,n]):a).finally(function(){s.cleanupRequest(r.groupKey,o.token)})},get(e,t={}){return this.request(e,{...t,method:"GET"})},post(e,t,r={}){return this.request(e,{...r,method:"POST",data:t})},put(e,t,r={}){return this.request(e,{...r,method:"PUT",data:t})},delete(e,t={}){return this.request(e,{...t,method:"DELETE"})},patch(e,t,r={}){return this.request(e,{...r,method:"PATCH",data:t})},head(e,t={}){return this.request(e,{...t,method:"HEAD"})},create(e={}){const r=new t;return r.config={...this.config,...e},r},cancelGroup(e){if(!e||!this._requestGroups)return;const t=this._requestGroups.get(e);t&&t.controller&&!t.controller.signal.aborted&&t.controller.abort()},cancelAll(){this._requestGroups&&(this._requestGroups.forEach(function(e){e.controller&&!e.controller.signal.aborted&&e.controller.abort()}),this._requestGroups.clear())},getActiveRequestCount(){if(!this._requestGroups)return 0;let e=0;return this._requestGroups.forEach(function(t){t.controller&&!t.controller.signal.aborted&&e++}),e},validateAndNormalizeConfig(e,t){if(!e||"string"!=typeof e){const e=new Error("URL must be a non-empty string");throw e.code="INVALID_URL",e}const r={...this.config,...t};this.validateCallbacks(r),this.validateAbortControls(r);const{method:o,body:n}=this.normalizeMethodAndBody(r),s=this.buildHeaders(r,n),a=this.buildFetchPassthrough(r);return{url:e,method:o,headers:s,body:n,groupKey:r.groupKey??(r.latestOnly?this.getGroupKeyFromUrl(e,r):null),fetchOptions:a,timeout:Math.max(0,parseInt(r.timeout)||3e4),ignoreAbort:!!r.ignoreAbort,validateStatus:r.validateStatus||(e=>e.ok),responseType:r.responseType||"auto",onSuccess:r.onSuccess,onError:r.onError,onProgress:r.onProgress,abortController:r.abortController,retries:Math.max(0,parseInt(r.retries)||0),retryDelay:Math.max(0,parseInt(r.retryDelay)||1e3),shouldRetry:r.shouldRetry,urlNormalizer:r.urlNormalizer,baseUrl:r.baseUrl}},validateCallbacks(e){[["onSuccess",e.onSuccess],["onError",e.onError],["onProgress",e.onProgress],["urlNormalizer",e.urlNormalizer],["shouldRetry",e.shouldRetry]].forEach(function(e){const t=e[0],r=e[1];if(r&&"function"!=typeof r){const e=new Error(`${t} must be a function`);throw e.code="INVALID_CALLBACK",e}})},validateAbortControls(e){if(e.abortController&&"function"!=typeof e.abortController.abort){const e=new Error("abortController must have an abort method");throw e.code="INVALID_ABORT_CONTROLLER",e}},normalizeMethodAndBody(e){const t=(e.method||"GET").toUpperCase();if(["GET","HEAD"].includes(t))return e.data,{method:t};let r;return void 0!==e.data&&(r="string"==typeof e.data||e.data instanceof FormData||e.data instanceof Blob||e.data instanceof ArrayBuffer?e.data:JSON.stringify(e.data)),{method:t,body:r}},buildHeaders(t,r){const o=new Headers;o.set("X-WakaSync-Request","true"),o.set("X-WakaSync-Version",e),void 0!==r&&(r instanceof FormData||(r instanceof Blob||r instanceof ArrayBuffer?o.set("Content-Type","application/octet-stream"):"string"==typeof r?o.set("Content-Type","text/plain; charset=utf-8"):o.set("Content-Type","application/json; charset=utf-8")));const n=t.headers||{};return Object.keys(n).some(e=>"accept"===e.toLowerCase())||o.set("Accept","application/json, text/plain, */*"),Object.entries(n).forEach(([e,t])=>{o.set(e,t)}),o},buildFetchPassthrough(e){const t={};return["credentials","mode","cache","redirect","referrer","referrerPolicy","integrity","keepalive","priority"].forEach(r=>{void 0!==e[r]&&(t[r]=e[r])}),t},getGroupKeyFromUrl(e,t){return t.urlNormalizer?t.urlNormalizer(e,t):this.normalizeUrlForGrouping(e,t.baseUrl)},normalizeUrlForGrouping(e,t){try{let r;r="undefined"!=typeof globalThis&&globalThis.location?t||globalThis.location.origin:t||"http://localhost";const o=new URL(e,r);o.hash="";const n=new URLSearchParams(o.search),s=new URLSearchParams;return[...n.keys()].sort().forEach(e=>{n.getAll(e).sort().forEach(t=>{s.append(e,t)})}),o.search=s.toString(),o.toString()}catch(e){const t=new Error("Invalid URL for request");throw t.code="INVALID_URL",t.originalError=e,t}},setupRequestState(e){const t=this.createCombinedController(e);let r=0;if(e.groupKey){const o=this._requestGroups.get(e.groupKey);o?(o.controller&&!o.controller.signal.aborted&&o.controller.abort(),r=o.token+1):r=1,this._requestGroups.set(e.groupKey,{token:r,controller:t})}return{token:r,controller:t,groupKey:e.groupKey}},createCombinedController:e=>e.abortController?e.abortController:new AbortController,createTimeoutPromise(e,t){const r=this;return new Promise(function(o,n){if(t.signal.aborted)return void n(r.createTaggedCancellationError("Request was cancelled before timeout","timeout"));const s=setTimeout(function(){t.signal.aborted||(t.abort(),n(r.createTaggedCancellationError(`Request timeout after ${e}ms`,"timeout")))},e);t.signal.addEventListener("abort",function(){clearTimeout(s)},{once:!0})})},async executeWithRetry(e,t){let r;const o=e.retries+1;for(let n=1;n<=o;n++)try{return await this.executeFetch(e,t)}catch(s){if(r=s,this.isCancellationError(s))throw s;if(!(e.shouldRetry?e.shouldRetry(s,n,o):this.defaultShouldRetry(s,n,o))||n===o)throw s;e.retryDelay>0&&await this.delayWithAbortCheck(e.retryDelay,t.controller)}throw r},defaultShouldRetry(e,t,r){return!(t>=r||this.isCancellationError(e)||!e.network&&!(e.response&&e.response.status>=500)&&(!e.response||429!==e.response.status))},delayWithAbortCheck(e,t){const r=this;return new Promise(function(o,n){if(t.signal.aborted)return void n(r.createTaggedCancellationError("Request was cancelled during retry delay","cancelled"));const s=setTimeout(function(){t.signal.aborted?n(r.createTaggedCancellationError("Request was cancelled during retry delay","cancelled")):o()},e);t.signal.addEventListener("abort",function(){clearTimeout(s),n(r.createTaggedCancellationError("Request was cancelled during retry delay","cancelled"))},{once:!0})})},delay:e=>new Promise(function(t){setTimeout(t,e)}),async executeFetch(e,t){if(t.controller.signal.aborted)throw this.createTaggedCancellationError("Request was cancelled before execution","cancelled");const r={method:e.method,headers:e.headers,body:e.body,signal:t.controller.signal,...e.fetchOptions};try{return await fetch(e.url,r)}catch(e){throw"TypeError"!==e.name||t.controller.signal.aborted||(e.network=!0),e}},async processResponse(e,t,r){if(r.controller.signal.aborted){if(t.ignoreAbort)return;throw this.createTaggedCancellationError("Request was cancelled during processing","cancelled")}if(!t.validateStatus(e)){const t=await this.safeGetResponseText(e),r=new Error(`HTTP ${e.status}: ${e.statusText}${t?` - ${t}`:""}`);throw r.code=`HTTP_${e.status}`,r.response=e,r}if("HEAD"!==t.method&&![204,205,304].includes(e.status))return this.parseResponse(e,t.responseType)},async parseResponse(e,t){try{switch(t){case"json":return await e.json();case"text":return await e.text();case"blob":return await e.blob();case"response":return e;default:return this.autoParseResponse(e)}}catch(r){const o=new Error(`Failed to parse response as ${t}: ${r.message}`);throw o.code="PARSE_ERROR",o.response=e,o.originalError=r,o}},async autoParseResponse(e){const t=e.headers.get("content-type")||"";if("0"!==e.headers.get("content-length")){if(/application\/(.+\+)?json/i.test(t)){const t=await e.text();return t.trim()?JSON.parse(t):void 0}return/^text\//i.test(t)?e.text():e.blob()}},async safeGetResponseText(e){try{if(e.bodyUsed)return null;const t=e.clone();return(await t.text()).slice(0,200)}catch{return null}},handleSuccess(e,t,r){if(r.controller.signal.aborted){if(t.ignoreAbort)return;throw this.createTaggedCancellationError("Request was cancelled","cancelled")}if(t.onSuccess)try{t.onSuccess(e)}catch(e){}return e},handleError(e,t){if(!this.isCancellationError(e)||!t.ignoreAbort){if(t.onError)try{t.onError(e)}catch(e){}throw e}},createTaggedCancellationError(e,t){const r=new Error(e);return r.name="CancellationError",r.code=`CANCEL_${t.toUpperCase()}`,r.cancellationType=t,r},isCancellationError:e=>"AbortError"===e.name||"CancellationError"===e.name||!!e.cancellationType&&["timeout","cancelled","superseded"].includes(e.cancellationType),cleanupRequest(e,t){if(!e)return;const r=this._requestGroups.get(e);r&&r.token===t&&this._requestGroups.delete(e)}},t.VERSION=e;const r=new t;"undefined"!=typeof window&&(window.WakaSync=t,window.wakaSync=r)}();